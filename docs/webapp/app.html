<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Echoelmusic - Bio-Reactive Audio-Visual Experience</title>
    <meta name="description" content="Transform your biometrics into music and visuals. Heart rate, HRV, breathing - all become art.">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- PWA -->
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" href="../app-icon.svg">
    <link rel="icon" type="image/svg+xml" href="../favicon.svg">

    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">

    <!-- Open Graph -->
    <meta property="og:title" content="Echoelmusic WebApp">
    <meta property="og:description" content="Bio-reactive audio-visual experience in your browser">
    <meta property="og:type" content="website">

    <style>
        :root {
            --primary: #00ffcc;
            --secondary: #ff00aa;
            --bg: #0a0a0f;
            --surface: #151520;
            --text: #ffffff;
            --text-dim: #888899;
            --success: #44ff44;
            --warning: #ffaa00;
            --error: #ff4444;
            --focus-ring: 0 0 0 2px var(--primary);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        /* Accessibility - Focus styles */
        *:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: rgba(21, 21, 32, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .logo {
            font-size: 1.25rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-decoration: none;
        }

        .header-controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .bio-status {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            padding: 0.4rem 0.75rem;
            background: var(--surface);
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .bio-status .heart {
            color: #ff6b6b;
            animation: heartbeat 1s ease-in-out infinite;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        .coherence-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .coherence-low { background: var(--error); }
        .coherence-mid { background: var(--warning); color: #000; }
        .coherence-high { background: var(--success); color: #000; }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 260px 1fr 300px;
            gap: 0.75rem;
            padding: 4rem 0.75rem 0.75rem;
            min-height: 100vh;
            min-height: 100dvh;
        }

        @media (max-width: 1100px) {
            .main-container {
                grid-template-columns: 1fr 280px;
            }
            .left-panel { display: none; }
        }

        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                padding: 3.5rem 0.5rem 0.5rem;
            }
            .left-panel, .right-panel { display: none; }
        }

        /* Panels */
        .panel {
            background: var(--surface);
            border-radius: 10px;
            padding: 0.75rem;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }

        .panel-title {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-dim);
        }

        /* Left Panel */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            overflow-y: auto;
            max-height: calc(100vh - 5rem);
        }

        /* Bio Source */
        .bio-source-selector {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }

        .bio-source-btn {
            padding: 0.4rem 0.75rem;
            border: 1px solid var(--primary);
            background: transparent;
            color: var(--primary);
            border-radius: 16px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.15s;
            touch-action: manipulation;
        }

        .bio-source-btn:hover, .bio-source-btn:focus {
            background: rgba(0, 255, 204, 0.15);
        }

        .bio-source-btn.active {
            background: var(--primary);
            color: var(--bg);
        }

        .bio-source-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Bio Data Grid */
        .bio-data-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .bio-metric {
            background: rgba(0,0,0,0.3);
            padding: 0.6rem;
            border-radius: 8px;
            text-align: center;
        }

        .bio-metric-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--primary);
            font-variant-numeric: tabular-nums;
        }

        .bio-metric-label {
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-top: 0.2rem;
        }

        /* Breathing Guide */
        .breathing-guide {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.75rem;
        }

        .breath-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--primary), transparent);
            opacity: 0.5;
            transition: all 0.4s ease-out;
            will-change: transform, opacity;
        }

        .breath-instruction {
            margin-top: 0.75rem;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        /* Center Panel */
        .center-panel {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            min-width: 0;
        }

        .visualizer-container {
            flex: 1;
            min-height: 300px;
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            background: #000;
        }

        #visualizer {
            width: 100%;
            height: 100%;
            display: block;
        }

        .viz-mode-selector {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
            padding: 0.5rem;
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
        }

        .viz-mode-btn {
            padding: 0.4rem 0.75rem;
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.75rem;
            transition: all 0.15s;
            touch-action: manipulation;
        }

        .viz-mode-btn:hover, .viz-mode-btn:focus {
            background: rgba(255,255,255,0.1);
            color: var(--text);
        }

        .viz-mode-btn.active {
            background: var(--primary);
            color: var(--bg);
        }

        /* Keyboard */
        .keyboard-container {
            padding: 0.75rem;
            background: linear-gradient(180deg, #2a2a3a, #1a1a2a);
            border-radius: 10px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .keyboard {
            display: flex;
            justify-content: center;
            gap: 2px;
            min-width: max-content;
            padding: 0.5rem;
        }

        .key {
            width: 36px;
            height: 110px;
            background: linear-gradient(180deg, #fff, #e8e8e8);
            border: 1px solid #999;
            border-radius: 0 0 4px 4px;
            cursor: pointer;
            position: relative;
            transition: background 0.05s, transform 0.05s;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        .key:active, .key.active {
            background: linear-gradient(180deg, #ddd, #ccc);
            transform: translateY(2px);
        }

        .key.black {
            width: 24px;
            height: 70px;
            background: linear-gradient(180deg, #333, #111);
            border-color: #000;
            margin-left: -12px;
            margin-right: -12px;
            z-index: 1;
        }

        .key.black:active, .key.black.active {
            background: linear-gradient(180deg, #222, #000);
        }

        .key-label {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.6rem;
            color: #666;
            pointer-events: none;
        }

        .key.black .key-label { color: #888; }

        /* Right Panel */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            overflow-y: auto;
            max-height: calc(100vh - 5rem);
        }

        /* Sequencer */
        .sequencer-grid {
            display: grid;
            grid-template-columns: 50px repeat(16, 1fr);
            gap: 2px;
            font-size: 0.65rem;
        }

        .seq-channel-name {
            display: flex;
            align-items: center;
            padding: 0.2rem;
            color: var(--text-dim);
            font-size: 0.6rem;
        }

        .seq-step {
            aspect-ratio: 1;
            background: rgba(0,0,0,0.4);
            border-radius: 3px;
            cursor: pointer;
            transition: background 0.1s;
            touch-action: manipulation;
        }

        .seq-step:hover { background: rgba(255,255,255,0.15); }
        .seq-step.active { background: var(--primary); }
        .seq-step.current { box-shadow: inset 0 0 0 2px var(--secondary); }

        .seq-controls {
            display: flex;
            gap: 0.4rem;
            margin-top: 0.5rem;
        }

        .seq-btn {
            flex: 1;
            padding: 0.5rem;
            background: var(--primary);
            color: var(--bg);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            touch-action: manipulation;
        }

        .seq-btn.stop { background: var(--error); color: #fff; }

        .bpm-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }

        .bpm-control input[type="range"] {
            flex: 1;
            accent-color: var(--primary);
            height: 4px;
        }

        .bpm-value {
            width: 45px;
            text-align: center;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
        }

        /* Wellness Tips */
        .wellness-tips {
            padding: 0.75rem;
            background: linear-gradient(135deg, rgba(0,255,204,0.08), rgba(255,0,170,0.08));
            border-radius: 8px;
        }

        .tip-content {
            font-size: 0.85rem;
            line-height: 1.5;
            margin-bottom: 0.4rem;
        }

        .tip-source {
            font-size: 0.65rem;
            color: var(--text-dim);
        }

        .tip-disclaimer {
            font-size: 0.6rem;
            color: var(--text-dim);
            margin-top: 0.4rem;
            font-style: italic;
            opacity: 0.7;
        }

        /* Volume */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .volume-control input {
            width: 60px;
            accent-color: var(--primary);
        }

        /* Buttons */
        .btn-icon {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1rem;
        }

        /* Start Screen */
        .start-screen {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            transition: opacity 0.4s, visibility 0.4s;
        }

        .start-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .start-logo {
            font-size: clamp(2rem, 8vw, 3.5rem);
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.75rem;
        }

        .start-tagline {
            color: var(--text-dim);
            margin-bottom: 2rem;
            font-size: clamp(1rem, 3vw, 1.25rem);
        }

        .start-btn {
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--bg);
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            touch-action: manipulation;
        }

        .start-btn:hover, .start-btn:focus {
            transform: scale(1.05);
            box-shadow: 0 0 40px rgba(0,255,204,0.4);
        }

        .start-disclaimer {
            position: absolute;
            bottom: 1.5rem;
            left: 1rem;
            right: 1rem;
            font-size: 0.7rem;
            color: var(--text-dim);
            text-align: center;
            line-height: 1.5;
            opacity: 0.8;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300;
            transition: opacity 0.3s;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--surface);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error Toast */
        .toast {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--surface);
            border: 1px solid var(--error);
            color: var(--text);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.85rem;
            z-index: 400;
            transition: transform 0.3s;
            max-width: 90vw;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* Offline Banner */
        .offline-banner {
            position: fixed;
            top: 3.5rem;
            left: 0;
            right: 0;
            background: var(--warning);
            color: #000;
            text-align: center;
            padding: 0.4rem;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 99;
            display: none;
        }

        .offline-banner.show { display: block; }

        /* Mobile bottom bar */
        @media (max-width: 768px) {
            .mobile-bar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--surface);
                border-top: 1px solid rgba(255,255,255,0.1);
                padding: 0.5rem;
                display: flex;
                justify-content: space-around;
                z-index: 100;
            }

            .mobile-bar button {
                background: none;
                border: none;
                color: var(--text-dim);
                font-size: 0.7rem;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0.2rem;
                cursor: pointer;
                padding: 0.25rem 0.5rem;
            }

            .mobile-bar button.active { color: var(--primary); }
            .mobile-bar button svg { width: 20px; height: 20px; }

            .main-container {
                padding-bottom: 4rem;
            }

            .keyboard-container {
                padding: 0.5rem;
            }

            .key {
                width: 28px;
                height: 90px;
            }

            .key.black {
                width: 18px;
                height: 55px;
                margin-left: -9px;
                margin-right: -9px;
            }
        }

        /* Print */
        @media print {
            .header, .start-screen, .mobile-bar { display: none; }
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            :root {
                --primary: #00ffff;
                --secondary: #ff00ff;
                --bg: #000000;
                --surface: #1a1a1a;
            }
        }

        /* Smooth experience polish */
        .panel {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .panel:hover {
            box-shadow: 0 4px 20px rgba(0, 255, 204, 0.1);
        }

        .bio-metric {
            transition: transform 0.15s ease, background 0.15s ease;
        }

        .bio-metric:hover {
            transform: scale(1.02);
            background: rgba(0, 255, 204, 0.1);
        }

        .bio-metric-value {
            transition: color 0.3s ease;
        }

        /* Keyboard glow effect on play */
        .key.active {
            box-shadow: 0 0 20px var(--primary);
        }

        .key.black.active {
            box-shadow: 0 0 15px var(--secondary);
        }

        /* Smooth sequencer step transitions */
        .seq-step {
            transition: all 0.1s ease;
        }

        .seq-step:active {
            transform: scale(0.95);
        }

        /* Bio source active glow */
        .bio-source-btn.active {
            box-shadow: 0 0 10px var(--primary);
        }

        /* Coherence badge pulse when high */
        .coherence-high {
            animation: coherencePulse 2s ease-in-out infinite;
        }

        @keyframes coherencePulse {
            0%, 100% { box-shadow: 0 0 5px var(--success); }
            50% { box-shadow: 0 0 15px var(--success); }
        }

        /* Volume slider smooth thumb */
        input[type="range"]::-webkit-slider-thumb {
            transition: transform 0.1s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        /* Breathing circle smooth pulse */
        .breath-circle {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease;
        }

        /* Body tracking data grid animation */
        #bodyDataGrid {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Scale selector smooth styling */
        #scaleSelect, #rootNoteSelect {
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        #scaleSelect:focus, #rootNoteSelect:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 8px rgba(255, 0, 170, 0.3);
        }
    </style>
</head>
<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner" role="status" aria-label="Loading"></div>
</div>

<!-- Offline Banner -->
<div class="offline-banner" id="offlineBanner" role="alert">
    Offline Mode - Some features may be limited
</div>

<!-- Error Toast -->
<div class="toast" id="toast" role="alert" aria-live="polite"></div>

<!-- Start Screen -->
<div class="start-screen" id="startScreen" role="dialog" aria-modal="true" aria-labelledby="startTitle">
    <div class="start-logo" id="startTitle">Echoelmusic</div>
    <div class="start-tagline">Bio-Reactive Audio-Visual Experience</div>
    <button class="start-btn" id="startBtn" autofocus>Start Experience</button>
    <div class="start-disclaimer">
        <strong>Disclaimer:</strong> For creative and educational purposes only. Not a medical device.
        Biometric features are for relaxation and creative expression. Consult healthcare professionals for health concerns.
    </div>
</div>

<!-- Header -->
<header class="header" role="banner">
    <a href="../index.html" class="logo" aria-label="Echoelmusic Home">Echoelmusic</a>
    <div class="header-controls">
        <div class="bio-status" aria-label="Bio Status">
            <span class="heart" aria-hidden="true">â™¥</span>
            <span id="headerHR" aria-label="Heart Rate">--</span>
            <span aria-hidden="true">BPM</span>
            <span class="coherence-badge coherence-mid" id="headerCoherence" aria-label="Coherence">--</span>
        </div>
        <div class="volume-control">
            <span aria-hidden="true">ðŸ”Š</span>
            <input type="range" id="volumeSlider" min="0" max="100" value="70"
                   aria-label="Volume" title="Volume">
        </div>
    </div>
</header>

<!-- Main Content -->
<main class="main-container" role="main">

    <!-- Left Panel -->
    <aside class="left-panel" aria-label="Controls">

        <!-- Bio Source -->
        <section class="panel" aria-labelledby="bioSourceTitle">
            <div class="panel-header">
                <span class="panel-title" id="bioSourceTitle">Bio Source</span>
            </div>
            <div class="bio-source-selector" role="group" aria-label="Select bio data source">
                <button class="bio-source-btn active" id="btnSimulator" data-source="simulator" aria-pressed="true">Simulator</button>
                <button class="bio-source-btn" id="btnBluetooth" data-source="bluetooth" aria-pressed="false">âŒš Bluetooth</button>
                <button class="bio-source-btn" id="btnCamera" data-source="camera" aria-pressed="false">ðŸ“· Camera</button>
            </div>
            <div id="bioSourceStatus" style="margin-top: 0.4rem; font-size: 0.75rem; color: var(--text-dim);" aria-live="polite">
                Simulator active
            </div>
        </section>

        <!-- Bio Data -->
        <section class="panel" aria-labelledby="bioDataTitle">
            <div class="panel-header">
                <span class="panel-title" id="bioDataTitle">Biometrics</span>
            </div>
            <div class="bio-data-grid">
                <div class="bio-metric">
                    <div class="bio-metric-value" id="bioHR" aria-label="Heart Rate">72</div>
                    <div class="bio-metric-label">Heart Rate</div>
                </div>
                <div class="bio-metric">
                    <div class="bio-metric-value" id="bioHRV" aria-label="HRV">45</div>
                    <div class="bio-metric-label">HRV (ms)</div>
                </div>
                <div class="bio-metric">
                    <div class="bio-metric-value" id="bioCoherence" aria-label="Coherence">50%</div>
                    <div class="bio-metric-label">Coherence</div>
                </div>
                <div class="bio-metric">
                    <div class="bio-metric-value" id="bioBreath" aria-label="Breathing Rate">6</div>
                    <div class="bio-metric-label">Breath/min</div>
                </div>
            </div>
        </section>

        <!-- Body Tracking -->
        <section class="panel" aria-labelledby="bodyTrackingTitle">
            <div class="panel-header">
                <span class="panel-title" id="bodyTrackingTitle">Body Tracking</span>
                <button class="btn-icon" id="bodyTrackingToggle" aria-label="Toggle body tracking">â–¶</button>
            </div>
            <div style="font-size: 0.75rem; color: var(--text-dim); margin-bottom: 0.5rem;">
                Smile, gestures, movement, breathing
            </div>
            <div class="bio-data-grid" id="bodyDataGrid" style="display: none;">
                <div class="bio-metric">
                    <div class="bio-metric-value" id="bodySmile">0%</div>
                    <div class="bio-metric-label">Smile</div>
                </div>
                <div class="bio-metric">
                    <div class="bio-metric-value" id="bodyGesture">--</div>
                    <div class="bio-metric-label">Gesture</div>
                </div>
                <div class="bio-metric">
                    <div class="bio-metric-value" id="bodyEnergy">50%</div>
                    <div class="bio-metric-label">Energy</div>
                </div>
                <div class="bio-metric">
                    <div class="bio-metric-value" id="bodyArousal">--</div>
                    <div class="bio-metric-label">State</div>
                </div>
            </div>
            <div id="bodyTrackingStatus" style="font-size: 0.7rem; color: var(--text-dim); margin-top: 0.3rem;">
                Tap â–¶ to start camera
            </div>
        </section>

        <!-- Breathing Guide -->
        <section class="panel" aria-labelledby="breathingTitle">
            <div class="panel-header">
                <span class="panel-title" id="breathingTitle">Breathing Guide</span>
                <select id="breathPattern" aria-label="Breathing pattern"
                        style="background: var(--bg); color: var(--text); border: 1px solid var(--primary); padding: 0.2rem; border-radius: 4px; font-size: 0.75rem;">
                    <option value="off">Off</option>
                    <option value="coherence">Coherence (6/min)</option>
                    <option value="box">Box (4-4-4-4)</option>
                    <option value="478">4-7-8</option>
                    <option value="calming">Calming</option>
                </select>
            </div>
            <div class="breathing-guide">
                <div class="breath-circle" id="breathCircle" role="img" aria-label="Breathing visualization"></div>
                <div class="breath-instruction" id="breathInstruction" aria-live="polite">Select a pattern</div>
            </div>
        </section>

    </aside>

    <!-- Center Panel -->
    <div class="center-panel">

        <!-- Visualizer -->
        <section class="panel visualizer-container" aria-labelledby="vizTitle">
            <h2 class="visually-hidden" id="vizTitle">Audio Visualization</h2>
            <canvas id="visualizer" aria-label="Audio visualization canvas"></canvas>
        </section>

        <!-- Viz Mode -->
        <nav class="viz-mode-selector" aria-label="Visualization modes">
            <button class="viz-mode-btn active" data-mode="waveform" aria-pressed="true">Waveform</button>
            <button class="viz-mode-btn" data-mode="spectrum" aria-pressed="false">Spectrum</button>
            <button class="viz-mode-btn" data-mode="mandala" aria-pressed="false">Mandala</button>
            <button class="viz-mode-btn" data-mode="particles" aria-pressed="false">Particles</button>
            <button class="viz-mode-btn" data-mode="quantum" aria-pressed="false">Quantum</button>
            <button class="viz-mode-btn" data-mode="coherence" aria-pressed="false">Coherence</button>
            <button class="viz-mode-btn" data-mode="sacredGeometry" aria-pressed="false">Sacred</button>
            <button class="viz-mode-btn" data-mode="cosmic" aria-pressed="false">Cosmic</button>
        </nav>

        <!-- Keyboard -->
        <section class="keyboard-container" aria-labelledby="keyboardTitle">
            <h2 class="visually-hidden" id="keyboardTitle">Piano Keyboard</h2>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap; align-items: center; justify-content: center;">
                <label for="scaleSelect" style="font-size: 0.75rem; color: var(--text-dim);">Scale:</label>
                <select id="scaleSelect" aria-label="Musical scale"
                        style="background: var(--bg); color: var(--text); border: 1px solid var(--primary); padding: 0.3rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                    <option value="major">Major</option>
                    <option value="minor">Minor</option>
                    <option value="pentatonic">Pentatonic</option>
                    <option value="blues">Blues</option>
                    <option value="dorian">Dorian</option>
                    <option value="mixolydian">Mixolydian</option>
                    <option value="phrygian">Phrygian</option>
                    <option value="harmonic_minor">Harmonic Minor</option>
                    <option value="japanese">Japanese</option>
                    <option value="arabic">Arabic</option>
                </select>
                <label for="rootNoteSelect" style="font-size: 0.75rem; color: var(--text-dim);">Root:</label>
                <select id="rootNoteSelect" aria-label="Root note"
                        style="background: var(--bg); color: var(--text); border: 1px solid var(--primary); padding: 0.3rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                    <option value="60">C</option>
                    <option value="61">C#</option>
                    <option value="62">D</option>
                    <option value="63">D#</option>
                    <option value="64">E</option>
                    <option value="65">F</option>
                    <option value="66">F#</option>
                    <option value="67">G</option>
                    <option value="68">G#</option>
                    <option value="69">A</option>
                    <option value="70">A#</option>
                    <option value="71">B</option>
                </select>
            </div>
            <div class="keyboard" id="keyboard" role="group" aria-label="Piano keyboard - use A-K keys to play">
                <!-- Generated by JS -->
            </div>
        </section>

    </div>

    <!-- Right Panel -->
    <aside class="right-panel" aria-label="Sequencer and Info">

        <!-- Sequencer -->
        <section class="panel" aria-labelledby="seqTitle">
            <div class="panel-header">
                <span class="panel-title" id="seqTitle">Step Sequencer</span>
            </div>
            <div class="sequencer-grid" id="sequencerGrid" role="grid" aria-label="Drum pattern grid">
                <!-- Generated by JS -->
            </div>
            <div class="seq-controls">
                <button class="seq-btn" id="seqPlay" aria-label="Play sequencer">â–¶ Play</button>
                <button class="seq-btn stop" id="seqStop" aria-label="Stop sequencer">â–  Stop</button>
            </div>
            <div class="bpm-control">
                <label for="bpmSlider">BPM:</label>
                <input type="range" id="bpmSlider" min="60" max="180" value="120" aria-label="Tempo">
                <span class="bpm-value" id="bpmValue" aria-live="polite">120</span>
            </div>
            <select id="seqPreset" aria-label="Load drum pattern preset"
                    style="width: 100%; padding: 0.4rem; margin-top: 0.4rem; background: var(--bg); color: var(--text); border: 1px solid var(--primary); border-radius: 4px; font-size: 0.75rem;">
                <option value="">Load Preset...</option>
                <option value="fourOnFloor">Four on Floor</option>
                <option value="breakbeat">Breakbeat</option>
                <option value="trap">Trap</option>
                <option value="minimal">Minimal</option>
                <option value="ambient">Ambient</option>
            </select>
        </section>

        <!-- Wellness -->
        <section class="panel" aria-labelledby="wellnessTitle">
            <div class="panel-header">
                <span class="panel-title" id="wellnessTitle">Wellness Insight</span>
                <button class="btn-icon" id="newTipBtn" aria-label="Get new tip">â†»</button>
            </div>
            <div class="wellness-tips" id="wellnessTip">
                <div class="tip-content">Loading tip...</div>
                <div class="tip-source"></div>
                <div class="tip-disclaimer">For educational purposes only. Not medical advice.</div>
            </div>
        </section>

        <!-- Session -->
        <section class="panel" aria-labelledby="sessionTitle">
            <div class="panel-header">
                <span class="panel-title" id="sessionTitle">Session</span>
            </div>
            <div style="font-size: 0.8rem; color: var(--text-dim);">
                <div>Duration: <span id="sessionDuration" aria-live="polite">0:00</span></div>
                <div>High Coherence: <span id="sessionCoherence">0 min</span></div>
                <div>Stress: <span id="sessionStress">--</span></div>
            </div>
        </section>

    </aside>

</main>

<!-- Mobile Bottom Bar -->
<nav class="mobile-bar" aria-label="Mobile navigation" style="display: none;">
    <button id="mobileViz" class="active" aria-label="Visualizer">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>
        Viz
    </button>
    <button id="mobileSeq" aria-label="Sequencer">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
        Seq
    </button>
    <button id="mobileBio" aria-label="Bio Data">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>
        Bio
    </button>
</nav>

<!-- Visually Hidden (for screen readers) -->
<style>
    .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }
</style>

<!-- Combined Engine Scripts -->
<script src="js/core/AudioEngine.js"></script>
<script src="js/core/BioEngine.js"></script>
<script src="js/core/VisualEngine.js"></script>
<script src="js/core/MIDIEngine.js"></script>
<script src="js/core/WellnessEngine.js"></script>
<script src="js/core/Sequencer.js"></script>
<script src="js/core/Echoela.js"></script>
<script src="js/core/SyncEngine.js"></script>
<script src="js/core/PresetsEngine.js"></script>
<script src="js/core/RecordingEngine.js"></script>
<script src="js/core/BodyTrackingEngine.js"></script>

<script>
// ==================== ERROR HANDLING ====================
window.onerror = function(msg, url, line, col, error) {
    console.error('[App Error]', msg, error);
    showToast('An error occurred. Please refresh.');
    return false;
};

window.onunhandledrejection = function(event) {
    console.error('[Promise Error]', event.reason);
};

function showToast(message, duration = 4000) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), duration);
}

// ==================== OFFLINE DETECTION ====================
function updateOnlineStatus() {
    const banner = document.getElementById('offlineBanner');
    banner.classList.toggle('show', !navigator.onLine);
}
window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);
updateOnlineStatus();

// ==================== APP STATE ====================
let audioEngine, bioEngine, visualEngine, midiEngine, wellnessEngine, sequencer;
let syncEngine, presetsEngine, recordingEngine, bodyTrackingEngine;
let echoela;
let isStarted = false;
let sessionStartTime = null;

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', () => {
    // Hide loading after DOM ready
    setTimeout(() => {
        document.getElementById('loadingOverlay').classList.add('hidden');
    }, 300);

    // Mobile bar detection
    if (window.innerWidth <= 768) {
        document.querySelector('.mobile-bar').style.display = 'flex';
    }
    window.addEventListener('resize', () => {
        document.querySelector('.mobile-bar').style.display = window.innerWidth <= 768 ? 'flex' : 'none';
    });
});

// Start button
document.getElementById('startBtn').addEventListener('click', async () => {
    try {
        document.getElementById('loadingOverlay').classList.remove('hidden');
        await initializeApp();
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('loadingOverlay').classList.add('hidden');
        isStarted = true;
        sessionStartTime = Date.now();
        updateSessionStats();
    } catch (error) {
        console.error('[Init Error]', error);
        document.getElementById('loadingOverlay').classList.add('hidden');
        showToast('Failed to initialize. Please try again.');
    }
});

async function initializeApp() {
    // Audio Engine
    audioEngine = new AudioEngine();
    await audioEngine.init();

    // Bio Engine
    bioEngine = new BioEngine();
    bioEngine.startSimulator();
    // Notify Echoela that simulator is active
    if (echoela) echoela.setBioSourceActive('simulator');

    // Visual Engine
    visualEngine = new VisualEngine('visualizer');
    visualEngine.start();

    // MIDI Engine (optional - may fail in some browsers)
    midiEngine = new MIDIEngine();
    try {
        await midiEngine.init();
    } catch (e) {
        console.log('[MIDI] Not available:', e.message);
    }

    // Wellness Engine
    wellnessEngine = new WellnessEngine(bioEngine);
    wellnessEngine.startSession();

    // Sequencer
    sequencer = new Sequencer(audioEngine);

    // Sync Engine
    if (typeof SyncEngine !== 'undefined') {
        syncEngine = new SyncEngine();
        await syncEngine.init();
    }

    // Presets Engine
    if (typeof PresetsEngine !== 'undefined') {
        presetsEngine = new PresetsEngine();
        await presetsEngine.init();
    }

    // Recording Engine
    if (typeof RecordingEngine !== 'undefined') {
        recordingEngine = new RecordingEngine();
        await recordingEngine.init(audioEngine?.audioContext);
    }

    // Body Tracking Engine
    if (typeof BodyTrackingEngine !== 'undefined') {
        bodyTrackingEngine = new BodyTrackingEngine();
        await bodyTrackingEngine.init();
        setupBodyTrackingListeners();
    }

    // Setup UI
    setupBioListeners();
    setupMIDIListeners();
    setupUIListeners();
    setupKeyboard();
    setupSequencerUI();
    loadWellnessTip();

    console.log('[App] Ready - All 11 engines initialized (Audio, Bio, Visual, MIDI, Wellness, Sequencer, Echoela, Sync, Presets, Recording, BodyTracking)');
}

// ==================== BIO LISTENERS ====================
function setupBioListeners() {
    bioEngine.addListener((data) => {
        // Update displays
        document.getElementById('bioHR').textContent = data.heartRate;
        document.getElementById('bioHRV').textContent = data.hrv;
        document.getElementById('bioCoherence').textContent = Math.round(data.coherence * 100) + '%';
        document.getElementById('bioBreath').textContent = data.breathingRate.toFixed(1);

        // Header
        document.getElementById('headerHR').textContent = data.heartRate;
        const badge = document.getElementById('headerCoherence');
        badge.textContent = Math.round(data.coherence * 100) + '%';
        badge.className = 'coherence-badge ' +
            (data.coherence > 0.6 ? 'coherence-high' : data.coherence > 0.3 ? 'coherence-mid' : 'coherence-low');

        // Update engines
        if (audioEngine) audioEngine.onBioData(data);
        if (visualEngine) visualEngine.onBioData(data);
        if (sequencer) sequencer.onBioData(data);
        if (recordingEngine) recordingEngine.setCurrentBioData(data);
        if (syncEngine) syncEngine.sendStateUpdate('bio', data);

        // Breathing circle
        const circle = document.getElementById('breathCircle');
        circle.style.transform = `scale(${0.7 + data.breathPhase * 0.6})`;
        circle.style.opacity = 0.3 + data.breathPhase * 0.5;

        // Heartbeat animation
        const heart = document.querySelector('.heart');
        if (heart) heart.style.animationDuration = (60 / data.heartRate) + 's';
    });
}

// ==================== MIDI LISTENERS ====================
function setupMIDIListeners() {
    if (!midiEngine) return;

    midiEngine.addListener((event) => {
        if (event.type === 'noteOn') {
            audioEngine.noteOn(event.note, event.velocity);
            highlightKey(event.note, true);
        } else if (event.type === 'noteOff') {
            audioEngine.noteOff(event.note);
            highlightKey(event.note, false);
        } else if (event.type === 'cc' && event.controller === 1) {
            // Mod wheel â†’ filter
            audioEngine.filter?.frequency.setTargetAtTime(
                500 + event.value * 7500,
                audioEngine.audioContext.currentTime, 0.1
            );
        }
    });
}

// ==================== UI LISTENERS ====================
function setupUIListeners() {
    // Volume
    document.getElementById('volumeSlider').addEventListener('input', (e) => {
        audioEngine?.setVolume(e.target.value / 100);
    });

    // Bio source
    const bioSources = [
        { id: 'btnSimulator', mode: 'simulator', start: () => bioEngine.startSimulator() },
        { id: 'btnBluetooth', mode: 'bluetooth', start: () => bioEngine.startBluetooth() },
        { id: 'btnCamera', mode: 'camera', start: () => bioEngine.startCamera() }
    ];

    bioSources.forEach(({ id, mode, start }) => {
        document.getElementById(id).addEventListener('click', async () => {
            try {
                bioEngine.stop();
                const result = await start();
                updateBioSourceUI(mode, typeof result === 'string' ? result : '');
            } catch (e) {
                showToast(mode + ' not available: ' + e.message);
                // Fall back to simulator
                bioEngine.startSimulator();
                updateBioSourceUI('simulator');
            }
        });
    });

    // Breathing pattern
    document.getElementById('breathPattern').addEventListener('change', (e) => {
        const pattern = e.target.value;
        if (pattern === 'off') {
            bioEngine.stopBreathingGuide();
            document.getElementById('breathInstruction').textContent = 'Select a pattern';
        } else {
            const info = bioEngine.startBreathingGuide(pattern);
            document.getElementById('breathInstruction').textContent =
                `${info.bpm.toFixed(1)} breaths/min`;
        }
    });

    // Viz modes
    document.querySelectorAll('.viz-mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.viz-mode-btn').forEach(b => {
                b.classList.remove('active');
                b.setAttribute('aria-pressed', 'false');
            });
            btn.classList.add('active');
            btn.setAttribute('aria-pressed', 'true');
            visualEngine?.setMode(btn.dataset.mode);
        });
    });

    // Sequencer
    document.getElementById('seqPlay').addEventListener('click', () => {
        audioEngine?.resume();
        sequencer?.start();
    });

    document.getElementById('seqStop').addEventListener('click', () => {
        sequencer?.stop();
    });

    document.getElementById('bpmSlider').addEventListener('input', (e) => {
        sequencer?.setBpm(parseInt(e.target.value));
        document.getElementById('bpmValue').textContent = e.target.value;
    });

    document.getElementById('seqPreset').addEventListener('change', (e) => {
        if (e.target.value) {
            sequencer?.loadPreset(e.target.value);
            updateSequencerUI();
            e.target.value = '';
        }
    });

    // Wellness tip
    document.getElementById('newTipBtn').addEventListener('click', loadWellnessTip);
}

function updateBioSourceUI(source, extra = '') {
    document.querySelectorAll('.bio-source-btn').forEach(btn => {
        const isActive = btn.id === 'btn' + source.charAt(0).toUpperCase() + source.slice(1);
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
    });
    document.getElementById('bioSourceStatus').textContent =
        source.charAt(0).toUpperCase() + source.slice(1) + ' active' + (extra ? ': ' + extra : '');
}

// ==================== KEYBOARD ====================
function setupKeyboard() {
    const keyboard = document.getElementById('keyboard');
    const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B', 'C'];
    const startNote = 60;

    notes.forEach((note, i) => {
        const isBlack = note.includes('#');
        const key = document.createElement('button');
        key.className = 'key' + (isBlack ? ' black' : '');
        key.dataset.note = startNote + i;
        key.setAttribute('aria-label', note + '4');

        if (!isBlack) {
            const label = document.createElement('span');
            label.className = 'key-label';
            label.textContent = note;
            label.setAttribute('aria-hidden', 'true');
            key.appendChild(label);
        }

        // Pointer events (mouse + touch)
        key.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            audioEngine?.resume();
            audioEngine?.noteOn(parseInt(key.dataset.note));
            key.classList.add('active');
        });

        key.addEventListener('pointerup', () => {
            audioEngine?.noteOff(parseInt(key.dataset.note));
            key.classList.remove('active');
        });

        key.addEventListener('pointerleave', () => {
            if (key.classList.contains('active')) {
                audioEngine?.noteOff(parseInt(key.dataset.note));
                key.classList.remove('active');
            }
        });

        keyboard.appendChild(key);
    });
}

function highlightKey(noteNum, active) {
    const key = document.querySelector(`.key[data-note="${noteNum}"]`);
    if (key) key.classList.toggle('active', active);
}

// Computer keyboard mapping
const keyMap = { a:60, w:61, s:62, e:63, d:64, f:65, t:66, g:67, y:68, h:69, u:70, j:71, k:72 };

document.addEventListener('keydown', (e) => {
    if (!isStarted || e.repeat || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
    const note = keyMap[e.key.toLowerCase()];
    if (note) {
        audioEngine?.resume();
        audioEngine?.noteOn(note);
        highlightKey(note, true);
    }
});

document.addEventListener('keyup', (e) => {
    const note = keyMap[e.key.toLowerCase()];
    if (note) {
        audioEngine?.noteOff(note);
        highlightKey(note, false);
    }
});

// ==================== SEQUENCER UI ====================
function setupSequencerUI() {
    updateSequencerUI();
    sequencer?.addListener((event) => {
        if (event.type === 'step') {
            document.querySelectorAll('.seq-step').forEach(s => s.classList.remove('current'));
            document.querySelectorAll(`.seq-step[data-step="${event.step}"]`).forEach(s => {
                s.classList.add('current');
            });
        }
    });
}

function updateSequencerUI() {
    if (!sequencer) return;
    const grid = document.getElementById('sequencerGrid');
    grid.innerHTML = '';

    sequencer.channels.forEach((channel, chIndex) => {
        const name = document.createElement('div');
        name.className = 'seq-channel-name';
        name.textContent = channel.name;
        grid.appendChild(name);

        for (let step = 0; step < 16; step++) {
            const stepEl = document.createElement('button');
            stepEl.className = 'seq-step' + (channel.pattern[step] ? ' active' : '');
            stepEl.dataset.channel = chIndex;
            stepEl.dataset.step = step;
            stepEl.setAttribute('aria-label', `${channel.name} step ${step + 1}`);
            stepEl.setAttribute('aria-pressed', channel.pattern[step] ? 'true' : 'false');

            stepEl.addEventListener('click', () => {
                sequencer.toggleStep(chIndex, step);
                stepEl.classList.toggle('active');
                stepEl.setAttribute('aria-pressed', stepEl.classList.contains('active') ? 'true' : 'false');
            });

            grid.appendChild(stepEl);
        }
    });
}

// ==================== WELLNESS ====================
function loadWellnessTip() {
    if (!wellnessEngine) return;
    const tip = wellnessEngine.getTip();
    const tipEl = document.getElementById('wellnessTip');
    tipEl.querySelector('.tip-content').textContent = tip.tip;
    tipEl.querySelector('.tip-source').textContent = 'â€” ' + tip.source;
}

// ==================== SESSION STATS ====================
function updateSessionStats() {
    if (!isStarted) return;

    const duration = Math.floor((Date.now() - sessionStartTime) / 1000);
    const minutes = Math.floor(duration / 60);
    const seconds = duration % 60;
    document.getElementById('sessionDuration').textContent =
        `${minutes}:${seconds.toString().padStart(2, '0')}`;

    if (wellnessEngine) {
        const data = wellnessEngine.getExtendedData();
        document.getElementById('sessionCoherence').textContent =
            wellnessEngine.highCoherenceMinutes.toFixed(1) + ' min';
        document.getElementById('sessionStress').textContent =
            data.stress < 0.3 ? 'Low âœ“' : data.stress < 0.6 ? 'Medium' : 'High';
    }

    setTimeout(updateSessionStats, 1000);
}

// ==================== BODY TRACKING ====================
function setupBodyTrackingListeners() {
    const toggleBtn = document.getElementById('bodyTrackingToggle');
    const statusEl = document.getElementById('bodyTrackingStatus');
    const dataGrid = document.getElementById('bodyDataGrid');
    let isTracking = false;

    toggleBtn?.addEventListener('click', async () => {
        if (!bodyTrackingEngine) return;

        if (isTracking) {
            bodyTrackingEngine.stop();
            isTracking = false;
            toggleBtn.textContent = 'â–¶';
            statusEl.textContent = 'Stopped';
            dataGrid.style.display = 'none';
            if (echoela) echoela.setBioSourceActive(null);
        } else {
            try {
                statusEl.textContent = 'Starting camera...';
                await bodyTrackingEngine.startFaceTracking();
                bodyTrackingEngine.startMotionTracking();
                isTracking = true;
                toggleBtn.textContent = 'â– ';
                statusEl.textContent = 'Tracking active';
                dataGrid.style.display = 'grid';
                if (echoela) echoela.setBioSourceActive('camera');
            } catch (e) {
                statusEl.textContent = 'Camera error: ' + e.message;
                console.error('[BodyTracking]', e);
            }
        }
    });

    // Listen to body data updates
    if (bodyTrackingEngine) {
        bodyTrackingEngine.addListener((data) => {
            // Update UI
            document.getElementById('bodySmile').textContent = Math.round(data.face.smile * 100) + '%';
            document.getElementById('bodyEnergy').textContent = Math.round(data.movement.energy * 100) + '%';
            document.getElementById('bodyGesture').textContent = data.movement.gestureType || '--';

            // State based on arousal/relaxation
            const state = data.arousal > 0.6 ? 'Active' :
                          data.relaxation > 0.6 ? 'Relaxed' :
                          'Neutral';
            document.getElementById('bodyArousal').textContent = state;

            // Apply to audio - smile affects brightness
            if (audioEngine && audioEngine.filter) {
                const brightness = 2000 + data.face.smile * 6000;
                audioEngine.filter.frequency.setTargetAtTime(
                    brightness, audioEngine.audioContext.currentTime, 0.1
                );
            }

            // Apply to visuals - movement energy affects particle count/speed
            if (visualEngine) {
                visualEngine.onBodyData?.(data);
            }
        });
    }
}

// ==================== SCALE SELECTION ====================
document.getElementById('scaleSelect')?.addEventListener('change', (e) => {
    if (audioEngine) {
        audioEngine.setScale(e.target.value);
    }
});

document.getElementById('rootNoteSelect')?.addEventListener('change', (e) => {
    if (audioEngine) {
        audioEngine.setScale(audioEngine.currentScale, parseInt(e.target.value));
    }
});

// ==================== AUDIO VISUALIZATION LOOP ====================
function audioLoop() {
    if (audioEngine && visualEngine) {
        visualEngine.setAudioData(
            audioEngine.getFrequencyData(),
            audioEngine.getTimeDomainData()
        );
    }
    requestAnimationFrame(audioLoop);
}
audioLoop();

// Resize handler
let resizeTimeout;
window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
        visualEngine?.resize();
    }, 100);
});

// ==================== SERVICE WORKER ====================
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('../sw.js')
            .then(() => console.log('[PWA] Ready'))
            .catch(err => console.log('[PWA] Error:', err));
    });
}

console.log('%c Echoelmusic WebApp ', 'background: linear-gradient(90deg, #00ffcc, #ff00aa); color: #0a0a0f; font-weight: bold; padding: 4px 8px; border-radius: 4px;');

// ==================== ECHOELA ASSISTANT ====================
// Initialize Echoela after DOM is ready
if (typeof Echoela !== 'undefined') {
    echoela = new Echoela();
    echoela.init().then(() => {
        console.log('[Echoela] Assistant ready');
    });
}

// Mark features as working when activated
function markFeatureActive(feature, selector) {
    if (echoela) {
        echoela.markFeatureWorking(feature, selector);
    }
}

// Hook into engine events to track feature status
window.addEventListener('load', () => {
    // Audio
    if (audioEngine) {
        markFeatureActive('audio', '.volume-slider');
    }

    // Sequencer
    const playBtn = document.getElementById('seqPlay');
    playBtn?.addEventListener('click', () => {
        markFeatureActive('sequencer', '#seqPlay');
    });

    // Visualizer - mark on first mode change
    document.querySelectorAll('.viz-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            markFeatureActive('visualizer', '.viz-buttons');
        }, { once: true });
    });

    // Breathing guide
    document.querySelectorAll('.breathing-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            if (btn.id !== 'breathOff') {
                markFeatureActive('breathing', '.breathing-select');
            }
        }, { once: true });
    });
});
</script>

</body>
</html>
