# Echoelmusic Quality Gate - Comprehensive CI/CD Pipeline
name: Quality Gate

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  pull_request:
    branches: [ main, develop ]

env:
  BUILD_TYPE: Release

jobs:
  #============================================================================
  # Job 1: Build & Test (Linux)
  #============================================================================
  build-linux:
    name: Build & Test (Ubuntu 22.04)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          ninja-build \
          libasound2-dev \
          libfreetype6-dev \
          libx11-dev \
          libxcomposite-dev \
          libxcursor-dev \
          libxinerama-dev \
          libxrandr-dev \
          libxrender-dev \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          libcurl4-openssl-dev \
          libwebkit2gtk-4.0-dev \
          lcov

    - name: Configure CMake
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -DCMAKE_CXX_FLAGS="--coverage" \
          -DBUILD_TESTS=ON

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} -j$(nproc)

    - name: Run Unit Tests
      run: |
        cd build
        ctest --output-on-failure --verbose

    - name: Generate Coverage Report
      run: |
        lcov --capture --directory build --output-file coverage.info
        lcov --remove coverage.info '/usr/*' '*/JUCE/*' '*/Tests/*' --output-file coverage_filtered.info
        lcov --list coverage_filtered.info

    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage_filtered.info
        flags: unittests
        name: codecov-umbrella

    - name: Check Coverage Threshold
      run: |
        coverage=$(lcov --summary coverage_filtered.info | grep lines | awk '{print $2}' | sed 's/%//')
        echo "Coverage: $coverage%"
        if (( $(echo "$coverage < 80.0" | bc -l) )); then
          echo "âŒ Coverage $coverage% is below 80% threshold"
          exit 1
        fi
        echo "âœ… Coverage $coverage% meets threshold"

  #============================================================================
  # Job 2: Build (macOS)
  #============================================================================
  build-macos:
    name: Build (macOS Latest)
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: brew install cmake ninja

    - name: Configure CMake
      run: |
        cmake -B build \
          -G Xcode \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}}

  #============================================================================
  # Job 3: Build (Windows)
  #============================================================================
  build-windows:
    name: Build (Windows Latest)
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Configure CMake
      run: |
        cmake -B build `
          -G "Visual Studio 17 2022" `
          -A x64 `
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}}

  #============================================================================
  # Job 4: Static Analysis
  #============================================================================
  static-analysis:
    name: Static Analysis (Clang-Tidy)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-tidy cmake ninja-build

    - name: Configure CMake
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

    - name: Run Clang-Tidy
      run: |
        # Run on all source files
        find Sources -name '*.cpp' -o -name '*.h' | \
          xargs clang-tidy \
            -p build \
            --warnings-as-errors='*' \
            --checks='-*,bugprone-*,cert-*,clang-analyzer-*,performance-*,readability-*'

  #============================================================================
  # Job 5: Security Scan
  #============================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        severity: 'HIGH,CRITICAL'
        exit-code: '1'

  #============================================================================
  # Job 6: Performance Benchmarks
  #============================================================================
  benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build libasound2-dev

    - name: Configure CMake
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_BENCHMARKS=ON

    - name: Build Benchmarks
      run: cmake --build build --config Release --target Benchmarks

    - name: Run Benchmarks
      run: |
        cd build
        ./Benchmarks --benchmark_format=json > benchmark_results.json

    - name: Compare with Baseline
      run: |
        # In production: compare with stored baseline
        # For now, just check benchmarks ran successfully
        echo "âœ… Benchmarks completed"

  #============================================================================
  # Job 7: Documentation Build
  #============================================================================
  documentation:
    name: Build Documentation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Doxygen
      run: sudo apt-get install -y doxygen graphviz

    - name: Generate Documentation
      run: doxygen Doxyfile || echo "Doxyfile not found, skipping"

    - name: Upload Documentation
      uses: actions/upload-artifact@v3
      with:
        name: documentation
        path: docs/html/
      if: success()

  #============================================================================
  # Summary Job (All Checks Pass)
  #============================================================================
  quality-gate-pass:
    name: âœ… Quality Gate PASSED
    runs-on: ubuntu-latest
    needs: [build-linux, build-macos, build-windows, static-analysis, security-scan]

    steps:
    - name: All Checks Passed
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… ALL QUALITY GATES PASSED"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "âœ… Linux Build: PASSED"
        echo "âœ… macOS Build: PASSED"
        echo "âœ… Windows Build: PASSED"
        echo "âœ… Static Analysis: PASSED"
        echo "âœ… Security Scan: PASSED"
        echo ""
        echo "ğŸ‰ Code is ready for merge!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
