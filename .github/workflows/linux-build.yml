# Linux Build Workflow for Echoelmusic
# Builds for Ubuntu/Debian-based distributions

name: Linux Build

on:
  push:
    branches: [main, develop]
    paths:
      - 'Sources/**'
      - 'Package.swift'
      - '.github/workflows/linux-build.yml'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  SWIFT_VERSION: "5.10"

jobs:
  build-linux:
    name: Build for Linux
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Swift
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: ${{ env.SWIFT_VERSION }}

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libpulse-dev \
            libavcodec-dev \
            libavformat-dev \
            libswscale-dev \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev

      - name: Verify Swift Installation
        run: swift --version

      - name: Resolve Dependencies
        run: swift package resolve

      - name: Build Package (Debug)
        run: swift build -c debug

      - name: Build Package (Release)
        run: swift build -c release

      - name: Run Tests
        run: swift test
        continue-on-error: true

      - name: Create AppImage
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          # Copy binary
          cp .build/release/Echoelmusic AppDir/usr/bin/ 2>/dev/null || echo "Binary not found, skipping"

          # Create desktop file
          cat > AppDir/usr/share/applications/echoelmusic.desktop << EOF
          [Desktop Entry]
          Type=Application
          Name=Echoelmusic
          Exec=Echoelmusic
          Icon=echoelmusic
          Categories=AudioVideo;Audio;Music;
          Comment=Bio-reactive audio-visual platform
          EOF

          # Copy icon (placeholder)
          cp Sources/Echoelmusic/Resources/Assets.xcassets/AppIcon.appiconset/icon_256x256.png \
             AppDir/usr/share/icons/hicolor/256x256/apps/echoelmusic.png 2>/dev/null || \
             echo "Icon not found, using placeholder"

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: echoelmusic-linux-${{ github.sha }}
          path: |
            .build/release/
            AppDir/
          retention-days: 7

  build-flatpak:
    name: Build Flatpak Package
    runs-on: ubuntu-22.04
    needs: build-linux
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Flatpak Builder
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder

      - name: Create Flatpak Manifest
        run: |
          cat > com.echoelmusic.Echoelmusic.yml << EOF
          app-id: com.echoelmusic.Echoelmusic
          runtime: org.freedesktop.Platform
          runtime-version: '23.08'
          sdk: org.freedesktop.Sdk
          command: Echoelmusic
          finish-args:
            - --share=ipc
            - --socket=wayland
            - --socket=fallback-x11
            - --socket=pulseaudio
            - --device=dri
            - --filesystem=home
          modules:
            - name: echoelmusic
              buildsystem: simple
              build-commands:
                - install -D Echoelmusic /app/bin/Echoelmusic
              sources:
                - type: archive
                  path: build.tar.gz
          EOF

      - name: Upload Flatpak Manifest
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-manifest
          path: com.echoelmusic.Echoelmusic.yml
          retention-days: 30

  build-snap:
    name: Build Snap Package
    runs-on: ubuntu-22.04
    needs: build-linux
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Snapcraft Config
        run: |
          mkdir -p snap
          cat > snap/snapcraft.yaml << EOF
          name: echoelmusic
          version: '1.0.0'
          summary: Bio-reactive audio-visual platform
          description: |
            Echoelmusic transforms biometrics, voice, and gestures into
            spatial audio, real-time visuals, and LED/DMX lighting.

          base: core22
          confinement: strict
          grade: stable

          apps:
            echoelmusic:
              command: bin/Echoelmusic
              plugs:
                - audio-playback
                - audio-record
                - pulseaudio
                - home
                - network

          parts:
            echoelmusic:
              plugin: nil
              source: .
              build-packages:
                - swift
              stage-packages:
                - libasound2
                - libpulse0
          EOF

      - name: Upload Snap Config
        uses: actions/upload-artifact@v4
        with:
          name: snap-config
          path: snap/
          retention-days: 30
