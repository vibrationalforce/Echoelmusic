name: ðŸš€ Deploy Backend to Production

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch: # Manual trigger

env:
  DEPLOY_SERVER: ${{ secrets.DEPLOY_SERVER_IP }}
  DEPLOY_USER: root
  DEPLOY_PATH: /root/echoelmusic

jobs:
  # ================================
  # TEST JOB
  # ================================
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: ðŸ“¦ Install dependencies
        working-directory: backend
        run: npm ci

      - name: ðŸ§ª Run tests
        working-directory: backend
        run: npm test

      - name: âœ… Lint code
        working-directory: backend
        run: npm run lint

  # ================================
  # BUILD JOB
  # ================================
  build:
    name: ðŸ—ï¸ Build Docker Image
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”‘ Login to Docker Hub (optional)
        if: ${{ secrets.DOCKER_USERNAME != '' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ—ï¸ Build Docker image
        working-directory: backend
        run: |
          docker build -t echoelmusic-api:latest .
          docker build -t echoelmusic-api:${{ github.sha }} .

      - name: ðŸ’¾ Save Docker image
        run: |
          docker save echoelmusic-api:latest | gzip > echoelmusic-api.tar.gz

      - name: ðŸ“¤ Upload image artifact
        uses: actions/upload-artifact@v3
        with:
          name: docker-image
          path: echoelmusic-api.tar.gz
          retention-days: 1

  # ================================
  # DEPLOY JOB
  # ================================
  deploy:
    name: ðŸš€ Deploy to Server
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Docker image
        uses: actions/download-artifact@v3
        with:
          name: docker-image

      - name: ðŸ”‘ Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.DEPLOY_SERVER }} >> ~/.ssh/known_hosts

      - name: ðŸ“¤ Upload files to server
        run: |
          scp -r backend/* ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_SERVER }}:${{ env.DEPLOY_PATH }}/
          scp echoelmusic-api.tar.gz ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_SERVER }}:${{ env.DEPLOY_PATH }}/

      - name: ðŸš€ Deploy on server
        run: |
          ssh ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_SERVER }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}

            # Load Docker image
            gunzip -c echoelmusic-api.tar.gz | docker load

            # Stop old containers
            docker-compose down

            # Start new containers
            docker-compose up -d

            # Clean up
            docker image prune -f
            rm echoelmusic-api.tar.gz

            # Health check
            sleep 10
            curl -f http://localhost:3000/health || exit 1

            echo "âœ… Deployment successful!"
          EOF

      - name: ðŸ”” Notify on success
        if: success()
        run: |
          echo "âœ… Deployment to production successful!"
          # Add Slack/Discord notification here if needed

      - name: ðŸ”” Notify on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          # Add Slack/Discord notification here if needed

  # ================================
  # HEALTH CHECK JOB
  # ================================
  health-check:
    name: ðŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ¥ Check API health
        run: |
          sleep 15
          curl -f https://api.${{ secrets.DOMAIN }}/health || exit 1

      - name: ðŸ¥ Check database connectivity
        run: |
          curl -f https://api.${{ secrets.DOMAIN }}/api/health/db || exit 1

      - name: âœ… All systems operational
        run: echo "âœ… All health checks passed!"
