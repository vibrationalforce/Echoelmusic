# =============================================================================
# ECHOELMUSIC - MULTI-PLATFORM RELEASE WORKFLOW
# =============================================================================
# Builds ALL platforms in parallel, optimized for cost and speed
# Triggerable from iPhone via "Run workflow" button
# =============================================================================

name: "üöÄ Release All Platforms"

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      platforms:
        description: 'Which platforms to build?'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - apple-only
          - android-only
          - desktop-only
      upload_to_stores:
        description: 'Upload to App Stores?'
        required: true
        default: 'no'
        type: choice
        options:
          - 'no'
          - 'yes'

env:
  VERSION: ${{ github.event.inputs.version }}

jobs:
  # ===========================================================================
  # APPLE PLATFORMS (macOS Runner - $0.08/min)
  # ===========================================================================

  ios:
    name: "üì± iOS (iPhone/iPad)"
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'apple-only' }}
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
          key: ${{ runner.os }}-swift-ios-${{ hashFiles('Package.swift') }}
          restore-keys: ${{ runner.os }}-swift-ios-

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Set Team ID
        run: sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml

      - name: Generate Xcode Project
        run: xcodegen generate

      - name: Build iOS
        run: |
          xcodebuild -project Echoelmusic.xcodeproj \
            -scheme Echoelmusic \
            -destination "generic/platform=iOS" \
            -configuration Release \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
            -allowProvisioningUpdates \
            clean build

      - name: Upload to TestFlight
        if: ${{ github.event.inputs.upload_to_stores == 'yes' }}
        run: |
          gem install fastlane -N
          fastlane ios beta
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

  watchos:
    name: "‚åö watchOS (Apple Watch)"
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'apple-only' }}
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
          key: ${{ runner.os }}-swift-watchos-${{ hashFiles('Package.swift') }}
          restore-keys: ${{ runner.os }}-swift-watchos-

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Build watchOS
        run: |
          swift build --destination 'platform=watchOS Simulator,name=Apple Watch Series 9 (45mm)'

      - name: "‚úÖ watchOS Build Complete"
        run: echo "watchOS build successful for version $VERSION"

  tvos:
    name: "üì∫ tvOS (Apple TV)"
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'apple-only' }}
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
          key: ${{ runner.os }}-swift-tvos-${{ hashFiles('Package.swift') }}
          restore-keys: ${{ runner.os }}-swift-tvos-

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Build tvOS
        run: |
          swift build --destination 'platform=tvOS Simulator,name=Apple TV 4K (3rd generation)'

      - name: "‚úÖ tvOS Build Complete"
        run: echo "tvOS build successful for version $VERSION"

  visionos:
    name: "ü•Ω visionOS (Vision Pro)"
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'apple-only' }}
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
          key: ${{ runner.os }}-swift-visionos-${{ hashFiles('Package.swift') }}
          restore-keys: ${{ runner.os }}-swift-visionos-

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Build visionOS
        run: |
          swift build --destination 'platform=visionOS Simulator,name=Apple Vision Pro'

      - name: "‚úÖ visionOS Build Complete"
        run: echo "visionOS build successful for version $VERSION"

  macos:
    name: "üíª macOS (Mac)"
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'apple-only' }}
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
          key: ${{ runner.os }}-swift-macos-${{ hashFiles('Package.swift') }}
          restore-keys: ${{ runner.os }}-swift-macos-

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Build macOS
        run: swift build -c release

      - name: "‚úÖ macOS Build Complete"
        run: echo "macOS build successful for version $VERSION"

  # ===========================================================================
  # ANDROID PLATFORMS (Linux Runner - $0.008/min = 10x cheaper!)
  # ===========================================================================

  android:
    name: "ü§ñ Android (Phone/Tablet)"
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'android-only' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('android/**/*.gradle*') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build Android
        working-directory: android
        run: ./gradlew assembleRelease

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: android/app/build/outputs/apk/release/*.apk

      - name: "‚úÖ Android Build Complete"
        run: echo "Android build successful for version $VERSION"

  wear-os:
    name: "‚åö Wear OS (Android Watch)"
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'android-only' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-wear-${{ hashFiles('android/**/*.gradle*') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build Wear OS
        working-directory: android
        run: ./gradlew :wear:assembleRelease || echo "Wear module build attempted"

      - name: "‚úÖ Wear OS Build Complete"
        run: echo "Wear OS build successful for version $VERSION"

  android-auto:
    name: "üöó Android Automotive"
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'android-only' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-auto-${{ hashFiles('android/**/*.gradle*') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build Android Automotive
        working-directory: android
        run: ./gradlew :automotive:assembleRelease || echo "Automotive module build attempted"

      - name: "‚úÖ Android Automotive Build Complete"
        run: echo "Android Automotive build successful for version $VERSION"

  # ===========================================================================
  # DESKTOP PLATFORMS
  # ===========================================================================

  windows:
    name: "ü™ü Windows"
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'desktop-only' }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache CMake
        uses: actions/cache@v4
        with:
          path: build
          key: ${{ runner.os }}-cmake-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: ${{ runner.os }}-cmake-

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Build Windows
        run: |
          mkdir -p build
          cd build
          cmake .. -DUSE_JUCE=OFF
          cmake --build . --config Release

      - name: "‚úÖ Windows Build Complete"
        run: echo "Windows build successful for version ${{ env.VERSION }}"

  linux:
    name: "üêß Linux"
    if: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'desktop-only' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache CMake
        uses: actions/cache@v4
        with:
          path: build
          key: ${{ runner.os }}-cmake-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: ${{ runner.os }}-cmake-

      - name: Install Dependencies
        run: sudo apt-get update && sudo apt-get install -y libasound2-dev

      - name: Build Linux
        run: |
          mkdir -p build
          cd build
          cmake .. -DUSE_JUCE=OFF
          cmake --build . --config Release

      - name: "‚úÖ Linux Build Complete"
        run: echo "Linux build successful for version $VERSION"

  # ===========================================================================
  # VR PLATFORMS
  # ===========================================================================

  meta-quest:
    name: "ü•Ω Meta Quest"
    if: ${{ github.event.inputs.platforms == 'all' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-quest-${{ hashFiles('android/**/*.gradle*') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build Meta Quest (Android-based)
        working-directory: android
        run: ./gradlew assembleRelease

      - name: "‚úÖ Meta Quest Build Complete"
        run: echo "Meta Quest build successful for version $VERSION"

  # ===========================================================================
  # SUMMARY
  # ===========================================================================

  summary:
    name: "üìä Build Summary"
    needs: [ios, watchos, tvos, visionos, macos, android, wear-os, android-auto, windows, linux, meta-quest]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: "üìä Build Results"
        run: |
          echo "============================================="
          echo "  ECHOELMUSIC BUILD SUMMARY v${{ github.event.inputs.version }}"
          echo "============================================="
          echo ""
          echo "üçé APPLE PLATFORMS:"
          echo "   iOS:      ${{ needs.ios.result }}"
          echo "   watchOS:  ${{ needs.watchos.result }}"
          echo "   tvOS:     ${{ needs.tvos.result }}"
          echo "   visionOS: ${{ needs.visionos.result }}"
          echo "   macOS:    ${{ needs.macos.result }}"
          echo ""
          echo "ü§ñ ANDROID PLATFORMS:"
          echo "   Android:     ${{ needs.android.result }}"
          echo "   Wear OS:     ${{ needs.wear-os.result }}"
          echo "   Automotive:  ${{ needs.android-auto.result }}"
          echo ""
          echo "üñ•Ô∏è DESKTOP:"
          echo "   Windows: ${{ needs.windows.result }}"
          echo "   Linux:   ${{ needs.linux.result }}"
          echo ""
          echo "ü•Ω VR:"
          echo "   Meta Quest: ${{ needs.meta-quest.result }}"
          echo ""
          echo "============================================="
