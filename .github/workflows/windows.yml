name: Windows Build and Deploy

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

jobs:
  build-windows:
    name: Build Windows App
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.27.x'

    - name: Cache JUCE
      uses: actions/cache@v3
      with:
        path: |
          desktop-engine/JUCE
          desktop-engine/build
        key: ${{ runner.os }}-juce-${{ hashFiles('desktop-engine/CMakeLists.txt') }}

    - name: Install dependencies
      run: |
        choco install innosetup -y

    - name: Configure CMake
      run: |
        cd desktop-engine
        cmake -B build -S . -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=Release `
          -DJUCE_BUILD_EXTRAS=OFF `
          -DJUCE_BUILD_EXAMPLES=OFF

    - name: Build
      run: |
        cd desktop-engine
        cmake --build build --config Release --parallel

    - name: Run tests
      run: |
        cd desktop-engine/build/Release
        .\EchoelmusicTests.exe

    - name: Sign executable
      if: startsWith(github.ref, 'refs/tags/v')
      env:
        WINDOWS_CERTIFICATE_BASE64: ${{ secrets.WINDOWS_CERTIFICATE_BASE64 }}
        WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
      run: |
        # Decode certificate
        $cert_bytes = [Convert]::FromBase64String($env:WINDOWS_CERTIFICATE_BASE64)
        [IO.File]::WriteAllBytes("certificate.pfx", $cert_bytes)

        # Sign
        & "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe" sign `
          /f certificate.pfx `
          /p $env:WINDOWS_CERTIFICATE_PASSWORD `
          /tr http://timestamp.digicert.com `
          /td sha256 `
          /fd sha256 `
          desktop-engine\build\Release\Echoelmusic.exe

        Remove-Item certificate.pfx

    - name: Create installer
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        # Copy files to installer directory
        New-Item -ItemType Directory -Force -Path installer\windows
        Copy-Item desktop-engine\build\Release\Echoelmusic.exe installer\windows\
        Copy-Item -Recurse desktop-engine\Resources\* installer\windows\

        # Build installer with Inno Setup
        iscc installer\windows-installer.iss

    - name: Sign installer
      if: startsWith(github.ref, 'refs/tags/v')
      env:
        WINDOWS_CERTIFICATE_BASE64: ${{ secrets.WINDOWS_CERTIFICATE_BASE64 }}
        WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
      run: |
        $cert_bytes = [Convert]::FromBase64String($env:WINDOWS_CERTIFICATE_BASE64)
        [IO.File]::WriteAllBytes("certificate.pfx", $cert_bytes)

        & "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe" sign `
          /f certificate.pfx `
          /p $env:WINDOWS_CERTIFICATE_PASSWORD `
          /tr http://timestamp.digicert.com `
          /td sha256 `
          /fd sha256 `
          installer\Echoelmusic-Setup.exe

        Remove-Item certificate.pfx

    - name: Create MSIX package
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        # Package for Microsoft Store
        makeappx pack /d installer\windows /p installer\Echoelmusic.msix

    - name: Upload to Microsoft Store
      if: startsWith(github.ref, 'refs/tags/v')
      env:
        MICROSOFT_STORE_TENANT_ID: ${{ secrets.MICROSOFT_STORE_TENANT_ID }}
        MICROSOFT_STORE_CLIENT_ID: ${{ secrets.MICROSOFT_STORE_CLIENT_ID }}
        MICROSOFT_STORE_CLIENT_SECRET: ${{ secrets.MICROSOFT_STORE_CLIENT_SECRET }}
      run: |
        # Install StoreBroker module
        Install-Module -Name StoreBroker -Force -Scope CurrentUser

        # Submit to Store
        # Note: This requires additional setup and configuration
        # See: https://github.com/Microsoft/StoreBroker

    - name: Upload to CDN
      if: startsWith(github.ref, 'refs/tags/v')
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: eu-central-1
      run: |
        aws s3 cp installer\Echoelmusic-Setup.exe `
          s3://echoelmusic-downloads/windows/Echoelmusic-Setup-$($env:GITHUB_REF -replace 'refs/tags/','').exe `
          --acl public-read

    - name: Upload artifacts
      if: startsWith(github.ref, 'refs/tags/v')
      uses: actions/upload-artifact@v3
      with:
        name: Echoelmusic-Windows
        path: |
          installer\Echoelmusic-Setup.exe
          installer\Echoelmusic.msix

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          installer\Echoelmusic-Setup.exe
          installer\Echoelmusic.msix
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
