# =============================================================================
# ECHOELMUSIC - AUTO-MERGE CLAUDE BRANCHES
# =============================================================================
# Direct merge approach: checkout main, merge claude branch commit, push
# =============================================================================
name: Auto-Merge Claude Branch

on:
  push:
    branches:
      - 'claude/**'
    paths:
      - 'Sources/**'
      - 'Tests/**'
      - 'Package.swift'
      - 'project.yml'
      - '.github/workflows/**'

permissions:
  contents: write

jobs:
  auto-merge:
    name: Auto-Merge to Main
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch pushed commit
        id: fetch
        run: |
          echo "=============================================="
          echo "  FETCHING PUSHED COMMIT"
          echo "=============================================="
          echo "Push SHA: ${{ github.sha }}"
          echo "Push branch: ${{ github.ref_name }}"

          git fetch origin ${{ github.sha }} --depth=50 || git fetch origin --all

          if git cat-file -e ${{ github.sha }}^{commit} 2>/dev/null; then
            echo "commit_exists=true" >> $GITHUB_OUTPUT
            echo "[OK] Commit ${{ github.sha }} is accessible"
          else
            echo "commit_exists=false" >> $GITHUB_OUTPUT
            echo "[ERROR] Commit ${{ github.sha }} not found"
            exit 1
          fi

      - name: Merge to main
        if: steps.fetch.outputs.commit_exists == 'true'
        id: merge
        run: |
          echo "=============================================="
          echo "  MERGING CHANGES TO MAIN"
          echo "=============================================="

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "Current branch: $(git branch --show-current)"
          echo "Current HEAD: $(git rev-parse HEAD)"
          echo "Target commit: ${{ github.sha }}"

          # Show what we're merging
          echo ""
          echo "Files changed:"
          git diff --name-only HEAD..${{ github.sha }} 2>/dev/null || echo "(could not diff)"
          echo ""

          # Try merge
          if git merge ${{ github.sha }} --no-edit -m "fix: auto-merge from ${{ github.ref_name }}"; then
            echo ""
            echo "Merge successful, pushing to main..."
            echo "New HEAD: $(git rev-parse HEAD)"

            if git push origin main 2>&1; then
              echo "merge_status=success" >> $GITHUB_OUTPUT
              echo "[OK] Pushed to main successfully!"
            else
              echo "merge_status=push_failed" >> $GITHUB_OUTPUT
              echo "[ERROR] Push to main failed"
              exit 1
            fi
          else
            echo "merge_status=conflict" >> $GITHUB_OUTPUT
            echo "[ERROR] Merge failed - conflicts detected"
            git merge --abort 2>/dev/null || true
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Auto-Merge Claude Branch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pushed Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Source Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit Found | ${{ steps.fetch.outputs.commit_exists == 'true' && 'Yes' || 'No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Merge Status | ${{ steps.merge.outputs.merge_status || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
