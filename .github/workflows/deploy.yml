# =============================================================================
# Echoelmusic - Apple Platform Deployment (Headless CI/CD)
# =============================================================================
# Deploys to TestFlight/App Store via Fastlane
# All Apple certificate keys are provided via GitHub Repository Secrets
# NO local key reading - pure headless environment
# =============================================================================
#
# REQUIRED SECRETS (configure in GitHub Repository Settings):
#   APP_STORE_CONNECT_KEY_ID       - API Key ID from App Store Connect
#   APP_STORE_CONNECT_ISSUER_ID    - Issuer ID from App Store Connect
#   APP_STORE_CONNECT_PRIVATE_KEY  - .p8 file content (plain text)
#   APPLE_TEAM_ID                  - Team ID from developer.apple.com
#   CI_KEYCHAIN_PASSWORD           - (optional) Custom keychain password
#
# =============================================================================

name: Deploy Apple Platforms

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ios
          - macos
          - ios-macos
      environment:
        description: 'Environment'
        required: true
        default: 'testflight'
        type: choice
        options:
          - testflight
          - production
      clean_build:
        description: 'Clean build (slower but fresh)'
        required: false
        default: false
        type: boolean

env:
  VERSION: '1.2.0'
  XCODE_VERSION: '15.4'

jobs:
  # ===========================================================================
  # PREFLIGHT - Validate secrets and environment
  # ===========================================================================
  preflight:
    name: Preflight Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ steps.version.outputs.build_number }}
      ready: ${{ steps.check.outputs.ready }}

    steps:
      - uses: actions/checkout@v4

      - name: Get Version Info
        id: version
        run: |
          echo "version=${{ env.VERSION }}" >> $GITHUB_OUTPUT
          echo "build_number=${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: Validate Secrets
        id: check
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          echo "=============================================="
          echo "  DEPLOYMENT PREFLIGHT CHECK"
          echo "=============================================="
          echo "Platform: ${{ github.event.inputs.platform }}"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Build: ${{ github.run_number }}"
          echo ""

          ERRORS=0

          # Check required files
          echo "Checking required files..."
          for f in Package.swift project.yml fastlane/Fastfile; do
            if [ -f "$f" ]; then
              echo "  [OK] $f"
            else
              echo "  [FAIL] $f missing"
              ((ERRORS++))
            fi
          done

          echo ""
          echo "Checking GitHub Secrets..."

          # Check secrets (without exposing values)
          if [ -n "$ASC_KEY_ID" ]; then
            echo "  [OK] APP_STORE_CONNECT_KEY_ID"
          else
            echo "  [FAIL] APP_STORE_CONNECT_KEY_ID not set"
            ((ERRORS++))
          fi

          if [ -n "$ASC_ISSUER_ID" ]; then
            echo "  [OK] APP_STORE_CONNECT_ISSUER_ID"
          else
            echo "  [FAIL] APP_STORE_CONNECT_ISSUER_ID not set"
            ((ERRORS++))
          fi

          if [ -n "$ASC_KEY" ]; then
            echo "  [OK] APP_STORE_CONNECT_PRIVATE_KEY (configured)"
          else
            echo "  [FAIL] APP_STORE_CONNECT_PRIVATE_KEY not set"
            ((ERRORS++))
          fi

          if [ -n "$TEAM_ID" ]; then
            echo "  [OK] APPLE_TEAM_ID"
          else
            echo "  [FAIL] APPLE_TEAM_ID not set"
            ((ERRORS++))
          fi

          echo ""
          echo "=============================================="

          if [ $ERRORS -gt 0 ]; then
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "[FAIL] $ERRORS error(s) found"
            echo ""
            echo "Configure secrets at:"
            echo "https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi

          echo "ready=true" >> $GITHUB_OUTPUT
          echo "[PASS] All checks passed - ready to deploy"

  # ===========================================================================
  # iOS DEPLOYMENT
  # ===========================================================================
  ios:
    name: iOS Deploy
    runs-on: macos-14
    needs: preflight
    timeout-minutes: 60
    if: >-
      needs.preflight.outputs.ready == 'true' &&
      contains('all ios ios-macos', github.event.inputs.platform)

    steps:
      - uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Show Environment
        run: |
          echo "Xcode: $(xcodebuild -version | head -1)"
          echo "Swift: $(swift --version | head -1)"
          echo "Build: ${{ needs.preflight.outputs.build_number }}"

      - name: Install XcodeGen
        run: brew install xcodegen || true

      - name: Install Fastlane
        run: gem install fastlane -N --no-document

      - name: Generate Xcode Project
        run: |
          # Set Team ID in project.yml
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ needs.preflight.outputs.build_number }}/" project.yml

          # Generate project
          xcodegen generate --spec project.yml

          echo "Project generated successfully"

      - name: Resolve Swift Packages
        run: swift package resolve || true

      - name: Setup CI Keychain
        env:
          KEYCHAIN_PASSWORD: ${{ secrets.CI_KEYCHAIN_PASSWORD || github.run_id }}
        run: |
          set -e
          # Create fresh keychain for CI
          security create-keychain -p "$KEYCHAIN_PASSWORD" ci_ios.keychain-db
          security set-keychain-settings -lut 21600 ci_ios.keychain-db
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" ci_ios.keychain-db
          security list-keychains -d user -s ci_ios.keychain-db
          security default-keychain -s ci_ios.keychain-db
          echo "CI Keychain configured"

      - name: Deploy iOS to TestFlight
        run: fastlane ios beta
        env:
          # App Store Connect API credentials (from GitHub Secrets)
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          # Build configuration
          BUILD_NUMBER: ${{ needs.preflight.outputs.build_number }}
          CLEAN_BUILD: ${{ github.event.inputs.clean_build }}
          # Keychain configuration
          KEYCHAIN_PATH: ~/Library/Keychains/ci_ios.keychain-db
          KEYCHAIN_PASSWORD: ${{ secrets.CI_KEYCHAIN_PASSWORD || github.run_id }}

      - name: Cleanup Keychain
        if: always()
        run: security delete-keychain ci_ios.keychain-db 2>/dev/null || true

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ needs.preflight.outputs.version }}-${{ needs.preflight.outputs.build_number }}
          path: |
            *.ipa
            build/*.ipa
            fastlane/output/*.ipa
          if-no-files-found: ignore
          retention-days: 30

  # ===========================================================================
  # macOS DEPLOYMENT
  # ===========================================================================
  macos:
    name: macOS Deploy
    runs-on: macos-14
    needs: preflight
    timeout-minutes: 60
    if: >-
      needs.preflight.outputs.ready == 'true' &&
      contains('all macos ios-macos', github.event.inputs.platform)

    steps:
      - uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Show Environment
        run: |
          echo "Xcode: $(xcodebuild -version | head -1)"
          echo "Swift: $(swift --version | head -1)"
          echo "Build: ${{ needs.preflight.outputs.build_number }}"

      - name: Install XcodeGen
        run: brew install xcodegen || true

      - name: Install Fastlane
        run: gem install fastlane -N --no-document

      - name: Generate Xcode Project
        run: |
          # Set Team ID in project.yml
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ needs.preflight.outputs.build_number }}/" project.yml

          # Generate project
          xcodegen generate --spec project.yml

          echo "Project generated successfully"

      - name: Resolve Swift Packages
        run: swift package resolve || true

      - name: Setup CI Keychain
        env:
          KEYCHAIN_PASSWORD: ${{ secrets.CI_KEYCHAIN_PASSWORD || github.run_id }}
        run: |
          set -e
          # Create fresh keychain for CI
          security create-keychain -p "$KEYCHAIN_PASSWORD" ci_macos.keychain-db
          security set-keychain-settings -lut 21600 ci_macos.keychain-db
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" ci_macos.keychain-db
          security list-keychains -d user -s ci_macos.keychain-db
          security default-keychain -s ci_macos.keychain-db
          echo "CI Keychain configured"

      - name: Deploy macOS to TestFlight
        run: fastlane mac beta
        env:
          # App Store Connect API credentials (from GitHub Secrets)
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          # Build configuration
          BUILD_NUMBER: ${{ needs.preflight.outputs.build_number }}
          CLEAN_BUILD: ${{ github.event.inputs.clean_build }}
          # Keychain configuration
          KEYCHAIN_PATH: ~/Library/Keychains/ci_macos.keychain-db
          KEYCHAIN_PASSWORD: ${{ secrets.CI_KEYCHAIN_PASSWORD || github.run_id }}

      - name: Cleanup Keychain
        if: always()
        run: security delete-keychain ci_macos.keychain-db 2>/dev/null || true

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ needs.preflight.outputs.version }}-${{ needs.preflight.outputs.build_number }}
          path: |
            *.pkg
            *.app
            build/*.pkg
            build/*.app
            fastlane/output/*
          if-no-files-found: ignore
          retention-days: 30

  # ===========================================================================
  # DEPLOYMENT SUMMARY
  # ===========================================================================
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [preflight, ios, macos]
    if: always()

    steps:
      - name: Generate Deployment Report
        run: |
          echo "# Apple Platform Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.preflight.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** ${{ needs.preflight.outputs.build_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Preflight | ${{ needs.preflight.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS | ${{ needs.ios.result == 'success' && '✅ Deployed' || needs.ios.result == 'skipped' && '⏭️ Skipped' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | ${{ needs.macos.result == 'success' && '✅ Deployed' || needs.macos.result == 'skipped' && '⏭️ Skipped' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. [Open App Store Connect](https://appstoreconnect.apple.com) to check build processing" >> $GITHUB_STEP_SUMMARY
          echo "2. TestFlight builds usually process within 15-30 minutes" >> $GITHUB_STEP_SUMMARY
          echo "3. Add testers or submit for review when ready" >> $GITHUB_STEP_SUMMARY
