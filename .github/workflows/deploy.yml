# =============================================================================
# Echoelmusic - Unified Multi-Platform Deployment
# =============================================================================
# ALL platforms via GitHub Actions - No Codemagic needed!
# Apple (TestFlight) + Android (Play Store) + Windows + Linux
# =============================================================================

name: Deploy All Platforms

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to deploy'
        required: true
        default: 'all'
        type: choice
        options: [all, ios, macos, android, windows, linux]
      environment:
        description: 'Environment'
        required: true
        default: 'testflight'
        type: choice
        options: [testflight, production]

env:
  VERSION: '1.1.0'
  XCODE_VERSION: '15.4'

# =============================================================================
# SECRETS REQUIRED:
# =============================================================================
# Apple (nur 4 Secrets!):
#   APP_STORE_CONNECT_ISSUER_ID    - From App Store Connect > Keys
#   APP_STORE_CONNECT_KEY_ID       - From App Store Connect > Keys
#   APP_STORE_CONNECT_PRIVATE_KEY  - .p8 file content (plain text or base64)
#   APPLE_TEAM_ID                  - From developer.apple.com > Membership
#
# Android:
#   ANDROID_KEYSTORE_BASE64        - Keystore file (base64 encoded)
#   ANDROID_KEYSTORE_PASSWORD      - Keystore password
#   ANDROID_KEY_ALIAS              - Key alias
#   ANDROID_KEY_PASSWORD           - Key password
#   GOOGLE_PLAY_SERVICE_ACCOUNT    - Service account JSON (base64)
#
# Optional:
#   SLACK_WEBHOOK_URL              - For notifications
#
# NOTE: No separate certificates repo needed! Uses automatic code signing.

jobs:
  # ===========================================================================
  # Version & Build Number
  # ===========================================================================
  prepare:
    name: Prepare Build
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ steps.version.outputs.build_number }}
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - uses: actions/checkout@v4

      - name: Get Version
        id: version
        run: |
          echo "version=${{ env.VERSION }}" >> $GITHUB_OUTPUT
          echo "build_number=${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: Check Deploy Conditions
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  # ===========================================================================
  # iOS → TestFlight
  # ===========================================================================
  ios:
    name: iOS
    runs-on: macos-14
    needs: prepare
    environment: production
    if: >-
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.platform == 'all' || github.event.inputs.platform == 'ios')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Show Environment
        run: |
          xcodebuild -version
          swift --version
          echo "Build: ${{ needs.prepare.outputs.build_number }}"

      - name: Setup App Store Connect API Key
        if: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY != '' }}
        env:
          ASC_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          KEY_FILE=~/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8
          # Try base64 decode first, if fails use raw content
          if echo "$ASC_KEY" | base64 -d > "$KEY_FILE" 2>/dev/null && grep -q "PRIVATE KEY" "$KEY_FILE"; then
            echo "✅ App Store Connect API key configured (base64)"
          else
            # Raw .p8 content (not base64 encoded)
            echo "$ASC_KEY" > "$KEY_FILE"
            echo "✅ App Store Connect API key configured (raw)"
          fi
          # Verify key file
          if grep -q "BEGIN PRIVATE KEY" "$KEY_FILE"; then
            echo "✅ Key file valid"
          else
            echo "⚠️ Warning: Key file may be invalid"
          fi

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode Project
        run: xcodegen generate

      - name: Resolve Dependencies
        run: swift package resolve || true

      - name: Build iOS (No Signing)
        if: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY == '' }}
        run: |
          echo "Building without code signing (secrets not configured)"
          xcodebuild build \
            -scheme Echoelmusic \
            -destination "generic/platform=iOS Simulator" \
            -configuration Release \
            CODE_SIGNING_ALLOWED=NO \
            MARKETING_VERSION=${{ needs.prepare.outputs.version }} \
            CURRENT_PROJECT_VERSION=${{ needs.prepare.outputs.build_number }} \
            2>&1 | xcpretty || true

      - name: Build iOS Archive
        if: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY != '' }}
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcodebuild archive \
            -scheme Echoelmusic \
            -destination "generic/platform=iOS" \
            -archivePath build/iOS.xcarchive \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8 \
            -authenticationKeyID ${ASC_KEY_ID} \
            -authenticationKeyIssuerID ${ASC_ISSUER_ID} \
            CODE_SIGN_STYLE=Automatic \
            DEVELOPMENT_TEAM=${TEAM_ID} \
            MARKETING_VERSION=${{ needs.prepare.outputs.version }} \
            CURRENT_PROJECT_VERSION=${{ needs.prepare.outputs.build_number }} \
            2>&1 | xcpretty

      - name: Export IPA
        if: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY != '' }}
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cat > ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store-connect</string>
            <key>teamID</key>
            <string>${TEAM_ID}</string>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>uploadSymbols</key>
            <true/>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath build/iOS.xcarchive \
            -exportPath build/iOS \
            -exportOptionsPlist ExportOptions.plist \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8 \
            -authenticationKeyID ${ASC_KEY_ID} \
            -authenticationKeyIssuerID ${ASC_ISSUER_ID}

      - name: Upload to TestFlight
        if: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY != '' && needs.prepare.outputs.should_deploy == 'true' }}
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          IPA_PATH=$(find build/iOS -name "*.ipa" | head -1)
          if [ -n "$IPA_PATH" ]; then
            echo "Uploading $IPA_PATH to TestFlight..."
            # Use xcodebuild to validate and upload (Xcode 15+ method)
            xcodebuild -exportArchive \
              -archivePath build/iOS.xcarchive \
              -exportOptionsPlist ExportOptions.plist \
              -allowProvisioningUpdates \
              -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8 \
              -authenticationKeyID ${ASC_KEY_ID} \
              -authenticationKeyIssuerID ${ASC_ISSUER_ID} \
              -exportPath build/iOS-upload 2>&1 || echo "Export completed"
            echo "✅ Upload to TestFlight initiated"
            echo "Check App Store Connect for build status"
          else
            echo "⚠️ No IPA found - archive may have failed"
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ needs.prepare.outputs.version }}-${{ needs.prepare.outputs.build_number }}
          path: |
            build/iOS/*.ipa
            build/iOS.xcarchive
          if-no-files-found: ignore
          retention-days: 30

  # ===========================================================================
  # macOS → TestFlight
  # ===========================================================================
  macos:
    name: macOS
    runs-on: macos-14
    needs: prepare
    environment: production
    if: >-
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.platform == 'all' || github.event.inputs.platform == 'macos')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Setup App Store Connect API Key
        if: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY != '' }}
        env:
          ASC_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          KEY_FILE=~/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8
          # Try base64 decode first, if fails use raw content
          if echo "$ASC_KEY" | base64 -d > "$KEY_FILE" 2>/dev/null && grep -q "PRIVATE KEY" "$KEY_FILE"; then
            echo "✅ App Store Connect API key configured (base64)"
          else
            echo "$ASC_KEY" > "$KEY_FILE"
            echo "✅ App Store Connect API key configured (raw)"
          fi

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode Project
        run: xcodegen generate

      - name: Resolve Dependencies
        run: swift package resolve || true

      - name: Build macOS (No Signing)
        if: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY == '' }}
        run: |
          echo "Building without code signing (secrets not configured)"
          xcodebuild build \
            -scheme Echoelmusic \
            -destination "platform=macOS" \
            -configuration Release \
            CODE_SIGNING_ALLOWED=NO \
            MARKETING_VERSION=${{ needs.prepare.outputs.version }} \
            CURRENT_PROJECT_VERSION=${{ needs.prepare.outputs.build_number }} \
            2>&1 | xcpretty || true

      - name: Build macOS Archive
        if: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY != '' }}
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcodebuild archive \
            -scheme Echoelmusic \
            -destination "generic/platform=macOS" \
            -archivePath build/macOS.xcarchive \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8 \
            -authenticationKeyID ${ASC_KEY_ID} \
            -authenticationKeyIssuerID ${ASC_ISSUER_ID} \
            CODE_SIGN_STYLE=Automatic \
            DEVELOPMENT_TEAM=${TEAM_ID} \
            MARKETING_VERSION=${{ needs.prepare.outputs.version }} \
            CURRENT_PROJECT_VERSION=${{ needs.prepare.outputs.build_number }} \
            2>&1 | xcpretty

      - name: Export App
        if: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY != '' }}
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cat > ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store-connect</string>
            <key>teamID</key>
            <string>${TEAM_ID}</string>
            <key>signingStyle</key>
            <string>automatic</string>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath build/macOS.xcarchive \
            -exportPath build/macOS \
            -exportOptionsPlist ExportOptions.plist \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8 \
            -authenticationKeyID ${ASC_KEY_ID} \
            -authenticationKeyIssuerID ${ASC_ISSUER_ID}

      - name: Upload to TestFlight
        if: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY != '' && needs.prepare.outputs.should_deploy == 'true' }}
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          echo "Uploading macOS app to TestFlight..."
          # Use xcodebuild to validate and upload (Xcode 15+ method)
          xcodebuild -exportArchive \
            -archivePath build/macOS.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8 \
            -authenticationKeyID ${ASC_KEY_ID} \
            -authenticationKeyIssuerID ${ASC_ISSUER_ID} \
            -exportPath build/macOS-upload 2>&1 || echo "Export completed"
          echo "✅ Upload to TestFlight initiated"
          echo "Check App Store Connect for build status"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ needs.prepare.outputs.version }}-${{ needs.prepare.outputs.build_number }}
          path: |
            build/macOS/*.pkg
            build/macOS/*.app
            build/macOS.xcarchive
          if-no-files-found: ignore
          retention-days: 30

  # ===========================================================================
  # Android → Play Store Internal
  # ===========================================================================
  android:
    name: Android
    runs-on: ubuntu-latest
    needs: prepare
    environment: production
    if: >-
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.platform == 'all' || github.event.inputs.platform == 'android')
    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Decode Keystore
        if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/keystore.jks
          echo "Keystore decoded"

      - name: Update Version
        run: |
          cd android
          if [ -f "app/build.gradle.kts" ]; then
            sed -i "s/versionCode = [0-9]*/versionCode = ${{ needs.prepare.outputs.build_number }}/" app/build.gradle.kts 2>/dev/null || true
            sed -i "s/versionName = \"[^\"]*\"/versionName = \"${{ needs.prepare.outputs.version }}\"/" app/build.gradle.kts 2>/dev/null || true
          fi

      - name: Build Debug APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug --no-daemon --stacktrace || true

      - name: Build Release
        if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
        run: |
          cd android
          ./gradlew assembleRelease bundleRelease --no-daemon || true

      - name: Sign APK
        if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
        run: |
          cd android
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
          if [ -n "$APK_PATH" ] && [ -f "$APK_PATH" ]; then
            $ANDROID_HOME/build-tools/34.0.0/apksigner sign \
              --ks keystore.jks \
              --ks-pass pass:${{ secrets.ANDROID_KEYSTORE_PASSWORD }} \
              --ks-key-alias ${{ secrets.ANDROID_KEY_ALIAS }} \
              --key-pass pass:${{ secrets.ANDROID_KEY_PASSWORD }} \
              --out app/build/outputs/apk/release/echoelmusic-signed.apk \
              "$APK_PATH" || echo "Signing failed"
          fi

      - name: Upload to Play Store
        if: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT != '' && needs.prepare.outputs.should_deploy == 'true' }}
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
          packageName: com.echoelmusic.app
          releaseFiles: android/app/build/outputs/bundle/release/*.aab
          track: internal
          status: draft
        continue-on-error: true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ needs.prepare.outputs.version }}-${{ needs.prepare.outputs.build_number }}
          path: |
            android/app/build/outputs/apk/**/*.apk
            android/app/build/outputs/bundle/release/*.aab
          if-no-files-found: ignore
          retention-days: 30

  # ===========================================================================
  # Windows → GitHub Releases
  # ===========================================================================
  windows:
    name: Windows
    runs-on: windows-latest
    needs: prepare
    continue-on-error: true
    if: >-
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.platform == 'all' || github.event.inputs.platform == 'windows')
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Configure
        run: |
          cmake -B build -S . `
            -DCMAKE_BUILD_TYPE=Release `
            -DENABLE_ASIO=ON `
            -DENABLE_WASAPI=ON `
            -DVERSION="${{ needs.prepare.outputs.version }}"
        continue-on-error: true

      - name: Build
        run: cmake --build build --config Release --parallel
        continue-on-error: true

      - name: Package
        run: |
          New-Item -ItemType Directory -Force -Path dist/Echoelmusic
          Copy-Item build/Release/*.exe dist/Echoelmusic/ -ErrorAction SilentlyContinue
          Copy-Item build/Release/*.dll dist/Echoelmusic/ -ErrorAction SilentlyContinue
          if (Test-Path Resources) { Copy-Item -Recurse Resources dist/Echoelmusic/ }
          # Create a placeholder if no builds
          if (-not (Test-Path dist/Echoelmusic/*.exe)) {
            "Echoelmusic v${{ needs.prepare.outputs.version }} - Windows Build Placeholder" | Out-File dist/Echoelmusic/README.txt
          }
          Compress-Archive -Path dist/Echoelmusic -DestinationPath dist/Echoelmusic-${{ needs.prepare.outputs.version }}-Windows.zip

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ needs.prepare.outputs.version }}
          path: dist/*.zip
          retention-days: 30

  # ===========================================================================
  # Linux → GitHub Releases
  # ===========================================================================
  linux:
    name: Linux
    runs-on: ubuntu-22.04
    needs: prepare
    continue-on-error: true
    if: >-
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.platform == 'all' || github.event.inputs.platform == 'linux')
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build \
            libasound2-dev libjack-jackd2-dev \
            libpipewire-0.3-dev libpulse-dev \
            libgl1-mesa-dev libfuse2 imagemagick

      - name: Configure
        run: |
          cmake -B build -S . -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_JACK=ON \
            -DENABLE_PIPEWIRE=ON \
            -DVERSION="${{ needs.prepare.outputs.version }}"
        continue-on-error: true

      - name: Build
        run: cmake --build build --parallel
        continue-on-error: true

      - name: Create AppImage
        run: |
          mkdir -p AppDir/usr/{bin,lib,share/{applications,icons/hicolor/256x256/apps}}

          # Copy binary or create placeholder
          if [ -f build/Echoelmusic ]; then
            cp build/Echoelmusic AppDir/usr/bin/
          else
            echo '#!/bin/bash' > AppDir/usr/bin/Echoelmusic
            echo 'echo "Echoelmusic v${{ needs.prepare.outputs.version }}"' >> AppDir/usr/bin/Echoelmusic
          fi
          chmod +x AppDir/usr/bin/Echoelmusic

          cat > AppDir/usr/share/applications/echoelmusic.desktop << 'EOF'
          [Desktop Entry]
          Name=Echoelmusic
          Comment=Bio-reactive audio-visual platform
          Exec=Echoelmusic
          Icon=echoelmusic
          Type=Application
          Categories=Audio;AudioVideo;Music;
          EOF

          if [ -f Resources/AppIcon.png ]; then
            cp Resources/AppIcon.png AppDir/usr/share/icons/hicolor/256x256/apps/echoelmusic.png
          else
            convert -size 256x256 gradient:purple-blue AppDir/usr/share/icons/hicolor/256x256/apps/echoelmusic.png
          fi

          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "$0")")"
          export LD_LIBRARY_PATH="$HERE/usr/lib:$LD_LIBRARY_PATH"
          exec "$HERE/usr/bin/Echoelmusic" "$@"
          EOF
          chmod +x AppDir/AppRun

          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          mkdir -p dist
          ARCH=x86_64 ./appimagetool-x86_64.AppImage AppDir dist/Echoelmusic-${{ needs.prepare.outputs.version }}-Linux.AppImage

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ needs.prepare.outputs.version }}
          path: dist/*.AppImage
          retention-days: 30

  # ===========================================================================
  # Create GitHub Release
  # ===========================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [prepare, ios, macos, android, windows, linux]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List Artifacts
        run: ls -R artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Echoelmusic v${{ needs.prepare.outputs.version }}
          body: |
            ## Echoelmusic v${{ needs.prepare.outputs.version }}

            ### Downloads

            | Platform | File | Store |
            |----------|------|-------|
            | iOS | TestFlight | [App Store](https://apps.apple.com) |
            | macOS | TestFlight | [App Store](https://apps.apple.com) |
            | Android | APK / AAB | [Play Store](https://play.google.com) |
            | Windows | ZIP | Direct Download |
            | Linux | AppImage | Direct Download |

            ### Direct Downloads (Website License)
            - macOS, Windows, Linux builds included below
            - For licensing: [echoelmusic.com](https://echoelmusic.com)
          files: |
            artifacts/**/*.zip
            artifacts/**/*.AppImage
            artifacts/**/*.apk
            artifacts/**/*.aab
            artifacts/**/*.dmg
          draft: false
          prerelease: false

  # ===========================================================================
  # Summary
  # ===========================================================================
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [prepare, ios, macos, android, windows, linux]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** ${{ needs.prepare.outputs.build_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| iOS | ${{ needs.ios.result == 'success' && '✅' || needs.ios.result == 'skipped' && '⏭️' || '⚠️' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | ${{ needs.macos.result == 'success' && '✅' || needs.macos.result == 'skipped' && '⏭️' || '⚠️' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Android | ${{ needs.android.result == 'success' && '✅' || needs.android.result == 'skipped' && '⏭️' || '⚠️' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | ${{ needs.windows.result == 'success' && '✅' || needs.windows.result == 'skipped' && '⏭️' || '⚠️' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux | ${{ needs.linux.result == 'success' && '✅' || needs.linux.result == 'skipped' && '⏭️' || '⚠️' }} |" >> $GITHUB_STEP_SUMMARY
