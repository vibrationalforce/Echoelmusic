# Windows Build Workflow for Echoelmusic
# Uses Swift cross-compilation for Windows
# Reference: https://www.swift.org/download/#releases

name: Windows Build

on:
  push:
    branches: [main, develop]
    paths:
      - 'Sources/**'
      - 'Package.swift'
      - '.github/workflows/windows-build.yml'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

env:
  SWIFT_VERSION: "5.10"

jobs:
  build-windows:
    name: Build for Windows
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Swift for Windows
        run: |
          # Download Swift for Windows
          $swiftUrl = "https://download.swift.org/swift-${{ env.SWIFT_VERSION }}-release/windows10/swift-${{ env.SWIFT_VERSION }}-RELEASE/swift-${{ env.SWIFT_VERSION }}-RELEASE-windows10.exe"
          Invoke-WebRequest -Uri $swiftUrl -OutFile swift-installer.exe

          # Install Swift
          Start-Process -FilePath "swift-installer.exe" -ArgumentList "/silent" -Wait

          # Add to PATH
          $env:Path += ";C:\Library\Developer\Toolchains\unknown-Asserts-development.xctoolchain\usr\bin"

      - name: Verify Swift Installation
        run: |
          swift --version

      - name: Build Package (Debug)
        if: ${{ github.event.inputs.build_type != 'release' }}
        run: |
          swift build -c debug

      - name: Build Package (Release)
        if: ${{ github.event.inputs.build_type == 'release' }}
        run: |
          swift build -c release

      - name: Run Tests
        run: |
          swift test
        continue-on-error: true

      - name: Package Artifacts
        if: success()
        run: |
          mkdir -p artifacts
          cp -r .build/debug/* artifacts/ 2>$null || cp -r .build/release/* artifacts/

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: echoelmusic-windows-${{ github.sha }}
          path: artifacts/
          retention-days: 7

  build-windows-msix:
    name: Build MSIX Package for Microsoft Store
    runs-on: windows-latest
    needs: build-windows
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: echoelmusic-windows-${{ github.sha }}
          path: build/

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      - name: Create MSIX Package
        run: |
          # Create app manifest for Microsoft Store
          @"
          <?xml version="1.0" encoding="utf-8"?>
          <Package xmlns="http://schemas.microsoft.com/appx/manifest/foundation/windows10"
                   xmlns:mp="http://schemas.microsoft.com/appx/2014/phone/manifest"
                   xmlns:uap="http://schemas.microsoft.com/appx/manifest/uap/windows10"
                   IgnorableNamespaces="uap mp">
            <Identity Name="Echoelmusic"
                      Publisher="CN=YourPublisherID"
                      Version="1.0.0.0" />
            <Properties>
              <DisplayName>Echoelmusic</DisplayName>
              <PublisherDisplayName>Your Name</PublisherDisplayName>
              <Logo>Assets\StoreLogo.png</Logo>
            </Properties>
            <Dependencies>
              <TargetDeviceFamily Name="Windows.Desktop" MinVersion="10.0.17763.0" MaxVersionTested="10.0.22621.0" />
            </Dependencies>
            <Resources>
              <Resource Language="en-us" />
              <Resource Language="de-de" />
            </Resources>
            <Applications>
              <Application Id="App"
                           Executable="Echoelmusic.exe"
                           EntryPoint="Windows.FullTrustApplication">
                <uap:VisualElements
                    DisplayName="Echoelmusic"
                    Description="Bio-reactive audio-visual platform"
                    BackgroundColor="transparent"
                    Square150x150Logo="Assets\Square150x150Logo.png"
                    Square44x44Logo="Assets\Square44x44Logo.png">
                  <uap:DefaultTile Wide310x150Logo="Assets\Wide310x150Logo.png" />
                </uap:VisualElements>
              </Application>
            </Applications>
          </Package>
          "@ | Out-File -FilePath "AppxManifest.xml" -Encoding utf8

      - name: Upload MSIX Artifact
        uses: actions/upload-artifact@v4
        with:
          name: echoelmusic-msix-${{ github.sha }}
          path: "*.msix"
          retention-days: 30

  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [build-windows, build-windows-msix]
    if: always()

    steps:
      - name: Build Status Summary
        run: |
          echo "## Windows Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Windows Build | ${{ needs.build-windows.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| MSIX Package | ${{ needs.build-windows-msix.result }} |" >> $GITHUB_STEP_SUMMARY
