# =============================================================================
# Echoelmusic - Apple Universe Deployment Pipeline
# =============================================================================
# Automated Build & TestFlight Upload for ALL Apple Platforms
# Platforms: iOS, macOS, watchOS, tvOS, visionOS
# =============================================================================

name: Apple Universe Deploy

on:
  push:
    branches:
      - main
      - release/*
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ios
          - macos
          - watchos
          - tvos
          - visionos
      upload_to_testflight:
        description: 'Upload to TestFlight'
        required: true
        default: true
        type: boolean

env:
  XCODE_VERSION: '15.2'
  SWIFT_VERSION: '5.9'

# Required GitHub Secrets:
# - APP_STORE_CONNECT_ISSUER_ID
# - APP_STORE_CONNECT_KEY_ID
# - APP_STORE_CONNECT_PRIVATE_KEY
# - APPLE_TEAM_ID

jobs:
  # ===========================================================================
  # Pre-flight Checks
  # ===========================================================================
  preflight:
    name: Pre-flight Validation
    runs-on: macos-14
    outputs:
      version: ${{ steps.version.outputs.version }}
      build_number: ${{ steps.version.outputs.build_number }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract Version Info
        id: version
        run: |
          VERSION=$(grep -A1 'CFBundleShortVersionString' Info.plist | grep string | sed 's/.*<string>\(.*\)<\/string>.*/\1/')
          BUILD=${{ github.run_number }}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION (Build $BUILD)"

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}" ]; then
            echo "âŒ Missing APP_STORE_CONNECT_ISSUER_ID"
            exit 1
          fi
          if [ -z "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" ]; then
            echo "âŒ Missing APP_STORE_CONNECT_KEY_ID"
            exit 1
          fi
          if [ -z "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" ]; then
            echo "âŒ Missing APP_STORE_CONNECT_PRIVATE_KEY"
            exit 1
          fi
          if [ -z "${{ secrets.APPLE_TEAM_ID }}" ]; then
            echo "âŒ Missing APPLE_TEAM_ID"
            exit 1
          fi
          echo "âœ… All required secrets are configured"

  # ===========================================================================
  # iOS Build & Deploy
  # ===========================================================================
  ios:
    name: iOS Build & TestFlight
    runs-on: macos-14
    needs: preflight
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == 'ios' || github.event.inputs.platform == ''
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Select Xcode Version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Setup Ruby & Fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install Fastlane
        run: gem install fastlane

      - name: Setup App Store Connect API Key
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8

      - name: Resolve Swift Dependencies
        run: swift package resolve

      - name: Build iOS App
        run: |
          xcodebuild archive \
            -scheme Echoelmusic \
            -destination 'generic/platform=iOS' \
            -archivePath $PWD/build/Echoelmusic-iOS.xcarchive \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8 \
            -authenticationKeyID ${{ secrets.APP_STORE_CONNECT_KEY_ID }} \
            -authenticationKeyIssuerID ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }} \
            DEVELOPMENT_TEAM=${{ secrets.APPLE_TEAM_ID }} \
            CODE_SIGN_STYLE=Automatic \
            MARKETING_VERSION=${{ needs.preflight.outputs.version }} \
            CURRENT_PROJECT_VERSION=${{ needs.preflight.outputs.build_number }}

      - name: Export iOS IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath $PWD/build/Echoelmusic-iOS.xcarchive \
            -exportOptionsPlist ExportOptions-iOS.plist \
            -exportPath $PWD/build/iOS \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8 \
            -authenticationKeyID ${{ secrets.APP_STORE_CONNECT_KEY_ID }} \
            -authenticationKeyIssuerID ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}

      - name: Upload to TestFlight
        if: github.event.inputs.upload_to_testflight != 'false'
        run: |
          xcrun altool --upload-app \
            --type ios \
            --file "$PWD/build/iOS/Echoelmusic.ipa" \
            --apiKey ${{ secrets.APP_STORE_CONNECT_KEY_ID }} \
            --apiIssuer ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          echo "âœ… iOS uploaded to TestFlight"

      - name: Upload iOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Echoelmusic-iOS-${{ needs.preflight.outputs.version }}
          path: build/iOS/Echoelmusic.ipa
          retention-days: 30

  # ===========================================================================
  # macOS Build & Deploy
  # ===========================================================================
  macos:
    name: macOS Build & TestFlight
    runs-on: macos-14
    needs: preflight
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == 'macos' || github.event.inputs.platform == ''
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Select Xcode Version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Setup App Store Connect API Key
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8

      - name: Resolve Swift Dependencies
        run: swift package resolve

      - name: Build macOS App
        run: |
          xcodebuild archive \
            -scheme Echoelmusic \
            -destination 'generic/platform=macOS' \
            -archivePath $PWD/build/Echoelmusic-macOS.xcarchive \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8 \
            -authenticationKeyID ${{ secrets.APP_STORE_CONNECT_KEY_ID }} \
            -authenticationKeyIssuerID ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }} \
            DEVELOPMENT_TEAM=${{ secrets.APPLE_TEAM_ID }} \
            CODE_SIGN_STYLE=Automatic \
            MARKETING_VERSION=${{ needs.preflight.outputs.version }} \
            CURRENT_PROJECT_VERSION=${{ needs.preflight.outputs.build_number }}

      - name: Export macOS App
        run: |
          xcodebuild -exportArchive \
            -archivePath $PWD/build/Echoelmusic-macOS.xcarchive \
            -exportOptionsPlist ExportOptions-macOS.plist \
            -exportPath $PWD/build/macOS \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8 \
            -authenticationKeyID ${{ secrets.APP_STORE_CONNECT_KEY_ID }} \
            -authenticationKeyIssuerID ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}

      - name: Upload to TestFlight
        if: github.event.inputs.upload_to_testflight != 'false'
        run: |
          xcrun altool --upload-app \
            --type macos \
            --file "$PWD/build/macOS/Echoelmusic.pkg" \
            --apiKey ${{ secrets.APP_STORE_CONNECT_KEY_ID }} \
            --apiIssuer ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          echo "âœ… macOS uploaded to TestFlight"

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Echoelmusic-macOS-${{ needs.preflight.outputs.version }}
          path: build/macOS/
          retention-days: 30

  # ===========================================================================
  # watchOS Build & Deploy
  # ===========================================================================
  watchos:
    name: watchOS Build & TestFlight
    runs-on: macos-14
    needs: preflight
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == 'watchos' || github.event.inputs.platform == ''
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Select Xcode Version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Setup App Store Connect API Key
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8

      - name: Resolve Swift Dependencies
        run: swift package resolve

      - name: Build watchOS App
        run: |
          xcodebuild archive \
            -scheme Echoelmusic \
            -destination 'generic/platform=watchOS' \
            -archivePath $PWD/build/Echoelmusic-watchOS.xcarchive \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8 \
            -authenticationKeyID ${{ secrets.APP_STORE_CONNECT_KEY_ID }} \
            -authenticationKeyIssuerID ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }} \
            DEVELOPMENT_TEAM=${{ secrets.APPLE_TEAM_ID }} \
            CODE_SIGN_STYLE=Automatic \
            MARKETING_VERSION=${{ needs.preflight.outputs.version }} \
            CURRENT_PROJECT_VERSION=${{ needs.preflight.outputs.build_number }}

      - name: Export watchOS App
        run: |
          xcodebuild -exportArchive \
            -archivePath $PWD/build/Echoelmusic-watchOS.xcarchive \
            -exportOptionsPlist ExportOptions-watchOS.plist \
            -exportPath $PWD/build/watchOS \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8 \
            -authenticationKeyID ${{ secrets.APP_STORE_CONNECT_KEY_ID }} \
            -authenticationKeyIssuerID ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}

      - name: Upload to TestFlight (via iOS companion)
        if: github.event.inputs.upload_to_testflight != 'false'
        run: |
          # watchOS apps are bundled with iOS app for TestFlight
          echo "â„¹ï¸ watchOS app will be distributed via iOS companion app"

      - name: Upload watchOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Echoelmusic-watchOS-${{ needs.preflight.outputs.version }}
          path: build/watchOS/
          retention-days: 30

  # ===========================================================================
  # tvOS Build & Deploy
  # ===========================================================================
  tvos:
    name: tvOS Build & TestFlight
    runs-on: macos-14
    needs: preflight
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == 'tvos' || github.event.inputs.platform == ''
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Select Xcode Version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Setup App Store Connect API Key
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8

      - name: Resolve Swift Dependencies
        run: swift package resolve

      - name: Build tvOS App
        run: |
          xcodebuild archive \
            -scheme Echoelmusic \
            -destination 'generic/platform=tvOS' \
            -archivePath $PWD/build/Echoelmusic-tvOS.xcarchive \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8 \
            -authenticationKeyID ${{ secrets.APP_STORE_CONNECT_KEY_ID }} \
            -authenticationKeyIssuerID ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }} \
            DEVELOPMENT_TEAM=${{ secrets.APPLE_TEAM_ID }} \
            CODE_SIGN_STYLE=Automatic \
            MARKETING_VERSION=${{ needs.preflight.outputs.version }} \
            CURRENT_PROJECT_VERSION=${{ needs.preflight.outputs.build_number }}

      - name: Export tvOS App
        run: |
          xcodebuild -exportArchive \
            -archivePath $PWD/build/Echoelmusic-tvOS.xcarchive \
            -exportOptionsPlist ExportOptions-tvOS.plist \
            -exportPath $PWD/build/tvOS \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8 \
            -authenticationKeyID ${{ secrets.APP_STORE_CONNECT_KEY_ID }} \
            -authenticationKeyIssuerID ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}

      - name: Upload to TestFlight
        if: github.event.inputs.upload_to_testflight != 'false'
        run: |
          xcrun altool --upload-app \
            --type appletvos \
            --file "$PWD/build/tvOS/Echoelmusic.ipa" \
            --apiKey ${{ secrets.APP_STORE_CONNECT_KEY_ID }} \
            --apiIssuer ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          echo "âœ… tvOS uploaded to TestFlight"

      - name: Upload tvOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Echoelmusic-tvOS-${{ needs.preflight.outputs.version }}
          path: build/tvOS/
          retention-days: 30

  # ===========================================================================
  # visionOS Build & Deploy
  # ===========================================================================
  visionos:
    name: visionOS Build & TestFlight
    runs-on: macos-14
    needs: preflight
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == 'visionos' || github.event.inputs.platform == ''
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Select Xcode Version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Setup App Store Connect API Key
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8

      - name: Resolve Swift Dependencies
        run: swift package resolve

      - name: Build visionOS App
        run: |
          xcodebuild archive \
            -scheme Echoelmusic \
            -destination 'generic/platform=visionOS' \
            -archivePath $PWD/build/Echoelmusic-visionOS.xcarchive \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8 \
            -authenticationKeyID ${{ secrets.APP_STORE_CONNECT_KEY_ID }} \
            -authenticationKeyIssuerID ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }} \
            DEVELOPMENT_TEAM=${{ secrets.APPLE_TEAM_ID }} \
            CODE_SIGN_STYLE=Automatic \
            MARKETING_VERSION=${{ needs.preflight.outputs.version }} \
            CURRENT_PROJECT_VERSION=${{ needs.preflight.outputs.build_number }}

      - name: Export visionOS App
        run: |
          xcodebuild -exportArchive \
            -archivePath $PWD/build/Echoelmusic-visionOS.xcarchive \
            -exportOptionsPlist ExportOptions-visionOS.plist \
            -exportPath $PWD/build/visionOS \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8 \
            -authenticationKeyID ${{ secrets.APP_STORE_CONNECT_KEY_ID }} \
            -authenticationKeyIssuerID ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}

      - name: Upload to TestFlight
        if: github.event.inputs.upload_to_testflight != 'false'
        run: |
          xcrun altool --upload-app \
            --type visionos \
            --file "$PWD/build/visionOS/Echoelmusic.ipa" \
            --apiKey ${{ secrets.APP_STORE_CONNECT_KEY_ID }} \
            --apiIssuer ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          echo "âœ… visionOS uploaded to TestFlight"

      - name: Upload visionOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Echoelmusic-visionOS-${{ needs.preflight.outputs.version }}
          path: build/visionOS/
          retention-days: 30

  # ===========================================================================
  # Deployment Summary
  # ===========================================================================
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [preflight, ios, macos, watchos, tvos, visionos]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸŽ Apple Universe Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.preflight.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** ${{ needs.preflight.outputs.build_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| iOS | ${{ needs.ios.result == 'success' && 'âœ… Success' || needs.ios.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | ${{ needs.macos.result == 'success' && 'âœ… Success' || needs.macos.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| watchOS | ${{ needs.watchos.result == 'success' && 'âœ… Success' || needs.watchos.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| tvOS | ${{ needs.tvos.result == 'success' && 'âœ… Success' || needs.tvos.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| visionOS | ${{ needs.visionos.result == 'success' && 'âœ… Success' || needs.visionos.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **TestFlight:** Check App Store Connect for builds" >> $GITHUB_STEP_SUMMARY
