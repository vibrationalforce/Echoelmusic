# =============================================================================
# ECHOELMUSIC - PR BUILD CHECK
# =============================================================================
# Runs ONLY on pull requests - validates code compiles before merge
# =============================================================================

name: "PR Build Check"

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  XCODE_VERSION: '16.2'

jobs:
  build-check:
    name: "PR Build Check"
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Info"
        run: |
          echo "=============================================="
          echo "  PR BUILD CHECK"
          echo "=============================================="
          echo "PR: #${{ github.event.pull_request.number }}"
          echo "Title: ${{ github.event.pull_request.title }}"
          echo "Branch: ${{ github.head_ref }} -> ${{ github.base_ref }}"
          echo "=============================================="

      - name: "Validate Project Files"
        run: |
          echo "Checking required files..."
          for file in Package.swift project.yml fastlane/Fastfile; do
            if [ -f "$file" ]; then
              echo "[OK] $file"
            else
              echo "[FAIL] $file missing"
              exit 1
            fi
          done
          echo "All files present."

      - name: "Setup Xcode"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "Install XcodeGen"
        run: |
          brew install xcodegen || true
          xcodegen --version

      - name: "Generate Xcode Project"
        run: |
          # Use placeholder Team ID for CI builds
          sed -i '' 's/DEVELOPMENT_TEAM: ""/DEVELOPMENT_TEAM: "XXXXXXXXXX"/' project.yml
          xcodegen generate --spec project.yml
          echo "Project generated successfully."

      - name: "Build iOS (Simulator)"
        run: |
          echo "Building iOS for Simulator..."
          xcodebuild build \
            -project Echoelmusic.xcodeproj \
            -scheme Echoelmusic \
            -destination 'platform=iOS Simulator,OS=18.2,name=iPhone 16 Pro' \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            -quiet
          echo "[OK] iOS Simulator build succeeded"

      - name: "Build macOS"
        run: |
          echo "Building macOS..."
          xcodebuild build \
            -project Echoelmusic.xcodeproj \
            -scheme Echoelmusic-macOS \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            -quiet
          echo "[OK] macOS build succeeded"

      - name: "Run Tests (iOS Simulator)"
        run: |
          echo "Running iOS tests..."
          xcodebuild test \
            -project Echoelmusic.xcodeproj \
            -scheme Echoelmusic \
            -destination 'platform=iOS Simulator,OS=18.2,name=iPhone 16 Pro' \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            -quiet \
            2>&1 | xcpretty --test || exit 1
          echo "[OK] iOS tests passed"

      - name: "Run Tests (macOS)"
        run: |
          echo "Running macOS tests..."
          xcodebuild test \
            -project Echoelmusic.xcodeproj \
            -scheme Echoelmusic-macOS \
            -destination 'platform=macOS' \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            -quiet \
            2>&1 | xcpretty --test || exit 1
          echo "[OK] macOS tests passed"

      - name: "Summary"
        run: |
          echo "## PR Build Check Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| iOS Build | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS Tests | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS Build | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS Tests | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All builds and tests passed - ready to merge!" >> $GITHUB_STEP_SUMMARY
