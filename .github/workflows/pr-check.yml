# =============================================================================
# ECHOELMUSIC - PR BUILD CHECK
# =============================================================================
# Runs ONLY on pull requests - validates code compiles before merge
# Mirrors the main CI build strategy for consistency
# =============================================================================

name: "PR Build Check"

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  XCODE_VERSION: '26'
  XCODEGEN_VERSION: '2.42.0'

jobs:
  build-check:
    name: "PR Build Check"
    runs-on: macos-15
    timeout-minutes: 45

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Info"
        run: |
          echo "=============================================="
          echo "  PR BUILD CHECK"
          echo "=============================================="
          echo "PR: #${{ github.event.pull_request.number }}"
          echo "Title: ${{ github.event.pull_request.title }}"
          echo "Branch: ${{ github.head_ref }} -> ${{ github.base_ref }}"
          echo "=============================================="

      - name: "Validate Project Files"
        run: |
          echo "Checking required files..."
          for file in Package.swift project.yml; do
            if [ -f "$file" ]; then
              echo "[OK] $file"
            else
              echo "[FAIL] $file missing"
              exit 1
            fi
          done
          echo "All files present."

      - name: "Setup Xcode"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "Cache Swift Package Dependencies"
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-pr-${{ hashFiles('Package.swift', 'Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-pr-
            ${{ runner.os }}-spm-

      - name: "Setup XcodeGen"
        uses: ./.github/actions/setup-xcodegen
        with:
          version: ${{ env.XCODEGEN_VERSION }}

      - name: "Generate Xcode Project"
        run: |
          sed -i '' 's/DEVELOPMENT_TEAM: ""/DEVELOPMENT_TEAM: "XXXXXXXXXX"/' project.yml || true
          xcodegen generate --spec project.yml
          echo "Project generated successfully."

      - name: "Build Guard - Pattern Check"
        run: |
          chmod +x scripts/build-guard.sh
          scripts/build-guard.sh --quick

      - name: "SwiftLint"
        run: |
          if command -v swiftlint &> /dev/null; then
            swiftlint lint --strict --reporter xcode
          else
            brew install swiftlint
            swiftlint lint --strict --reporter xcode
          fi

      - name: "Resolve Swift Package Dependencies"
        run: |
          swift package resolve || true

      - name: "Build iOS (Simulator)"
        run: |
          set -o pipefail
          echo "Building iOS for Simulator..."
          xcodebuild build-for-testing \
            -scheme Echoelmusic \
            -destination 'platform=iOS Simulator,OS=26.0,name=iPhone 16 Pro' \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee build-ios.log | xcpretty || { echo "BUILD FAILED — full log:"; tail -100 build-ios.log; exit 1; }
          echo "[OK] iOS Simulator build succeeded"

      - name: "Build macOS"
        run: |
          set -o pipefail
          echo "Building macOS..."
          xcodebuild build-for-testing \
            -scheme Echoelmusic-macOS \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee build-macos.log | xcpretty || { echo "BUILD FAILED — full log:"; tail -100 build-macos.log; exit 1; }
          echo "[OK] macOS build succeeded"

      - name: "Run Tests (iOS Simulator)"
        run: |
          set -o pipefail
          echo "Running iOS tests..."
          xcodebuild test-without-building \
            -scheme Echoelmusic \
            -destination 'platform=iOS Simulator,OS=26.0,name=iPhone 16 Pro' \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee test-ios.log | xcpretty --test || { echo "TESTS FAILED — full log:"; tail -100 test-ios.log; exit 1; }
          echo "[OK] iOS tests passed"

      - name: "Run Tests (macOS)"
        run: |
          set -o pipefail
          echo "Running macOS tests..."
          xcodebuild test-without-building \
            -scheme Echoelmusic-macOS \
            -destination 'platform=macOS' \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee test-macos.log | xcpretty --test || { echo "TESTS FAILED — full log:"; tail -100 test-macos.log; exit 1; }
          echo "[OK] macOS tests passed"

      - name: "Upload Build Logs (on failure)"
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pr-build-logs
          path: |
            build-ios.log
            build-macos.log
            test-ios.log
            test-macos.log
          retention-days: 7

      - name: "Summary"
        run: |
          echo "## PR Build Check Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| iOS Build | Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS Tests | Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS Build | Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS Tests | Passed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All builds and tests passed - ready to merge!" >> $GITHUB_STEP_SUMMARY
