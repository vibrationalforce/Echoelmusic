# Simplified TestFlight deployment using Fastlane
name: TestFlight Deploy

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - '.github/workflows/testflight.yml'

jobs:
  deploy:
    name: Build & Deploy to TestFlight
    runs-on: macos-14

    # Use repository secrets (not environment secrets)
    env:
      ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
      ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      APPLE_APP_ID: ${{ secrets.APPLE_APP_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug - Check secrets presence
        run: |
          echo "=== Secrets Check ==="
          if [ -n "$ASC_KEY_ID" ]; then
            echo "‚úÖ APP_STORE_CONNECT_KEY_ID is set (length: ${#ASC_KEY_ID})"
          else
            echo "‚ùå APP_STORE_CONNECT_KEY_ID is NOT set"
          fi

          if [ -n "$ASC_ISSUER_ID" ]; then
            echo "‚úÖ APP_STORE_CONNECT_ISSUER_ID is set (length: ${#ASC_ISSUER_ID})"
          else
            echo "‚ùå APP_STORE_CONNECT_ISSUER_ID is NOT set"
          fi

          if [ -n "$ASC_KEY_CONTENT" ]; then
            echo "‚úÖ APP_STORE_CONNECT_PRIVATE_KEY is set (length: ${#ASC_KEY_CONTENT})"
            # Check if it looks like a valid key
            if echo "$ASC_KEY_CONTENT" | grep -q "BEGIN.*PRIVATE KEY"; then
              echo "   Key format: Valid PEM format detected"
            else
              echo "   Key format: WARNING - doesn't look like PEM format"
            fi
          else
            echo "‚ùå APP_STORE_CONNECT_PRIVATE_KEY is NOT set"
          fi

          if [ -n "$APPLE_TEAM_ID" ]; then
            echo "‚úÖ APPLE_TEAM_ID is set (length: ${#APPLE_TEAM_ID})"
          else
            echo "‚ùå APPLE_TEAM_ID is NOT set"
          fi

          if [ -n "$APPLE_APP_ID" ]; then
            echo "‚úÖ APPLE_APP_ID is set"
          else
            echo "‚ö†Ô∏è  APPLE_APP_ID is not set (optional, will be auto-detected)"
          fi

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        run: |
          if [ -f "project.yml" ]; then
            echo "Generating Xcode project with XcodeGen..."
            xcodegen generate
          else
            echo "No project.yml found, checking for existing project..."
            ls -la *.xcodeproj 2>/dev/null || echo "No .xcodeproj found"
          fi

      - name: Install Fastlane
        run: |
          gem install fastlane -N
          fastlane --version

      - name: Build & Upload to TestFlight
        run: |
          cd $GITHUB_WORKSPACE
          fastlane ios beta
        env:
          FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 120

      - name: Success
        if: success()
        run: echo "üéâ Successfully uploaded to TestFlight!"

      - name: Failure Info
        if: failure()
        run: |
          echo "‚ùå Build or upload failed"
          echo "Check the logs above for details"
          echo ""
          echo "Common issues:"
          echo "1. Secrets not configured correctly"
          echo "2. Bundle ID mismatch"
          echo "3. Missing provisioning profile"
          echo "4. App not registered in App Store Connect"
