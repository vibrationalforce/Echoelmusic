# TestFlight deployment using Fastlane
# Secrets required: APP_STORE_CONNECT_KEY_ID, APP_STORE_CONNECT_ISSUER_ID,
#                   APP_STORE_CONNECT_PRIVATE_KEY, APPLE_TEAM_ID
name: TestFlight Deploy

on:
  workflow_dispatch:

jobs:
  deploy:
    name: Build & Deploy to TestFlight
    runs-on: macos-14

    env:
      ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
      ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug - Check secrets presence
        run: |
          echo "=== Secrets Check ==="
          MISSING=false

          if [ -n "$ASC_KEY_ID" ]; then
            echo "‚úÖ APP_STORE_CONNECT_KEY_ID is set (${#ASC_KEY_ID} chars)"
          else
            echo "‚ùå APP_STORE_CONNECT_KEY_ID is NOT set"
            MISSING=true
          fi

          if [ -n "$ASC_ISSUER_ID" ]; then
            echo "‚úÖ APP_STORE_CONNECT_ISSUER_ID is set (${#ASC_ISSUER_ID} chars)"
          else
            echo "‚ùå APP_STORE_CONNECT_ISSUER_ID is NOT set"
            MISSING=true
          fi

          if [ -n "$ASC_KEY_CONTENT" ]; then
            echo "‚úÖ APP_STORE_CONNECT_PRIVATE_KEY is set (${#ASC_KEY_CONTENT} chars)"
            if echo "$ASC_KEY_CONTENT" | grep -q "BEGIN.*PRIVATE KEY"; then
              echo "   ‚úÖ Key format looks valid (PEM)"
            else
              echo "   ‚ö†Ô∏è Key format might be wrong"
            fi
          else
            echo "‚ùå APP_STORE_CONNECT_PRIVATE_KEY is NOT set"
            MISSING=true
          fi

          if [ -n "$APPLE_TEAM_ID" ]; then
            echo "‚úÖ APPLE_TEAM_ID is set (${#APPLE_TEAM_ID} chars)"
          else
            echo "‚ùå APPLE_TEAM_ID is NOT set"
            MISSING=true
          fi

          if [ "$MISSING" = true ]; then
            echo ""
            echo "‚ùå Some secrets are missing!"
            echo "Go to: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"
            exit 1
          fi

          echo ""
          echo "‚úÖ All required secrets are configured!"

      - name: Setup Xcode 15.4
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Set Development Team in project.yml
        run: |
          echo "Setting DEVELOPMENT_TEAM to $APPLE_TEAM_ID"
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"$APPLE_TEAM_ID\"/" project.yml
          grep "DEVELOPMENT_TEAM" project.yml

      - name: Generate Xcode project
        run: |
          echo "Generating Xcode project with XcodeGen..."
          xcodegen generate
          echo ""
          echo "Generated project structure:"
          ls -la *.xcodeproj

      - name: Install Fastlane
        run: |
          gem install fastlane -N
          fastlane --version

      - name: Build & Upload to TestFlight
        run: fastlane ios beta
        env:
          FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 180

      - name: Upload Build Log on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: ~/Library/Logs/gym/
          retention-days: 7

      - name: Show Build Errors on Failure
        if: failure()
        run: |
          echo "=== Last 500 lines of build log ==="
          if [ -f ~/Library/Logs/gym/Echoelmusic-Echoelmusic.log ]; then
            tail -500 ~/Library/Logs/gym/Echoelmusic-Echoelmusic.log
          else
            echo "No build log found"
            ls -la ~/Library/Logs/gym/ || echo "gym log directory not found"
          fi

      - name: Success
        if: success()
        run: |
          echo "üéâ Successfully uploaded to TestFlight!"
          echo "Check App Store Connect for the new build."

      - name: Failure Info
        if: failure()
        run: |
          echo "‚ùå Build or upload failed"
          echo ""
          echo "Common issues:"
          echo "1. Secrets not configured correctly"
          echo "2. Bundle ID mismatch (should be com.echoelmusic.app)"
          echo "3. App not registered in App Store Connect"
          echo "4. Team ID doesn't match App Store Connect account"
          echo ""
          echo "Check the logs above for specific error messages."
