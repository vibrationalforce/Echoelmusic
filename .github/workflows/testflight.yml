# =============================================================================
# ECHOELMUSIC - TESTFLIGHT DEPLOYMENT
# =============================================================================
# Pure API Key Auth + xcodebuild direct (no Fastlane build_app)
# xcodebuild archive + exportArchive with -allowProvisioningUpdates
# Fastlane used ONLY for upload_to_testflight
# =============================================================================

name: "TestFlight"

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to deploy'
        required: true
        default: 'ios'
        type: choice
        options:
          - ios
          - macos
          - watchos
          - tvos
          - visionos
          - all
      clean_build:
        description: 'Force clean build'
        required: false
        default: false
        type: boolean
      skip_tests:
        description: 'Skip pre-flight tests'
        required: false
        default: true
        type: boolean
      build_only:
        description: 'Build only (no TestFlight upload) - for compile testing'
        required: false
        default: false
        type: boolean
      skip_compile_check:
        description: 'Skip simulator compile check'
        required: false
        default: false
        type: boolean

concurrency:
  group: testflight-${{ github.event.inputs.platform }}-${{ github.ref }}
  cancel-in-progress: false

env:
  XCODE_VERSION: '16.2'
  BUILD_NUMBER: ${{ github.run_number }}
  CLEAN_BUILD: ${{ github.event.inputs.clean_build }}

jobs:
  # ===========================================================================
  # PREFLIGHT
  # ===========================================================================
  preflight:
    name: "Preflight"
    runs-on: ubuntu-latest
    timeout-minutes: 3
    outputs:
      ready: ${{ steps.validate.outputs.ready }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "Validate Secrets"
        id: validate
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set +e
          ERRORS=0
          echo "=== TESTFLIGHT PREFLIGHT ==="
          echo "Platform: ${{ github.event.inputs.platform }} | Build: ${{ github.run_number }}"

          [ -z "$ASC_KEY_ID" ] && echo "[FAIL] KEY_ID" && ERRORS=$((ERRORS+1)) || echo "[OK] KEY_ID (${#ASC_KEY_ID} chars)"
          [ -z "$ASC_ISSUER_ID" ] && echo "[FAIL] ISSUER_ID" && ERRORS=$((ERRORS+1)) || echo "[OK] ISSUER_ID (${#ASC_ISSUER_ID} chars)"
          [ -z "$ASC_KEY" ] && echo "[FAIL] PRIVATE_KEY" && ERRORS=$((ERRORS+1)) || echo "[OK] PRIVATE_KEY (${#ASC_KEY} chars)"
          [ -z "$TEAM_ID" ] && echo "[FAIL] TEAM_ID" && ERRORS=$((ERRORS+1)) || echo "[OK] TEAM_ID (${#TEAM_ID} chars)"

          for f in Package.swift project.yml fastlane/Fastfile fastlane/Appfile; do
            [ -f "$f" ] && echo "[OK] $f" || { echo "[FAIL] $f missing"; ERRORS=$((ERRORS+1)); }
          done

          if [ $ERRORS -gt 0 ]; then
            echo "FAILED: $ERRORS errors"
            echo "ready=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "PASSED"
          echo "ready=true" >> $GITHUB_OUTPUT

  # ===========================================================================
  # COMPILE CHECK
  # ===========================================================================
  compile_check:
    name: "Compile Check"
    runs-on: macos-15
    needs: preflight
    if: needs.preflight.outputs.ready == 'true' && github.event.inputs.skip_compile_check != 'true'
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "Install iOS Simulator Runtime"
        run: |
          echo "=== Xcode version ==="
          xcodebuild -version
          echo "=== Available runtimes ==="
          xcrun simctl runtime list 2>/dev/null || true
          echo "=== Checking if iOS 18.2 simulator is available ==="
          # Check if correct runtime is already installed
          SDK_BUILD=$(xcodebuild -version -sdk iphonesimulator | grep -i "ProductBuildVersion" | awk '{print $2}')
          echo "Required SDK build: $SDK_BUILD"
          if xcrun simctl runtime list 2>/dev/null | grep -q "$SDK_BUILD"; then
            echo "Matching simulator runtime already installed"
          else
            echo "Installing iOS simulator runtime (build: $SDK_BUILD)..."
            xcodebuild -downloadPlatform iOS -buildVersion "$SDK_BUILD" 2>&1 || {
              echo "Specific version failed, trying generic download..."
              xcodebuild -downloadPlatform iOS 2>&1 || true
            }
          fi
          echo "=== Runtimes after install ==="
          xcrun simctl runtime list 2>/dev/null || true

      - name: "Cache Swift PM"
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
          key: ${{ runner.os }}-spm-compile-${{ hashFiles('Package.swift', 'Package.resolved') }}
          restore-keys: ${{ runner.os }}-spm-compile-

      - name: "Install XcodeGen & Generate Project"
        run: |
          brew install xcodegen || true
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"PLACEHOLDER1\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ env.BUILD_NUMBER }}/" project.yml
          xcodegen generate --spec project.yml

      - name: "Compile (iOS device SDK, no signing)"
        run: |
          set +eo pipefail
          xcodebuild build \
            -project Echoelmusic.xcodeproj \
            -scheme Echoelmusic \
            -destination "generic/platform=iOS" \
            -configuration Release \
            -derivedDataPath ./build/DerivedData \
            -skipPackagePluginValidation \
            CODE_SIGNING_ALLOWED=NO CODE_SIGN_IDENTITY="" \
            COMPILER_INDEX_STORE_ENABLE=NO \
            ONLY_ACTIVE_ARCH=NO \
            SUPPORTED_PLATFORMS=iphoneos \
            2>&1 | tee /tmp/compile.log
          RESULT=${PIPESTATUS[0]}
          set -eo pipefail
          if [ $RESULT -ne 0 ]; then
            echo "=== COMPILE FAILED (exit $RESULT) ==="
            # Write errors as GitHub annotations (visible via check-runs API)
            SWIFT_ERRORS=$(grep -E ': error: ' /tmp/compile.log | head -20 | tr '\n' ' ||| ' || true)
            echo "::error title=Swift Compile Errors::${SWIFT_ERRORS:-NO_SWIFT_ERRORS_FOUND}"
            LAST_LINES=$(tail -30 /tmp/compile.log | tr '\n' ' ||| ' || true)
            echo "::error title=Compile Tail::${LAST_LINES}"
            # Also write to step summary
            echo "## Compile Failed (exit $RESULT)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -E "error:" /tmp/compile.log | head -40 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "### Last 50 lines" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 /tmp/compile.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: compile-check-log
          path: /tmp/compile.log
          retention-days: 3

  # ===========================================================================
  # iOS DEPLOYMENT
  # ===========================================================================
  ios:
    name: "iOS"
    runs-on: macos-15
    needs: [preflight, compile_check]
    if: |
      always() &&
      needs.preflight.outputs.ready == 'true' &&
      (needs.compile_check.result == 'success' || needs.compile_check.result == 'skipped') &&
      (github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'all') &&
      github.event.inputs.build_only != 'true'
    timeout-minutes: 180

    steps:
      - uses: actions/checkout@v4
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "Install iOS Simulator Runtime"
        run: |
          SDK_BUILD=$(xcodebuild -version -sdk iphonesimulator | grep -i "ProductBuildVersion" | awk '{print $2}')
          echo "Required SDK build: $SDK_BUILD"
          if xcrun simctl runtime list 2>/dev/null | grep -q "$SDK_BUILD"; then
            echo "Matching simulator runtime already installed"
          else
            echo "Installing iOS simulator runtime (build: $SDK_BUILD)..."
            xcodebuild -downloadPlatform iOS -buildVersion "$SDK_BUILD" 2>&1 || {
              echo "Specific version failed, trying generic download..."
              xcodebuild -downloadPlatform iOS 2>&1 || true
            }
          fi

      - name: "Cache Swift PM"
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
          key: ${{ runner.os }}-spm-ios-${{ hashFiles('Package.swift', 'Package.resolved') }}
          restore-keys: ${{ runner.os }}-spm-ios-

      - name: "Cache DerivedData"
        uses: actions/cache@v4
        with:
          path: build/DerivedData
          key: ${{ runner.os }}-derived-ios-${{ hashFiles('project.yml') }}
          restore-keys: ${{ runner.os }}-derived-ios-

      - name: "Install Tools & Generate Project"
        run: |
          brew install xcodegen || true
          gem install fastlane:2.225.0 -N --no-document
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ env.BUILD_NUMBER }}/" project.yml
          xcodegen generate --spec project.yml

      - name: "Setup API Key & Keychain"
        env:
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        run: |
          # Write API key to disk
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$ASC_KEY_CONTENT" > ~/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8
          chmod 600 ~/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8

          # Create fresh empty keychain (avoids stale cert conflicts)
          KEYCHAIN_PATH="$HOME/Library/Keychains/build.keychain-db"
          security create-keychain -p "" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_PATH"
          echo "Fresh keychain ready"

      - name: "Setup Signing Certificates"
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set +eo pipefail
          fastlane ios setup_signing 2>&1 | tee /tmp/signing.log
          RESULT=${PIPESTATUS[0]}
          set -eo pipefail
          if [ $RESULT -ne 0 ]; then
            ERRORS=$(tail -30 /tmp/signing.log | tr '\n' ' | ')
            echo "::error title=Signing Setup Failed::${ERRORS}"
            exit 1
          fi

      - name: "Archive"
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          API_KEY_PATH="$HOME/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8"
          xcodebuild -version
          echo "=== Starting Archive ==="

          set +eo pipefail
          xcodebuild archive \
            -project Echoelmusic.xcodeproj \
            -scheme Echoelmusic \
            -destination "generic/platform=iOS" \
            -archivePath ./build/Echoelmusic.xcarchive \
            -configuration Release \
            -derivedDataPath ./build/DerivedData \
            -allowProvisioningUpdates \
            -authenticationKeyIssuerID "$ASC_ISSUER_ID" \
            -authenticationKeyID "$ASC_KEY_ID" \
            -authenticationKeyPath "$API_KEY_PATH" \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
            CODE_SIGN_STYLE=Automatic \
            COMPILER_INDEX_STORE_ENABLE=NO \
            SUPPORTED_PLATFORMS=iphoneos \
            2>&1 | tee /tmp/archive.log
          RESULT=${PIPESTATUS[0]}
          set -eo pipefail

          if [ $RESULT -ne 0 ]; then
            echo "=== ARCHIVE FAILED (exit $RESULT) ==="
            # Extract Swift compile errors specifically (|| true to avoid pipefail exit)
            SWIFT_ERRORS=$(grep -E ': error: ' /tmp/archive.log | head -20 | tr '\n' ' ||| ' || true)
            echo "::error title=Swift Errors::${SWIFT_ERRORS:-NO_SWIFT_ERRORS_FOUND}"
            # Write errors as GitHub annotations (visible via API)
            LAST_LINES=$(tail -30 /tmp/archive.log | tr '\n' ' | ')
            echo "::error title=Archive Failed::${LAST_LINES}"
            ERRORS=$(grep -iE "error:|failed|signing|provision|certificate|not found" /tmp/archive.log | tail -10 | tr '\n' ' | ' || true)
            echo "::error title=Build Errors::${ERRORS:-NO_ERRORS_MATCHED}"
            # Also write full tail to step summary
            echo "## Archive Failed (exit $RESULT)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            { grep -E ': error: |: warning: .*(deprecated|unavailable)' /tmp/archive.log | head -30 || true; } >> $GITHUB_STEP_SUMMARY
            echo '---' >> $GITHUB_STEP_SUMMARY
            tail -50 /tmp/archive.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "=== ARCHIVE SUCCESSFUL ==="

      - name: "Export IPA"
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          API_KEY_PATH="$HOME/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8"

          cat > /tmp/ExportOptions.plist << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>${{ secrets.APPLE_TEAM_ID }}</string>
              <key>signingStyle</key>
              <string>automatic</string>
              <key>uploadSymbols</key>
              <true/>
              <key>destination</key>
              <string>export</string>
          </dict>
          </plist>
          PLIST

          set +eo pipefail
          xcodebuild -exportArchive \
            -archivePath ./build/Echoelmusic.xcarchive \
            -exportPath ./build \
            -exportOptionsPlist /tmp/ExportOptions.plist \
            -allowProvisioningUpdates \
            -authenticationKeyIssuerID "$ASC_ISSUER_ID" \
            -authenticationKeyID "$ASC_KEY_ID" \
            -authenticationKeyPath "$API_KEY_PATH" \
            2>&1 | tee /tmp/export.log
          RESULT=${PIPESTATUS[0]}
          set -eo pipefail

          if [ $RESULT -ne 0 ]; then
            echo ""
            echo "=== EXPORT FAILED (exit code $RESULT) ==="
            tail -50 /tmp/export.log
            exit 1
          fi

          echo "=== EXPORT SUCCESSFUL ==="
          ls -la ./build/*.ipa 2>/dev/null || echo "No IPA found"

      - name: "Inspect IPA Icons"
        run: |
          IPA=$(ls "$(pwd)"/build/*.ipa 2>/dev/null | head -1)
          [ -z "$IPA" ] && { echo "No IPA to inspect"; exit 0; }
          mkdir -p /tmp/ipa_inspect
          unzip -o "$IPA" -d /tmp/ipa_inspect > /dev/null 2>&1
          APP_DIR=$(ls -d /tmp/ipa_inspect/Payload/*.app 2>/dev/null | head -1)
          [ -z "$APP_DIR" ] && { echo "::warning title=IPA Debug::No .app in IPA"; exit 0; }

          # Check for icons
          ICONS=$(ls "$APP_DIR"/AppIcon* 2>/dev/null | head -20 || echo "NONE")
          ASSETS=$(ls -la "$APP_DIR/Assets.car" 2>/dev/null || echo "NO Assets.car")
          PLIST_ICONS=$(/usr/libexec/PlistBuddy -c "Print :CFBundleIcons" "$APP_DIR/Info.plist" 2>&1 || echo "NO CFBundleIcons in plist")
          PLIST_NAME=$(/usr/libexec/PlistBuddy -c "Print :CFBundleIcons:CFBundlePrimaryIcon:CFBundleIconName" "$APP_DIR/Info.plist" 2>&1 || echo "NO CFBundleIconName")
          PLIST_FILES=$(/usr/libexec/PlistBuddy -c "Print :CFBundleIcons:CFBundlePrimaryIcon:CFBundleIconFiles" "$APP_DIR/Info.plist" 2>&1 || echo "NO CFBundleIconFiles")
          ALL_ICONS=$(find "$APP_DIR" -maxdepth 2 -name "*[Ii]con*" -o -name "*[Aa]pp[Ii]con*" 2>/dev/null | head -20 || echo "NONE")

          echo "::warning title=IPA Icon Scan::Icons at root: ${ICONS} | Assets.car: ${ASSETS} | CFBundleIconName: ${PLIST_NAME} | CFBundleIconFiles: ${PLIST_FILES}"
          echo "::warning title=IPA All Icons::${ALL_ICONS}"
          echo "--- Detailed Info.plist Icons ---"
          echo "$PLIST_ICONS"
          rm -rf /tmp/ipa_inspect

      - name: "Inspect Extension Bundles"
        run: |
          IPA=$(ls "$(pwd)"/build/*.ipa 2>/dev/null | head -1)
          [ -z "$IPA" ] && { echo "No IPA to inspect"; exit 0; }
          mkdir -p /tmp/ext_inspect
          unzip -o "$IPA" -d /tmp/ext_inspect > /dev/null 2>&1
          APP_DIR=$(ls -d /tmp/ext_inspect/Payload/*.app 2>/dev/null | head -1)
          [ -z "$APP_DIR" ] && { echo "::warning::No .app in IPA"; exit 0; }

          echo "=== PlugIns Directory ==="
          ls -laR "$APP_DIR/PlugIns/" 2>/dev/null || echo "No PlugIns directory"

          echo ""
          echo "=== Extension Bundle Validation ==="
          for APPEX in "$APP_DIR"/PlugIns/*.appex; do
            [ -d "$APPEX" ] || continue
            EXT_NAME=$(basename "$APPEX")
            echo "--- $EXT_NAME ---"

            # Check Info.plist exists
            if [ -f "$APPEX/Info.plist" ]; then
              echo "  Info.plist: OK"
              BUNDLE_TYPE=$(/usr/libexec/PlistBuddy -c "Print :CFBundlePackageType" "$APPEX/Info.plist" 2>&1 || echo "MISSING")
              EXT_POINT=$(/usr/libexec/PlistBuddy -c "Print :NSExtension:NSExtensionPointIdentifier" "$APPEX/Info.plist" 2>&1 || echo "MISSING")
              PRINCIPAL=$(/usr/libexec/PlistBuddy -c "Print :NSExtension:NSExtensionPrincipalClass" "$APPEX/Info.plist" 2>&1 || echo "MISSING")
              echo "  CFBundlePackageType: $BUNDLE_TYPE"
              echo "  NSExtensionPointIdentifier: $EXT_POINT"
              echo "  NSExtensionPrincipalClass: $PRINCIPAL"
            else
              echo "  Info.plist: MISSING!"
              echo "::error title=Missing Info.plist::Extension $EXT_NAME has no Info.plist"
            fi

            # Check binary
            BIN_NAME="${EXT_NAME%.appex}"
            if [ -f "$APPEX/$BIN_NAME" ]; then
              MACHO_TYPE=$(file "$APPEX/$BIN_NAME" | head -1)
              echo "  Binary: $MACHO_TYPE"
              # Check code signature
              codesign -dvv "$APPEX/$BIN_NAME" 2>&1 | head -5 || echo "  Code signature: INVALID"
            else
              echo "  Binary '$BIN_NAME': MISSING!"
              echo "::error title=Missing Binary::Extension $EXT_NAME has no binary"
            fi

            # Check _CodeSignature
            if [ -d "$APPEX/_CodeSignature" ]; then
              echo "  _CodeSignature: OK"
            else
              echo "  _CodeSignature: MISSING!"
            fi
            echo ""
          done

          rm -rf /tmp/ext_inspect

      - name: "Validate IPA"
        continue-on-error: true
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          IPA=$(ls "$(pwd)"/build/*.ipa 2>/dev/null | head -1)
          [ -z "$IPA" ] && { echo "::warning::No IPA found, skipping validation"; exit 0; }
          API_KEY_PATH="$HOME/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8"

          echo "=== Validating IPA with Apple ==="
          set +eo pipefail
          # Use altool for iOS IPA validation (still functional; migrate to
          # App Store Connect API when Apple removes altool from Xcode)
          xcrun altool --validate-app \
            -f "$IPA" \
            -t ios \
            --apiKey "$ASC_KEY_ID" \
            --apiIssuer "$ASC_ISSUER_ID" \
            2>&1 | tee /tmp/validate.log
          RESULT=${PIPESTATUS[0]}
          set -eo pipefail

          if [ $RESULT -ne 0 ]; then
            ERRORS=$(grep -iE "error|invalid|not permitted|rejected" /tmp/validate.log | head -10 | tr '\n' ' ||| ' || true)
            echo "::warning title=IPA Validation Warning::${ERRORS}"
            echo "## IPA Validation Warning" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/validate.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "Proceeding to upload despite validation warning..."
            exit 1
          fi
          echo "=== IPA VALIDATION PASSED ==="

      - name: "Upload to TestFlight"
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          echo "=== Files in ./build/ ==="
          ls -la ./build/ 2>/dev/null || echo "No build directory"
          IPA=$(ls "$(pwd)"/build/*.ipa 2>/dev/null | head -1)
          if [ -z "$IPA" ]; then
            echo "::error title=No IPA::No IPA found in $(pwd)/build/"
            exit 1
          fi

          # Debug: inspect IPA contents for icons
          echo "=== IPA Icon Debug ==="
          mkdir -p /tmp/ipa_debug
          unzip -o "$IPA" -d /tmp/ipa_debug > /dev/null 2>&1
          echo "--- Info.plist CFBundleIcons ---"
          /usr/libexec/PlistBuddy -c "Print :CFBundleIcons" /tmp/ipa_debug/Payload/*.app/Info.plist 2>&1 || echo "No CFBundleIcons key"
          echo "--- Icon files in .app ---"
          ls -la /tmp/ipa_debug/Payload/*.app/AppIcon* 2>/dev/null || echo "No AppIcon files at root"
          ls -la /tmp/ipa_debug/Payload/*.app/Assets.car 2>/dev/null || echo "No Assets.car"
          echo "--- actool-generated icon entries ---"
          /usr/libexec/PlistBuddy -c "Print :CFBundleIcons:CFBundlePrimaryIcon:CFBundleIconFiles" /tmp/ipa_debug/Payload/*.app/Info.plist 2>&1 || echo "No icon files in plist"
          echo "--- All files matching Icon/icon ---"
          find /tmp/ipa_debug/Payload/*.app -maxdepth 1 -name "*[Ii]con*" 2>/dev/null || echo "No icon files found"
          echo "=== End Icon Debug ==="
          rm -rf /tmp/ipa_debug

          echo "Uploading $IPA to TestFlight..."
          set +eo pipefail
          IPA_PATH="$IPA" fastlane ios upload 2>&1 | tee /tmp/upload.log
          RESULT=${PIPESTATUS[0]}
          set -eo pipefail
          if [ $RESULT -ne 0 ]; then
            ERRORS=$(tail -30 /tmp/upload.log | tr '\n' ' | ')
            echo "::error title=Upload Failed::${ERRORS}"
            exit 1
          fi
          echo "=== UPLOAD SUCCESSFUL ==="

      - name: "Error Summary"
        if: failure()
        run: |
          echo "## iOS Deploy Failed" >> $GITHUB_STEP_SUMMARY
          for logfile in /tmp/archive.log /tmp/export.log /tmp/upload.log; do
            if [ -f "$logfile" ]; then
              echo "### $(basename $logfile)" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              tail -100 "$logfile" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: "Upload Build Logs"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-logs
          path: |
            /tmp/archive.log
            /tmp/export.log
            build/logs/**
            build/*.ipa
          retention-days: 7
          if-no-files-found: warn

      - name: "Cleanup"
        if: always()
        run: |
          rm -rf ~/.appstoreconnect/private_keys 2>/dev/null || true
          security delete-keychain "$HOME/Library/Keychains/build.keychain-db" 2>/dev/null || true

  # ===========================================================================
  # macOS DEPLOYMENT
  # ===========================================================================
  macos:
    name: "macOS"
    runs-on: macos-15
    needs: [preflight, compile_check]
    if: |
      always() &&
      needs.preflight.outputs.ready == 'true' &&
      (needs.compile_check.result == 'success' || needs.compile_check.result == 'skipped') &&
      (github.event.inputs.platform == 'macos' || github.event.inputs.platform == 'all') &&
      github.event.inputs.build_only != 'true'
    timeout-minutes: 180

    steps:
      - uses: actions/checkout@v4
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "Cache Swift PM"
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
          key: ${{ runner.os }}-spm-macos-${{ hashFiles('Package.swift', 'Package.resolved') }}
          restore-keys: ${{ runner.os }}-spm-macos-

      - name: "Install Tools & Generate Project"
        run: |
          brew install xcodegen || true
          gem install fastlane:2.225.0 -N --no-document
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ env.BUILD_NUMBER }}/" project.yml
          xcodegen generate --spec project.yml

      - name: "Setup API Key & Keychain"
        env:
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$ASC_KEY_CONTENT" > ~/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8
          chmod 600 ~/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8

          # Create fresh empty keychain (avoids stale cert conflicts)
          KEYCHAIN_PATH="$HOME/Library/Keychains/build.keychain-db"
          security create-keychain -p "" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_PATH"
          echo "Fresh keychain ready"

      - name: "Setup Signing Certificates"
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set +eo pipefail
          fastlane mac setup_signing 2>&1 | tee /tmp/signing.log
          RESULT=${PIPESTATUS[0]}
          set -eo pipefail
          if [ $RESULT -ne 0 ]; then
            ERRORS=$(tail -30 /tmp/signing.log | tr '\n' ' | ')
            echo "::error title=Signing Setup Failed::${ERRORS}"
            exit 1
          fi

      - name: "Archive"
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          API_KEY_PATH="$HOME/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8"
          set +eo pipefail
          xcodebuild archive \
            -project Echoelmusic.xcodeproj \
            -scheme Echoelmusic-macOS \
            -destination "generic/platform=macOS" \
            -archivePath ./build/Echoelmusic-macOS.xcarchive \
            -configuration Release \
            -derivedDataPath ./build/DerivedData \
            -allowProvisioningUpdates \
            -authenticationKeyIssuerID "$ASC_ISSUER_ID" \
            -authenticationKeyID "$ASC_KEY_ID" \
            -authenticationKeyPath "$API_KEY_PATH" \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
            CODE_SIGN_STYLE=Automatic \
            COMPILER_INDEX_STORE_ENABLE=NO \
            2>&1 | tee /tmp/archive.log
          RESULT=${PIPESTATUS[0]}
          set -eo pipefail
          if [ $RESULT -ne 0 ]; then
            echo "=== ARCHIVE FAILED (exit $RESULT) ==="
            LAST_LINES=$(tail -30 /tmp/archive.log | tr '\n' ' | ')
            echo "::error title=macOS Archive Failed::${LAST_LINES}"
            ERRORS=$(grep -iE "error:|failed|signing|provision|certificate|not found" /tmp/archive.log | tail -10 | tr '\n' ' | ')
            echo "::error title=macOS Build Errors::${ERRORS}"
            echo "## macOS Archive Failed (exit $RESULT)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 /tmp/archive.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "=== ARCHIVE SUCCESSFUL ==="

      - name: "Export"
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          API_KEY_PATH="$HOME/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8"
          cat > /tmp/ExportOptions.plist << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key><string>app-store</string>
              <key>teamID</key><string>${{ secrets.APPLE_TEAM_ID }}</string>
              <key>signingStyle</key><string>automatic</string>
              <key>uploadSymbols</key><true/>
              <key>destination</key><string>export</string>
          </dict>
          </plist>
          PLIST
          set +eo pipefail
          xcodebuild -exportArchive \
            -archivePath ./build/Echoelmusic-macOS.xcarchive \
            -exportPath ./build \
            -exportOptionsPlist /tmp/ExportOptions.plist \
            -allowProvisioningUpdates \
            -authenticationKeyIssuerID "$ASC_ISSUER_ID" \
            -authenticationKeyID "$ASC_KEY_ID" \
            -authenticationKeyPath "$API_KEY_PATH" \
            2>&1 | tee /tmp/export.log
          RESULT=${PIPESTATUS[0]}
          set -eo pipefail
          [ $RESULT -ne 0 ] && { echo "=== EXPORT FAILED ==="; tail -50 /tmp/export.log; exit 1; }

      - name: "Upload to TestFlight"
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: fastlane mac upload

      - name: "Error Summary"
        if: failure()
        run: |
          echo "## macOS Deploy Failed" >> $GITHUB_STEP_SUMMARY
          for f in /tmp/archive.log /tmp/export.log; do
            [ -f "$f" ] && { echo "### $(basename $f)" >> $GITHUB_STEP_SUMMARY; echo '```' >> $GITHUB_STEP_SUMMARY; tail -100 "$f" >> $GITHUB_STEP_SUMMARY; echo '```' >> $GITHUB_STEP_SUMMARY; }
          done

      - if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-build-logs
          path: |
            /tmp/archive.log
            /tmp/export.log
            build/logs/**
          retention-days: 7
          if-no-files-found: warn

      - name: "Cleanup"
        if: always()
        run: |
          rm -rf ~/.appstoreconnect/private_keys 2>/dev/null || true
          security delete-keychain "$HOME/Library/Keychains/build.keychain-db" 2>/dev/null || true

  # ===========================================================================
  # watchOS DEPLOYMENT
  # ===========================================================================
  watchos:
    name: "watchOS"
    runs-on: macos-15
    needs: [preflight, compile_check]
    if: |
      always() &&
      needs.preflight.outputs.ready == 'true' &&
      (needs.compile_check.result == 'success' || needs.compile_check.result == 'skipped') &&
      (github.event.inputs.platform == 'watchos' || github.event.inputs.platform == 'all') &&
      github.event.inputs.build_only != 'true'
    timeout-minutes: 180

    steps:
      - uses: actions/checkout@v4
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      - uses: actions/cache@v4
        with:
          path: ~/.swiftpm
          key: ${{ runner.os }}-spm-watchos-${{ hashFiles('Package.swift') }}

      - name: "Install Tools & Generate Project"
        run: |
          brew install xcodegen || true
          gem install fastlane:2.225.0 -N --no-document
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ env.BUILD_NUMBER }}/" project.yml
          xcodegen generate --spec project.yml

      - name: "Setup API Key & Keychain"
        env:
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$ASC_KEY_CONTENT" > ~/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8
          chmod 600 ~/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8

          # Create fresh empty keychain (avoids stale cert conflicts)
          KEYCHAIN_PATH="$HOME/Library/Keychains/build.keychain-db"
          security create-keychain -p "" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_PATH"
          echo "Fresh keychain ready"

      - name: "Setup Signing Certificates"
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set +eo pipefail
          fastlane ios setup_signing 2>&1 | tee /tmp/signing.log
          RESULT=${PIPESTATUS[0]}
          set -eo pipefail
          if [ $RESULT -ne 0 ]; then
            ERRORS=$(tail -30 /tmp/signing.log | tr '\n' ' | ')
            echo "::error title=Signing Setup Failed::${ERRORS}"
            exit 1
          fi

      - name: "Archive"
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          API_KEY_PATH="$HOME/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8"
          set +eo pipefail
          xcodebuild archive \
            -project Echoelmusic.xcodeproj \
            -scheme Echoelmusic-watchOS \
            -destination "generic/platform=watchOS" \
            -archivePath ./build/Echoelmusic-watchOS.xcarchive \
            -configuration Release \
            -derivedDataPath ./build/DerivedData \
            -allowProvisioningUpdates \
            -authenticationKeyIssuerID "$ASC_ISSUER_ID" \
            -authenticationKeyID "$ASC_KEY_ID" \
            -authenticationKeyPath "$API_KEY_PATH" \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
            CODE_SIGN_STYLE=Automatic \
            COMPILER_INDEX_STORE_ENABLE=NO \
            SUPPORTED_PLATFORMS=watchos \
            2>&1 | tee /tmp/archive.log
          RESULT=${PIPESTATUS[0]}
          set -eo pipefail
          if [ $RESULT -ne 0 ]; then
            echo "=== ARCHIVE FAILED (exit $RESULT) ==="
            LAST_LINES=$(tail -30 /tmp/archive.log | tr '\n' ' | ')
            echo "::error title=watchOS Archive Failed::${LAST_LINES}"
            ERRORS=$(grep -iE "error:|failed|signing|provision|certificate|not found" /tmp/archive.log | tail -10 | tr '\n' ' | ')
            echo "::error title=watchOS Build Errors::${ERRORS}"
            echo "## watchOS Archive Failed (exit $RESULT)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 /tmp/archive.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "=== ARCHIVE SUCCESSFUL ==="

      - name: "Export"
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          API_KEY_PATH="$HOME/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8"
          cat > /tmp/ExportOptions.plist << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key><string>app-store</string>
              <key>teamID</key><string>${{ secrets.APPLE_TEAM_ID }}</string>
              <key>signingStyle</key><string>automatic</string>
              <key>uploadSymbols</key><true/>
              <key>destination</key><string>export</string>
          </dict>
          </plist>
          PLIST
          set +eo pipefail
          xcodebuild -exportArchive \
            -archivePath ./build/Echoelmusic-watchOS.xcarchive \
            -exportPath ./build \
            -exportOptionsPlist /tmp/ExportOptions.plist \
            -allowProvisioningUpdates \
            -authenticationKeyIssuerID "$ASC_ISSUER_ID" \
            -authenticationKeyID "$ASC_KEY_ID" \
            -authenticationKeyPath "$API_KEY_PATH" \
            2>&1 | tee /tmp/export.log
          RESULT=${PIPESTATUS[0]}
          set -eo pipefail
          [ $RESULT -ne 0 ] && { echo "=== EXPORT FAILED ==="; tail -50 /tmp/export.log; exit 1; }

      - name: "Upload to TestFlight"
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: fastlane ios upload_watchos

      - name: "Error Summary"
        if: failure()
        run: |
          echo "## watchOS Deploy Failed" >> $GITHUB_STEP_SUMMARY
          for f in /tmp/archive.log /tmp/export.log; do
            [ -f "$f" ] && { echo "### $(basename $f)" >> $GITHUB_STEP_SUMMARY; echo '```' >> $GITHUB_STEP_SUMMARY; tail -100 "$f" >> $GITHUB_STEP_SUMMARY; echo '```' >> $GITHUB_STEP_SUMMARY; }
          done

      - if: always()
        uses: actions/upload-artifact@v4
        with:
          name: watchos-build-logs
          path: |
            /tmp/archive.log
            /tmp/export.log
          retention-days: 7
          if-no-files-found: warn

      - name: "Cleanup"
        if: always()
        run: |
          rm -rf ~/.appstoreconnect/private_keys 2>/dev/null || true
          security delete-keychain "$HOME/Library/Keychains/build.keychain-db" 2>/dev/null || true

  # ===========================================================================
  # tvOS DEPLOYMENT
  # ===========================================================================
  tvos:
    name: "tvOS"
    runs-on: macos-15
    needs: [preflight, compile_check]
    if: |
      always() &&
      needs.preflight.outputs.ready == 'true' &&
      (needs.compile_check.result == 'success' || needs.compile_check.result == 'skipped') &&
      (github.event.inputs.platform == 'tvos' || github.event.inputs.platform == 'all') &&
      github.event.inputs.build_only != 'true'
    timeout-minutes: 180

    steps:
      - uses: actions/checkout@v4
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      - uses: actions/cache@v4
        with:
          path: ~/.swiftpm
          key: ${{ runner.os }}-spm-tvos-${{ hashFiles('Package.swift') }}

      - name: "Install Tools & Generate Project"
        run: |
          brew install xcodegen || true
          gem install fastlane:2.225.0 -N --no-document
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ env.BUILD_NUMBER }}/" project.yml
          xcodegen generate --spec project.yml

      - name: "Setup API Key & Keychain"
        env:
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$ASC_KEY_CONTENT" > ~/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8
          chmod 600 ~/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8

          # Create fresh empty keychain (avoids stale cert conflicts)
          KEYCHAIN_PATH="$HOME/Library/Keychains/build.keychain-db"
          security create-keychain -p "" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_PATH"
          echo "Fresh keychain ready"

      - name: "Setup Signing Certificates"
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set +eo pipefail
          fastlane ios setup_signing 2>&1 | tee /tmp/signing.log
          RESULT=${PIPESTATUS[0]}
          set -eo pipefail
          if [ $RESULT -ne 0 ]; then
            ERRORS=$(tail -30 /tmp/signing.log | tr '\n' ' | ')
            echo "::error title=Signing Setup Failed::${ERRORS}"
            exit 1
          fi

      - name: "Archive"
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          API_KEY_PATH="$HOME/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8"
          set +eo pipefail
          xcodebuild archive \
            -project Echoelmusic.xcodeproj \
            -scheme Echoelmusic-tvOS \
            -destination "generic/platform=tvOS" \
            -archivePath ./build/Echoelmusic-tvOS.xcarchive \
            -configuration Release \
            -derivedDataPath ./build/DerivedData \
            -allowProvisioningUpdates \
            -authenticationKeyIssuerID "$ASC_ISSUER_ID" \
            -authenticationKeyID "$ASC_KEY_ID" \
            -authenticationKeyPath "$API_KEY_PATH" \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
            CODE_SIGN_STYLE=Automatic \
            COMPILER_INDEX_STORE_ENABLE=NO \
            SUPPORTED_PLATFORMS=appletvos \
            2>&1 | tee /tmp/archive.log
          RESULT=${PIPESTATUS[0]}
          set -eo pipefail
          if [ $RESULT -ne 0 ]; then
            echo "=== ARCHIVE FAILED (exit $RESULT) ==="
            LAST_LINES=$(tail -30 /tmp/archive.log | tr '\n' ' | ')
            echo "::error title=tvOS Archive Failed::${LAST_LINES}"
            ERRORS=$(grep -iE "error:|failed|signing|provision|certificate|not found" /tmp/archive.log | tail -10 | tr '\n' ' | ')
            echo "::error title=tvOS Build Errors::${ERRORS}"
            echo "## tvOS Archive Failed (exit $RESULT)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 /tmp/archive.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "=== ARCHIVE SUCCESSFUL ==="

      - name: "Export"
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          API_KEY_PATH="$HOME/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8"
          cat > /tmp/ExportOptions.plist << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key><string>app-store</string>
              <key>teamID</key><string>${{ secrets.APPLE_TEAM_ID }}</string>
              <key>signingStyle</key><string>automatic</string>
              <key>uploadSymbols</key><true/>
              <key>destination</key><string>export</string>
          </dict>
          </plist>
          PLIST
          set +eo pipefail
          xcodebuild -exportArchive \
            -archivePath ./build/Echoelmusic-tvOS.xcarchive \
            -exportPath ./build \
            -exportOptionsPlist /tmp/ExportOptions.plist \
            -allowProvisioningUpdates \
            -authenticationKeyIssuerID "$ASC_ISSUER_ID" \
            -authenticationKeyID "$ASC_KEY_ID" \
            -authenticationKeyPath "$API_KEY_PATH" \
            2>&1 | tee /tmp/export.log
          RESULT=${PIPESTATUS[0]}
          set -eo pipefail
          [ $RESULT -ne 0 ] && { echo "=== EXPORT FAILED ==="; tail -50 /tmp/export.log; exit 1; }

      - name: "Upload to TestFlight"
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: fastlane ios upload_tvos

      - name: "Error Summary"
        if: failure()
        run: |
          echo "## tvOS Deploy Failed" >> $GITHUB_STEP_SUMMARY
          for f in /tmp/archive.log /tmp/export.log; do
            [ -f "$f" ] && { echo "### $(basename $f)" >> $GITHUB_STEP_SUMMARY; echo '```' >> $GITHUB_STEP_SUMMARY; tail -100 "$f" >> $GITHUB_STEP_SUMMARY; echo '```' >> $GITHUB_STEP_SUMMARY; }
          done

      - if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tvos-build-logs
          path: |
            /tmp/archive.log
            /tmp/export.log
          retention-days: 7
          if-no-files-found: warn

      - name: "Cleanup"
        if: always()
        run: |
          rm -rf ~/.appstoreconnect/private_keys 2>/dev/null || true
          security delete-keychain "$HOME/Library/Keychains/build.keychain-db" 2>/dev/null || true

  # ===========================================================================
  # visionOS DEPLOYMENT
  # ===========================================================================
  visionos:
    name: "visionOS"
    runs-on: macos-15
    needs: [preflight, compile_check]
    if: |
      always() &&
      needs.preflight.outputs.ready == 'true' &&
      (needs.compile_check.result == 'success' || needs.compile_check.result == 'skipped') &&
      (github.event.inputs.platform == 'visionos' || github.event.inputs.platform == 'all') &&
      github.event.inputs.build_only != 'true'
    timeout-minutes: 180

    steps:
      - uses: actions/checkout@v4
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      - uses: actions/cache@v4
        with:
          path: ~/.swiftpm
          key: ${{ runner.os }}-spm-visionos-${{ hashFiles('Package.swift') }}

      - name: "Install Tools & Generate Project"
        run: |
          brew install xcodegen || true
          gem install fastlane:2.225.0 -N --no-document
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ env.BUILD_NUMBER }}/" project.yml
          xcodegen generate --spec project.yml

      - name: "Setup API Key & Keychain"
        env:
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$ASC_KEY_CONTENT" > ~/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8
          chmod 600 ~/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8

          # Create fresh empty keychain (avoids stale cert conflicts)
          KEYCHAIN_PATH="$HOME/Library/Keychains/build.keychain-db"
          security create-keychain -p "" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_PATH"
          echo "Fresh keychain ready"

      - name: "Setup Signing Certificates"
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set +eo pipefail
          fastlane ios setup_signing 2>&1 | tee /tmp/signing.log
          RESULT=${PIPESTATUS[0]}
          set -eo pipefail
          if [ $RESULT -ne 0 ]; then
            ERRORS=$(tail -30 /tmp/signing.log | tr '\n' ' | ')
            echo "::error title=Signing Setup Failed::${ERRORS}"
            exit 1
          fi

      - name: "Archive"
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          API_KEY_PATH="$HOME/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8"
          set +eo pipefail
          xcodebuild archive \
            -project Echoelmusic.xcodeproj \
            -scheme Echoelmusic-visionOS \
            -destination "generic/platform=visionOS" \
            -archivePath ./build/Echoelmusic-visionOS.xcarchive \
            -configuration Release \
            -derivedDataPath ./build/DerivedData \
            -allowProvisioningUpdates \
            -authenticationKeyIssuerID "$ASC_ISSUER_ID" \
            -authenticationKeyID "$ASC_KEY_ID" \
            -authenticationKeyPath "$API_KEY_PATH" \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
            CODE_SIGN_STYLE=Automatic \
            COMPILER_INDEX_STORE_ENABLE=NO \
            SUPPORTED_PLATFORMS=xros \
            2>&1 | tee /tmp/archive.log
          RESULT=${PIPESTATUS[0]}
          set -eo pipefail
          if [ $RESULT -ne 0 ]; then
            echo "=== ARCHIVE FAILED (exit $RESULT) ==="
            LAST_LINES=$(tail -30 /tmp/archive.log | tr '\n' ' | ')
            echo "::error title=visionOS Archive Failed::${LAST_LINES}"
            ERRORS=$(grep -iE "error:|failed|signing|provision|certificate|not found" /tmp/archive.log | tail -10 | tr '\n' ' | ')
            echo "::error title=visionOS Build Errors::${ERRORS}"
            echo "## visionOS Archive Failed (exit $RESULT)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 /tmp/archive.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "=== ARCHIVE SUCCESSFUL ==="

      - name: "Export"
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          API_KEY_PATH="$HOME/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8"
          cat > /tmp/ExportOptions.plist << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key><string>app-store</string>
              <key>teamID</key><string>${{ secrets.APPLE_TEAM_ID }}</string>
              <key>signingStyle</key><string>automatic</string>
              <key>uploadSymbols</key><true/>
              <key>destination</key><string>export</string>
          </dict>
          </plist>
          PLIST
          set +eo pipefail
          xcodebuild -exportArchive \
            -archivePath ./build/Echoelmusic-visionOS.xcarchive \
            -exportPath ./build \
            -exportOptionsPlist /tmp/ExportOptions.plist \
            -allowProvisioningUpdates \
            -authenticationKeyIssuerID "$ASC_ISSUER_ID" \
            -authenticationKeyID "$ASC_KEY_ID" \
            -authenticationKeyPath "$API_KEY_PATH" \
            2>&1 | tee /tmp/export.log
          RESULT=${PIPESTATUS[0]}
          set -eo pipefail
          [ $RESULT -ne 0 ] && { echo "=== EXPORT FAILED ==="; tail -50 /tmp/export.log; exit 1; }

      - name: "Upload to TestFlight"
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: fastlane ios upload_visionos

      - name: "Error Summary"
        if: failure()
        run: |
          echo "## visionOS Deploy Failed" >> $GITHUB_STEP_SUMMARY
          for f in /tmp/archive.log /tmp/export.log; do
            [ -f "$f" ] && { echo "### $(basename $f)" >> $GITHUB_STEP_SUMMARY; echo '```' >> $GITHUB_STEP_SUMMARY; tail -100 "$f" >> $GITHUB_STEP_SUMMARY; echo '```' >> $GITHUB_STEP_SUMMARY; }
          done

      - if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visionos-build-logs
          path: |
            /tmp/archive.log
            /tmp/export.log
          retention-days: 7
          if-no-files-found: warn

      - name: "Cleanup"
        if: always()
        run: |
          rm -rf ~/.appstoreconnect/private_keys 2>/dev/null || true
          security delete-keychain "$HOME/Library/Keychains/build.keychain-db" 2>/dev/null || true

  # ===========================================================================
  # SUMMARY
  # ===========================================================================
  summary:
    name: "Summary"
    runs-on: ubuntu-latest
    if: always()
    needs: [preflight, compile_check, ios, macos, watchos, tvos, visionos]

    steps:
      - name: "Report"
        run: |
          echo "# TestFlight Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | ${{ github.event.inputs.platform }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Preflight | ${{ needs.preflight.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Compile | ${{ needs.compile_check.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS | ${{ needs.ios.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | ${{ needs.macos.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| watchOS | ${{ needs.watchos.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| tvOS | ${{ needs.tvos.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| visionOS | ${{ needs.visionos.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[App Store Connect](https://appstoreconnect.apple.com/apps)" >> $GITHUB_STEP_SUMMARY
