# Android Build Workflow using Skip Framework
# Transpiles Swift to Kotlin and builds native Android app
# Note: Requires macOS runner for Skip (uses Xcode)

name: Android Build (Skip)

on:
  push:
    branches: [main, develop]
    paths:
      - 'Sources/**'
      - 'Package.swift'
      - 'skip.yml'
      - '.github/workflows/android-skip.yml'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

jobs:
  build-android:
    name: Build Android with Skip
    runs-on: macos-14  # M1/M2 runner for Skip
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.0'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Skip Framework
        run: |
          brew install skiptools/skip/skip
          skip version

      - name: Cache Skip Build
        uses: actions/cache@v4
        with:
          path: |
            .build/
            android/.gradle/
            ~/Library/Caches/skip/
          key: skip-${{ runner.os }}-${{ hashFiles('Package.swift', 'skip.yml') }}
          restore-keys: |
            skip-${{ runner.os }}-

      - name: Initialize Skip Project
        run: |
          # Initialize Skip if android/ directory doesn't exist
          if [ ! -d "android" ]; then
            skip init --name Echoelmusic
          fi

      - name: Transpile Swift to Kotlin
        run: |
          skip transpile

      - name: Build Android (Debug)
        if: ${{ github.event.inputs.build_type != 'release' }}
        run: |
          skip build --platform android --configuration debug

      - name: Build Android (Release)
        if: ${{ github.event.inputs.build_type == 'release' }}
        run: |
          skip build --platform android --configuration release

      - name: Run Android Tests
        run: |
          cd android
          ./gradlew testDebugUnitTest
        continue-on-error: true

      - name: Build APK
        run: |
          cd android
          ./gradlew assembleDebug

      - name: Build AAB (App Bundle) for Play Store
        if: github.ref == 'refs/heads/main'
        run: |
          cd android
          ./gradlew bundleRelease

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: echoelmusic-android-apk-${{ github.sha }}
          path: android/app/build/outputs/apk/
          retention-days: 7

      - name: Upload AAB Artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: echoelmusic-android-aab-${{ github.sha }}
          path: android/app/build/outputs/bundle/
          retention-days: 30

  # Alternative: Direct Kotlin build if Skip isn't set up yet
  build-android-kotlin:
    name: Build Existing Android Module
    runs-on: ubuntu-latest
    if: ${{ hashFiles('android/build.gradle.kts') != '' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Build with Gradle
        run: |
          cd android
          ./gradlew assembleDebug

      - name: Run Tests
        run: |
          cd android
          ./gradlew testDebugUnitTest
        continue-on-error: true

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: echoelmusic-android-kotlin-${{ github.sha }}
          path: android/app/build/outputs/apk/
          retention-days: 7

  notify:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-android, build-android-kotlin]
    if: always()

    steps:
      - name: Create Summary
        run: |
          echo "## Android Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Build | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Skip (Swiftâ†’Kotlin) | ${{ needs.build-android.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Native Kotlin | ${{ needs.build-android-kotlin.result }} |" >> $GITHUB_STEP_SUMMARY
