# =============================================================================
# ECHOELMUSIC - TESTFLIGHT DEPLOYMENT
# =============================================================================
# Manual deployment to TestFlight for all Apple platforms
# Trigger: Actions -> TestFlight Deploy -> Run workflow
# IMPORTANT: This workflow ONLY runs on manual trigger (workflow_dispatch)
# =============================================================================

name: "TestFlight Deploy"

on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Platforms to deploy'
        required: true
        default: 'ios'
        type: choice
        options:
          - ios
          - macos
          - ios-macos
          - watchos
          - tvos
          - visionos
          - all

env:
  XCODE_VERSION: '16.2'

jobs:
  # ===========================================================================
  # PREFLIGHT VALIDATION
  # ===========================================================================
  preflight:
    name: "Pre-flight"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      ready: ${{ steps.check.outputs.ready }}

    steps:
      - name: "Start"
        run: |
          echo "================================================"
          echo "  TESTFLIGHT DEPLOYMENT - PRE-FLIGHT CHECK"
          echo "================================================"
          echo ""
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Actor: ${{ github.actor }}"
          echo "Run: ${{ github.run_number }}"
          echo "Platforms: ${{ github.event.inputs.platforms }}"
          echo ""

      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Validate"
        id: check
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set +e
          ERRORS=0

          echo "--- Checking Files ---"
          for f in Package.swift project.yml fastlane/Fastfile fastlane/Appfile; do
            if [ -f "$f" ]; then
              echo "[OK] $f"
            else
              echo "[FAIL] $f missing"
              ERRORS=$((ERRORS + 1))
            fi
          done

          echo ""
          echo "--- Checking Secrets ---"

          if [ -n "$ASC_KEY_ID" ] && [ ${#ASC_KEY_ID} -gt 5 ]; then
            echo "[OK] APP_STORE_CONNECT_KEY_ID (length: ${#ASC_KEY_ID})"
          else
            echo "[FAIL] APP_STORE_CONNECT_KEY_ID not set or too short"
            ERRORS=$((ERRORS + 1))
          fi

          if [ -n "$ASC_ISSUER_ID" ] && [ ${#ASC_ISSUER_ID} -gt 10 ]; then
            echo "[OK] APP_STORE_CONNECT_ISSUER_ID (length: ${#ASC_ISSUER_ID})"
          else
            echo "[FAIL] APP_STORE_CONNECT_ISSUER_ID not set or too short"
            ERRORS=$((ERRORS + 1))
          fi

          if [ -n "$ASC_KEY_CONTENT" ] && [ ${#ASC_KEY_CONTENT} -gt 100 ]; then
            echo "[OK] APP_STORE_CONNECT_PRIVATE_KEY (length: ${#ASC_KEY_CONTENT})"
          else
            echo "[FAIL] APP_STORE_CONNECT_PRIVATE_KEY not set or too short"
            ERRORS=$((ERRORS + 1))
          fi

          if [ -n "$TEAM_ID" ] && [ ${#TEAM_ID} -ge 10 ]; then
            echo "[OK] APPLE_TEAM_ID (length: ${#TEAM_ID})"
          else
            echo "[FAIL] APPLE_TEAM_ID not set or too short"
            ERRORS=$((ERRORS + 1))
          fi

          echo ""
          echo "================================================"

          if [ $ERRORS -gt 0 ]; then
            echo "ready=false" >> $GITHUB_OUTPUT
            echo ""
            echo "FAILED: $ERRORS error(s)"
            echo ""
            echo "Configure secrets at:"
            echo "https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi

          echo "ready=true" >> $GITHUB_OUTPUT
          echo "SUCCESS: All checks passed"
        run: |
          echo "=============================================="
          echo "  TESTFLIGHT PRE-FLIGHT CHECK"
          echo "=============================================="
          echo "Trigger: ${{ github.event_name }}"
          echo "Platforms: ${{ github.event.inputs.platforms }}"
          echo "Build: ${{ github.run_number }}"
          echo "Actor: ${{ github.actor }}"
          echo "Ref: ${{ github.ref }}"
          echo ""

          ERRORS=0

          # Check required files
          echo "ðŸ“ Checking required files..."
          for f in Package.swift project.yml fastlane/Fastfile fastlane/Appfile; do
            if [ -f "$f" ]; then
              echo "  âœ… $f"
            else
              echo "  âŒ $f missing"
              ERRORS=$((ERRORS + 1))
            fi
          done

          echo ""
          echo "ðŸ” Checking secrets..."

          # Check secrets with detailed output
          if [ -n "$ASC_KEY_ID" ]; then
            echo "  âœ… APP_STORE_CONNECT_KEY_ID (${#ASC_KEY_ID} chars)"
          else
            echo "  âŒ APP_STORE_CONNECT_KEY_ID not set"
            ERRORS=$((ERRORS + 1))
          fi

          if [ -n "$ASC_ISSUER_ID" ]; then
            echo "  âœ… APP_STORE_CONNECT_ISSUER_ID (${#ASC_ISSUER_ID} chars)"
          else
            echo "  âŒ APP_STORE_CONNECT_ISSUER_ID not set"
            ERRORS=$((ERRORS + 1))
          fi

          if [ -n "$ASC_KEY_CONTENT" ]; then
            echo "  âœ… APP_STORE_CONNECT_PRIVATE_KEY (${#ASC_KEY_CONTENT} chars)"
          else
            echo "  âŒ APP_STORE_CONNECT_PRIVATE_KEY not set"
            ERRORS=$((ERRORS + 1))
          fi

          if [ -n "$TEAM_ID" ]; then
            echo "  âœ… APPLE_TEAM_ID (${#TEAM_ID} chars)"
          else
            echo "  âŒ APPLE_TEAM_ID not set"
            ERRORS=$((ERRORS + 1))
          fi

          echo ""
          echo "=============================================="

          if [ $ERRORS -gt 0 ]; then
            echo "ready=false" >> $GITHUB_OUTPUT
            echo ""
            echo "âŒ FAILED: $ERRORS error(s) - cannot proceed"
            echo ""
            echo "ðŸ“‹ Configure secrets at:"
            echo "   https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo ""
            echo "Required secrets:"
            echo "  - APP_STORE_CONNECT_KEY_ID"
            echo "  - APP_STORE_CONNECT_ISSUER_ID"
            echo "  - APP_STORE_CONNECT_PRIVATE_KEY"
            echo "  - APPLE_TEAM_ID"
            exit 1
          fi

          echo "ready=true" >> $GITHUB_OUTPUT
          echo "âœ… All checks passed - ready to deploy!"

  # ===========================================================================
  # iOS DEPLOYMENT
  # ===========================================================================
  deploy-ios:
    name: "iOS"
    runs-on: macos-14
    needs: preflight
    if: needs.preflight.result == 'success' && contains('all ios ios-macos', github.event.inputs.platforms)
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - name: "Setup Xcode"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "Setup XcodeGen"
        run: brew install xcodegen || true

      - name: "Install Fastlane"
        run: gem install fastlane -N --no-document

      - name: "Generate Project"
        run: |
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ github.run_number }}/" project.yml
          xcodegen generate --spec project.yml

      - name: "Setup Keychain"
        env:
          KEYCHAIN_PASSWORD: ${{ secrets.CI_KEYCHAIN_PASSWORD || github.run_id }}
        run: |
          set -e
          security create-keychain -p "$KEYCHAIN_PASSWORD" ci.keychain-db
          security set-keychain-settings -lut 21600 ci.keychain-db
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" ci.keychain-db
          security list-keychains -d user -s ci.keychain-db
          security default-keychain -s ci.keychain-db

      - name: "Deploy to TestFlight"
        run: fastlane ios beta
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}
          KEYCHAIN_PATH: ~/Library/Keychains/ci.keychain-db
          KEYCHAIN_PASSWORD: ${{ secrets.CI_KEYCHAIN_PASSWORD || github.run_id }}

      - name: "Cleanup"
        if: always()
        run: security delete-keychain ci.keychain-db 2>/dev/null || true

  # ===========================================================================
  # macOS DEPLOYMENT
  # ===========================================================================
  deploy-macos:
    name: "macOS"
    runs-on: macos-14
    needs: preflight
    if: needs.preflight.result == 'success' && contains('all macos ios-macos', github.event.inputs.platforms)
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - name: "Setup Xcode"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "Setup XcodeGen"
        run: brew install xcodegen || true

      - name: "Install Fastlane"
        run: gem install fastlane -N --no-document

      - name: "Generate Project"
        run: |
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ github.run_number }}/" project.yml
          xcodegen generate --spec project.yml

      - name: "Setup Keychain"
        env:
          KEYCHAIN_PASSWORD: ${{ secrets.CI_KEYCHAIN_PASSWORD || github.run_id }}
        run: |
          set -e
          security create-keychain -p "$KEYCHAIN_PASSWORD" ci_mac.keychain-db
          security set-keychain-settings -lut 21600 ci_mac.keychain-db
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" ci_mac.keychain-db
          security list-keychains -d user -s ci_mac.keychain-db
          security default-keychain -s ci_mac.keychain-db

      - name: "Deploy to TestFlight"
        run: fastlane mac beta
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}
          KEYCHAIN_PATH: ~/Library/Keychains/ci_mac.keychain-db
          KEYCHAIN_PASSWORD: ${{ secrets.CI_KEYCHAIN_PASSWORD || github.run_id }}

      - name: "Cleanup"
        if: always()
        run: security delete-keychain ci_mac.keychain-db 2>/dev/null || true

  # ===========================================================================
  # watchOS DEPLOYMENT
  # ===========================================================================
  deploy-watchos:
    name: "watchOS"
    runs-on: macos-14
    needs: preflight
    if: needs.preflight.result == 'success' && contains('all watchos', github.event.inputs.platforms)
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      - run: brew install xcodegen || true
      - run: gem install fastlane -N --no-document
      - name: "Generate Project"
        run: |
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ github.run_number }}/" project.yml
          xcodegen generate --spec project.yml
      - name: "Setup Keychain"
        env:
          KEYCHAIN_PASSWORD: ${{ secrets.CI_KEYCHAIN_PASSWORD || github.run_id }}
        run: |
          set -e
          security create-keychain -p "$KEYCHAIN_PASSWORD" ci_w.keychain-db
          security set-keychain-settings -lut 21600 ci_w.keychain-db
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" ci_w.keychain-db
          security list-keychains -d user -s ci_w.keychain-db
          security default-keychain -s ci_w.keychain-db
      - name: "Deploy to TestFlight"
        run: fastlane ios beta_watchos
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}
          KEYCHAIN_PATH: ~/Library/Keychains/ci_w.keychain-db
          KEYCHAIN_PASSWORD: ${{ secrets.CI_KEYCHAIN_PASSWORD || github.run_id }}
      - if: always()
        run: security delete-keychain ci_w.keychain-db 2>/dev/null || true

  # ===========================================================================
  # tvOS DEPLOYMENT
  # ===========================================================================
  deploy-tvos:
    name: "tvOS"
    runs-on: macos-14
    needs: preflight
    if: needs.preflight.result == 'success' && contains('all tvos', github.event.inputs.platforms)
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      - run: brew install xcodegen || true
      - run: gem install fastlane -N --no-document
      - name: "Generate Project"
        run: |
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ github.run_number }}/" project.yml
          xcodegen generate --spec project.yml
      - name: "Setup Keychain"
        env:
          KEYCHAIN_PASSWORD: ${{ secrets.CI_KEYCHAIN_PASSWORD || github.run_id }}
        run: |
          set -e
          security create-keychain -p "$KEYCHAIN_PASSWORD" ci_tv.keychain-db
          security set-keychain-settings -lut 21600 ci_tv.keychain-db
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" ci_tv.keychain-db
          security list-keychains -d user -s ci_tv.keychain-db
          security default-keychain -s ci_tv.keychain-db
      - name: "Deploy to TestFlight"
        run: fastlane ios beta_tvos
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}
          KEYCHAIN_PATH: ~/Library/Keychains/ci_tv.keychain-db
          KEYCHAIN_PASSWORD: ${{ secrets.CI_KEYCHAIN_PASSWORD || github.run_id }}
      - if: always()
        run: security delete-keychain ci_tv.keychain-db 2>/dev/null || true

  # ===========================================================================
  # visionOS DEPLOYMENT
  # ===========================================================================
  deploy-visionos:
    name: "visionOS"
    runs-on: macos-14
    needs: preflight
    if: needs.preflight.result == 'success' && contains('all visionos', github.event.inputs.platforms)
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      - run: brew install xcodegen || true
      - run: gem install fastlane -N --no-document
      - name: "Generate Project"
        run: |
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ github.run_number }}/" project.yml
          xcodegen generate --spec project.yml
      - name: "Setup Keychain"
        env:
          KEYCHAIN_PASSWORD: ${{ secrets.CI_KEYCHAIN_PASSWORD || github.run_id }}
        run: |
          set -e
          security create-keychain -p "$KEYCHAIN_PASSWORD" ci_v.keychain-db
          security set-keychain-settings -lut 21600 ci_v.keychain-db
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" ci_v.keychain-db
          security list-keychains -d user -s ci_v.keychain-db
          security default-keychain -s ci_v.keychain-db
      - name: "Deploy to TestFlight"
        run: fastlane ios beta_visionos
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}
          KEYCHAIN_PATH: ~/Library/Keychains/ci_v.keychain-db
          KEYCHAIN_PASSWORD: ${{ secrets.CI_KEYCHAIN_PASSWORD || github.run_id }}
      - if: always()
        run: security delete-keychain ci_v.keychain-db 2>/dev/null || true

  # ===========================================================================
  # DEPLOYMENT SUMMARY
  # ===========================================================================
  summary:
    name: "Summary"
    runs-on: ubuntu-latest
    if: ${{ always() }}
    needs: [preflight, deploy-ios, deploy-macos, deploy-watchos, deploy-tvos, deploy-visionos]

    steps:
      - name: "Generate Report"
        run: |
          echo "# ðŸš€ TestFlight Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Platforms:** ${{ github.event.inputs.platforms || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-flight | ${{ needs.preflight.result == 'success' && 'âœ…' || needs.preflight.result == 'skipped' && 'â­ï¸' || 'âŒ' }} ${{ needs.preflight.result || 'unknown' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS | ${{ needs.deploy-ios.result == 'success' && 'âœ…' || needs.deploy-ios.result == 'skipped' && 'â­ï¸' || 'âŒ' }} ${{ needs.deploy-ios.result || 'unknown' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | ${{ needs.deploy-macos.result == 'success' && 'âœ…' || needs.deploy-macos.result == 'skipped' && 'â­ï¸' || 'âŒ' }} ${{ needs.deploy-macos.result || 'unknown' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| watchOS | ${{ needs.deploy-watchos.result == 'success' && 'âœ…' || needs.deploy-watchos.result == 'skipped' && 'â­ï¸' || 'âŒ' }} ${{ needs.deploy-watchos.result || 'unknown' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| tvOS | ${{ needs.deploy-tvos.result == 'success' && 'âœ…' || needs.deploy-tvos.result == 'skipped' && 'â­ï¸' || 'âŒ' }} ${{ needs.deploy-tvos.result || 'unknown' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| visionOS | ${{ needs.deploy-visionos.result == 'success' && 'âœ…' || needs.deploy-visionos.result == 'skipped' && 'â­ï¸' || 'âŒ' }} ${{ needs.deploy-visionos.result || 'unknown' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "[Open App Store Connect](https://appstoreconnect.apple.com)" >> $GITHUB_STEP_SUMMARY

      - name: "Check Results"
        if: ${{ needs.preflight.result == 'failure' }}
        run: |
          echo "::error::Pre-flight check failed. Please verify your secrets are configured correctly."
          exit 1
