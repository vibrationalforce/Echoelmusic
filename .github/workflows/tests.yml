name: Tests

on:
  push:
    branches: [main, develop, 'claude/**']
  pull_request:
    branches: [main, develop]

jobs:
  cpp-tests:
    name: C++ DSP Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Configure
        run: cmake -B build -DBUILD_TESTS=ON -DCMAKE_BUILD_TYPE=Release

      - name: Build Tests
        run: cmake --build build --target EchoelmusicTests --config Release

      - name: Run Tests
        run: ctest --test-dir build --output-on-failure -C Release

  swift-tests:
    name: Swift Tests
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Run Swift Tests
        run: swift test

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Count Remaining TODOs
        run: |
          echo "=== TODO Count by Category ==="
          echo "SDK Integration (expected):"
          grep -r "ECHOELMUSIC_HAS_" Sources/ --include="*.cpp" --include="*.h" | wc -l
          echo ""
          echo "Remaining TODOs:"
          grep -r "TODO" Sources/ --include="*.cpp" --include="*.h" | grep -v "ECHOELMUSIC_HAS_" | wc -l

      - name: Check for Debug Code
        run: |
          echo "=== Checking for debug code ==="
          grep -rn "console.log\|print(\|NSLog\|std::cout" Sources/ --include="*.cpp" --include="*.h" --include="*.swift" || echo "No debug prints found"

      - name: Line Count
        run: |
          echo "=== Code Statistics ==="
          find Sources -name "*.cpp" -o -name "*.h" | xargs wc -l | tail -1
          find Sources -name "*.swift" | xargs wc -l 2>/dev/null | tail -1 || echo "No Swift files"
