# =============================================================================
# ECHOELMUSIC - Multi-Platform Build & Release
# =============================================================================
# Builds for Windows, macOS, Linux, and Android
# NOTE: This workflow does NOT run on pull requests!
#       - For PR checks â†’ use ios-testflight.yml
#       - For manual releases â†’ use ðŸš€ Release All Platforms
# =============================================================================

name: Build & Release

on:
  push:
    branches: [develop]  # Only develop branch pushes
    tags:
      - 'v*'  # Release tags
    paths:
      - 'Sources/**'
      - 'android/**'
      - 'CMakeLists.txt'
      - 'Package.swift'
  workflow_dispatch:  # Manual trigger

env:
  BUILD_TYPE: Release
  IPLUG2_VERSION: master
  XCODE_VERSION: '15.4'

jobs:
  # ============================================
  # Windows Build (VST3, CLAP, Standalone)
  # ============================================
  build-windows:
    runs-on: windows-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Check CMakeLists.txt
        id: check_cmake
        run: |
          if (Test-Path "CMakeLists.txt") {
            echo "has_cmake=true" >> $env:GITHUB_OUTPUT
          } else {
            echo "has_cmake=false" >> $env:GITHUB_OUTPUT
          }

      - name: Cache iPlug2
        if: steps.check_cmake.outputs.has_cmake == 'true'
        uses: actions/cache@v4
        with:
          path: ThirdParty/iPlug2
          key: iplug2-windows-${{ env.IPLUG2_VERSION }}

      - name: Clone iPlug2
        if: steps.check_cmake.outputs.has_cmake == 'true'
        run: |
          if (!(Test-Path "ThirdParty/iPlug2")) {
            New-Item -ItemType Directory -Force -Path ThirdParty
            git clone --depth 1 https://github.com/iPlug2/iPlug2 ThirdParty/iPlug2
          }

      - name: Build Desktop Plugins
        if: steps.check_cmake.outputs.has_cmake == 'true'
        run: |
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release --parallel
        continue-on-error: true

      - name: Package Windows Build
        run: |
          New-Item -ItemType Directory -Force -Path dist/Echoelmusic
          Copy-Item build/Release/*.exe dist/Echoelmusic/ -ErrorAction SilentlyContinue
          Copy-Item build/Release/*.dll dist/Echoelmusic/ -ErrorAction SilentlyContinue
          Copy-Item build/Release/*.vst3 dist/Echoelmusic/ -ErrorAction SilentlyContinue
          Copy-Item build/Release/*.clap dist/Echoelmusic/ -ErrorAction SilentlyContinue
          if (Test-Path Resources) { Copy-Item -Recurse Resources dist/Echoelmusic/ }
          # Create placeholder if no actual builds
          if (-not (Get-ChildItem dist/Echoelmusic -File | Where-Object { $_.Extension -in '.exe','.dll','.vst3' })) {
            "Echoelmusic Windows Build Placeholder" | Out-File dist/Echoelmusic/README.txt
          }
          Compress-Archive -Path dist/Echoelmusic -DestinationPath dist/Echoelmusic-Windows.zip

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Echoelmusic-Windows
          path: dist/*.zip
          if-no-files-found: warn

  # ============================================
  # macOS Build (VST3, AU, CLAP, Standalone)
  # ============================================
  build-macos:
    runs-on: macos-14
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Check CMakeLists.txt
        id: check_cmake
        run: |
          if [ -f "CMakeLists.txt" ]; then
            echo "has_cmake=true" >> $GITHUB_OUTPUT
          else
            echo "has_cmake=false" >> $GITHUB_OUTPUT
          fi

      - name: Cache iPlug2
        if: steps.check_cmake.outputs.has_cmake == 'true'
        uses: actions/cache@v4
        with:
          path: ThirdParty/iPlug2
          key: iplug2-macos-${{ env.IPLUG2_VERSION }}

      - name: Clone iPlug2
        if: steps.check_cmake.outputs.has_cmake == 'true'
        run: |
          if [ ! -d "ThirdParty/iPlug2" ]; then
            mkdir -p ThirdParty
            git clone --depth 1 https://github.com/iPlug2/iPlug2 ThirdParty/iPlug2
          fi

      - name: Build Desktop Plugins
        if: steps.check_cmake.outputs.has_cmake == 'true'
        run: |
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release --parallel
        continue-on-error: true

      - name: Package macOS Build
        run: |
          mkdir -p dist/Echoelmusic
          cp -r build/*.vst3 dist/Echoelmusic/ 2>/dev/null || true
          cp -r build/*.component dist/Echoelmusic/ 2>/dev/null || true
          cp -r build/*.clap dist/Echoelmusic/ 2>/dev/null || true
          cp -r build/Echoelmusic_Standalone dist/Echoelmusic/ 2>/dev/null || true
          if [ ! "$(ls -A dist/Echoelmusic 2>/dev/null)" ]; then
            echo "Echoelmusic macOS Build Placeholder" > dist/Echoelmusic/README.txt
          fi
          # Create DMG
          hdiutil create -volname "Echoelmusic" -srcfolder dist/Echoelmusic -ov -format UDZO dist/Echoelmusic-macOS.dmg || \
          zip -r dist/Echoelmusic-macOS.zip dist/Echoelmusic

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Echoelmusic-macOS
          path: |
            dist/*.dmg
            dist/*.zip
          if-no-files-found: warn

  # ============================================
  # Linux Build (VST3, CLAP, Standalone)
  # ============================================
  build-linux:
    runs-on: ubuntu-22.04
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake git \
            libasound2-dev libjack-jackd2-dev \
            libfreetype6-dev libx11-dev libxcomposite-dev \
            libxcursor-dev libxext-dev libxinerama-dev \
            libxrandr-dev libxrender-dev libglu1-mesa-dev \
            libcurl4-openssl-dev libfuse2 imagemagick

      - name: Check CMakeLists.txt
        id: check_cmake
        run: |
          if [ -f "CMakeLists.txt" ]; then
            echo "has_cmake=true" >> $GITHUB_OUTPUT
          else
            echo "has_cmake=false" >> $GITHUB_OUTPUT
          fi

      - name: Cache iPlug2
        if: steps.check_cmake.outputs.has_cmake == 'true'
        uses: actions/cache@v4
        with:
          path: ThirdParty/iPlug2
          key: iplug2-linux-${{ env.IPLUG2_VERSION }}

      - name: Clone iPlug2
        if: steps.check_cmake.outputs.has_cmake == 'true'
        run: |
          if [ ! -d "ThirdParty/iPlug2" ]; then
            mkdir -p ThirdParty
            git clone --depth 1 https://github.com/iPlug2/iPlug2 ThirdParty/iPlug2
          fi

      - name: Build Desktop Plugins
        if: steps.check_cmake.outputs.has_cmake == 'true'
        run: |
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
          cmake --build build --parallel
        continue-on-error: true

      - name: Create AppImage
        run: |
          mkdir -p AppDir/usr/{bin,lib,share/{applications,icons/hicolor/256x256/apps}}

          # Copy binary or create placeholder
          if [ -f build/Echoelmusic ]; then
            cp build/Echoelmusic AppDir/usr/bin/
          elif [ -f build/Echoelmusic_Standalone ]; then
            cp build/Echoelmusic_Standalone AppDir/usr/bin/Echoelmusic
          else
            echo '#!/bin/bash' > AppDir/usr/bin/Echoelmusic
            echo 'echo "Echoelmusic Linux Build"' >> AppDir/usr/bin/Echoelmusic
          fi
          chmod +x AppDir/usr/bin/Echoelmusic

          # Copy libraries
          cp build/*.so AppDir/usr/lib/ 2>/dev/null || true

          # Desktop file
          cat > AppDir/usr/share/applications/echoelmusic.desktop << 'EOF'
          [Desktop Entry]
          Name=Echoelmusic
          Comment=Bio-reactive audio-visual platform
          Exec=Echoelmusic
          Icon=echoelmusic
          Type=Application
          Categories=Audio;AudioVideo;Music;
          EOF

          # Icon
          if [ -f Resources/AppIcon.png ]; then
            cp Resources/AppIcon.png AppDir/usr/share/icons/hicolor/256x256/apps/echoelmusic.png
          else
            convert -size 256x256 -define gradient:angle=135 gradient:'#6B46C1'-'#9F7AEA' \
              -gravity center -fill white -font DejaVu-Sans-Bold -pointsize 72 \
              -annotate 0 'E' AppDir/usr/share/icons/hicolor/256x256/apps/echoelmusic.png
          fi

          # AppRun
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "$0")")"
          export LD_LIBRARY_PATH="$HERE/usr/lib:$LD_LIBRARY_PATH"
          exec "$HERE/usr/bin/Echoelmusic" "$@"
          EOF
          chmod +x AppDir/AppRun

          # Create AppImage
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          mkdir -p dist
          ARCH=x86_64 ./appimagetool-x86_64.AppImage AppDir dist/Echoelmusic-Linux.AppImage

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Echoelmusic-Linux
          path: dist/*.AppImage
          if-no-files-found: warn

  # ============================================
  # Android Build (APK) - INDEPENDENT BUILD
  # ============================================
  build-android:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Android Directory
        id: check
        run: |
          if [ -d "android" ] && [ -f "android/build.gradle.kts" ]; then
            echo "has_android=true" >> $GITHUB_OUTPUT
          else
            echo "has_android=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Java 17
        if: steps.check.outputs.has_android == 'true'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Android SDK
        if: steps.check.outputs.has_android == 'true'
        uses: android-actions/setup-android@v3

      - name: Cache Gradle
        if: steps.check.outputs.has_android == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Make gradlew executable
        if: steps.check.outputs.has_android == 'true'
        run: chmod +x android/gradlew

      - name: Build Debug APK
        if: steps.check.outputs.has_android == 'true'
        run: |
          cd android
          ./gradlew assembleDebug --no-daemon --stacktrace || true

      - name: List built APKs
        if: steps.check.outputs.has_android == 'true'
        run: |
          echo "=== Looking for APKs ==="
          find android -name "*.apk" -type f 2>/dev/null || echo "No APKs found"

      - name: Prepare APK for download
        if: steps.check.outputs.has_android == 'true'
        run: |
          mkdir -p android/output
          if [ -f "android/app/build/outputs/apk/debug/app-debug.apk" ]; then
            cp android/app/build/outputs/apk/debug/app-debug.apk android/output/Echoelmusic.apk
            echo "APK copied successfully"
          else
            echo "No APK found - build may have failed"
          fi

      - name: Upload Echoelmusic APK
        if: steps.check.outputs.has_android == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: Echoelmusic-Android-APK
          path: android/output/*.apk
          if-no-files-found: warn

  # ============================================
  # Create GitHub Release
  # ============================================
  release:
    needs: [build-windows, build-macos, build-linux, build-android]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display Structure
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/Echoelmusic-Windows/**/*
            artifacts/Echoelmusic-macOS/**/*
            artifacts/Echoelmusic-Linux/**/*
            artifacts/Echoelmusic-Android-APK/**/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
