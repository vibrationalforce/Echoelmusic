# GitHub Pages Deployment Workflow
name: Deploy to GitHub Pages

on:
  push:
    branches: ["main"]
    paths:
      - 'docs/**'  # Only run when docs change
  workflow_dispatch:

# Sets permissions for GITHUB_TOKEN
permissions:
  contents: read
  pages: write
  id-token: write

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './docs'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      # =========================================================================
      # CLOUDFLARE CACHE PURGE (Optional - requires CLOUDFLARE_* secrets)
      # =========================================================================
      - name: Purge Cloudflare Cache
        if: ${{ secrets.CLOUDFLARE_ZONE_ID != '' && secrets.CLOUDFLARE_API_TOKEN != '' }}
        env:
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "=============================================="
          echo "  CLOUDFLARE CACHE PURGE"
          echo "=============================================="

          # Purge entire cache for the zone
          RESPONSE=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}/purge_cache" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}')

          # Check if successful
          if echo "$RESPONSE" | grep -q '"success":true'; then
            echo "[PASS] Cloudflare cache purged successfully"
          else
            echo "[WARN] Cloudflare cache purge may have failed:"
            echo "$RESPONSE" | head -c 500
          fi

      - name: Verify Live Deployment
        run: |
          echo "=============================================="
          echo "  VERIFYING LIVE DEPLOYMENT"
          echo "=============================================="

          # Wait for CDN propagation
          sleep 5

          # Check cache status
          echo "Checking echoelmusic.com..."
          HEADERS=$(curl -sI "https://echoelmusic.com" 2>/dev/null || echo "Connection failed")

          if echo "$HEADERS" | grep -qi "cf-cache-status"; then
            STATUS=$(echo "$HEADERS" | grep -i "cf-cache-status" | awk '{print $2}' | tr -d '\r')
            echo "Cloudflare Cache Status: $STATUS"

            if [[ "$STATUS" == "HIT" ]]; then
              echo "[INFO] Content served from cache - this is normal after purge settles"
            elif [[ "$STATUS" == "MISS" || "$STATUS" == "DYNAMIC" ]]; then
              echo "[PASS] Fresh content being served"
            fi
          else
            echo "[INFO] No Cloudflare headers detected (may be using GitHub Pages directly)"
          fi

          echo ""
          echo "Deployment URL: ${{ steps.deployment.outputs.page_url }}"
          echo "Live URL: https://echoelmusic.com"
          echo "=============================================="

      - name: Deployment Summary
        run: |
          echo "## Website Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Pages URL | ${{ steps.deployment.outputs.page_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Live Domain | https://echoelmusic.com |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Manual Cache Purge (if needed)" >> $GITHUB_STEP_SUMMARY
          echo "Go to: [Cloudflare Dashboard](https://dash.cloudflare.com) → Caching → Configuration → Purge Everything" >> $GITHUB_STEP_SUMMARY
