# =============================================================================
# ECHOELMUSIC - WEBSITE DEPLOYMENT
# =============================================================================
# Deploys docs/ folder to GitHub Pages
# Triggers: Push to main (docs changes) or manual
# =============================================================================

name: "Deploy Website"

on:
  push:
    branches: ["main"]
    paths:
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # BUILD
  # ===========================================================================
  build:
    name: "Build"
    runs-on: ubuntu-latest
    # Skip on PRs - only deploy on push to main
    if: github.event_name != 'pull_request'
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Setup Pages"
        uses: actions/configure-pages@v4

      - name: "Upload Artifact"
        uses: actions/upload-pages-artifact@v3
        with:
          path: './docs'

  # ===========================================================================
  # DEPLOY
  # ===========================================================================
  deploy:
    name: "Deploy"
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: "Deploy to GitHub Pages"
        id: deployment
        uses: actions/deploy-pages@v4

      - name: "Purge Cloudflare Cache"
        continue-on-error: true
        env:
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "=============================================="
          echo "  CLOUDFLARE CACHE PURGE"
          echo "=============================================="

          # Skip if secrets not configured
          if [ -z "$CLOUDFLARE_ZONE_ID" ] || [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "[SKIP] Cloudflare secrets not configured"
            echo "To enable: Add CLOUDFLARE_ZONE_ID and CLOUDFLARE_API_TOKEN secrets"
            exit 0
          fi

          # Purge cache
          RESPONSE=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}/purge_cache" \
            -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}')

          if echo "$RESPONSE" | grep -q '"success":true'; then
            echo "[PASS] Cache purged successfully"
          else
            echo "[WARN] Cache purge may have failed"
            echo "$RESPONSE" | head -c 500
          fi

      - name: "Verify Deployment"
        run: |
          echo "=============================================="
          echo "  DEPLOYMENT VERIFICATION"
          echo "=============================================="

          sleep 5

          echo "Checking echoelmusic.com..."
          HTTP_CODE=$(curl -sI -o /dev/null -w "%{http_code}" "https://echoelmusic.com" 2>/dev/null || echo "000")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "[PASS] Website is live (HTTP $HTTP_CODE)"
          else
            echo "[WARN] Website check returned HTTP $HTTP_CODE"
          fi

          HEADERS=$(curl -sI "https://echoelmusic.com" 2>/dev/null || true)
          if echo "$HEADERS" | grep -qi "cf-cache-status"; then
            STATUS=$(echo "$HEADERS" | grep -i "cf-cache-status" | awk '{print $2}' | tr -d '\r')
            echo "Cloudflare Status: $STATUS"
          fi

          echo ""
          echo "GitHub Pages: ${{ steps.deployment.outputs.page_url }}"
          echo "Live URL: https://echoelmusic.com"
          echo "=============================================="

      - name: "Summary"
        run: |
          echo "# ðŸŒ Website Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Pages | ${{ steps.deployment.outputs.page_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Live Domain | https://echoelmusic.com |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Manual Cache Purge" >> $GITHUB_STEP_SUMMARY
          echo "[Cloudflare Dashboard](https://dash.cloudflare.com) â†’ Caching â†’ Purge Everything" >> $GITHUB_STEP_SUMMARY
