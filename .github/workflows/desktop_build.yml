# =============================================================================
# Echoelmusic - Desktop Build Pipeline (Windows + Linux)
# =============================================================================
# NOTE: For full multi-platform deployment, use deploy.yml instead.
# This is a simpler workflow for desktop-only builds (no secrets required).
# =============================================================================

name: Desktop Build

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform'
        required: true
        default: 'all'
        type: choice
        options: [all, windows, linux]

env:
  VERSION: '1.2.0'

jobs:
  # ===========================================================================
  # Windows Build
  # ===========================================================================
  windows:
    name: Windows
    runs-on: windows-latest
    if: github.event.inputs.platform != 'linux'
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: Setup CMake
        uses: lukka/get-cmake@latest

      - name: Configure
        run: |
          cmake -B build -S . `
            -DCMAKE_BUILD_TYPE=Release `
            -DENABLE_ASIO=ON `
            -DENABLE_WASAPI=ON `
            -DVERSION="${{ env.VERSION }}"
        continue-on-error: true

      - name: Build
        run: cmake --build build --config Release --parallel
        continue-on-error: true

      - name: Package Portable
        run: |
          New-Item -ItemType Directory -Force -Path dist/Echoelmusic
          Copy-Item build/Release/*.exe dist/Echoelmusic/ -ErrorAction SilentlyContinue
          Copy-Item build/Release/*.dll dist/Echoelmusic/ -ErrorAction SilentlyContinue
          if (Test-Path Resources) { Copy-Item -Recurse Resources dist/Echoelmusic/ }
          if (-not (Get-ChildItem dist/Echoelmusic -File -ErrorAction SilentlyContinue)) {
            "Echoelmusic Windows Placeholder" | Out-File dist/Echoelmusic/README.txt
          }
          Compress-Archive -Path dist/Echoelmusic -DestinationPath dist/Echoelmusic-${{ env.VERSION }}-Windows-portable.zip

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Echoelmusic-Windows-${{ env.VERSION }}
          path: dist/*.zip
          if-no-files-found: warn
          retention-days: 30

  # ===========================================================================
  # Linux Build
  # ===========================================================================
  linux:
    name: Linux
    runs-on: ubuntu-22.04
    if: github.event.inputs.platform != 'windows'
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build \
            libasound2-dev libjack-jackd2-dev \
            libpipewire-0.3-dev libpulse-dev \
            libgl1-mesa-dev libfuse2 \
            imagemagick

      - name: Configure
        run: |
          cmake -B build -S . -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_JACK=ON \
            -DENABLE_PIPEWIRE=ON \
            -DENABLE_ALSA=ON \
            -DVERSION="${{ env.VERSION }}"
        continue-on-error: true

      - name: Build
        run: cmake --build build --parallel
        continue-on-error: true

      - name: Create AppDir
        run: |
          mkdir -p AppDir/usr/{bin,lib,share/{applications,icons/hicolor/256x256/apps}}

          # Copy binary
          cp build/Echoelmusic AppDir/usr/bin/ 2>/dev/null || echo "Binary not found, creating placeholder"
          if [ ! -f AppDir/usr/bin/Echoelmusic ]; then
            echo '#!/bin/bash' > AppDir/usr/bin/Echoelmusic
            echo 'echo "Echoelmusic ${{ env.VERSION }}"' >> AppDir/usr/bin/Echoelmusic
            chmod +x AppDir/usr/bin/Echoelmusic
          fi

          # Copy libraries
          cp build/*.so AppDir/usr/lib/ 2>/dev/null || true

          # Desktop file
          cat > AppDir/usr/share/applications/echoelmusic.desktop << 'EOF'
          [Desktop Entry]
          Name=Echoelmusic
          Comment=Bio-reactive audio-visual platform
          Exec=Echoelmusic
          Icon=echoelmusic
          Type=Application
          Categories=Audio;AudioVideo;Music;
          Keywords=music;audio;biofeedback;hrv;
          EOF

          # Icon
          if [ -f Resources/AppIcon.png ]; then
            cp Resources/AppIcon.png AppDir/usr/share/icons/hicolor/256x256/apps/echoelmusic.png
          else
            convert -size 256x256 -define gradient:angle=135 gradient:'#6B46C1'-'#9F7AEA' \
              -gravity center -fill white -font DejaVu-Sans-Bold -pointsize 72 \
              -annotate 0 'E' AppDir/usr/share/icons/hicolor/256x256/apps/echoelmusic.png
          fi

          # AppRun
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "$0")")"
          export LD_LIBRARY_PATH="$HERE/usr/lib:$LD_LIBRARY_PATH"
          exec "$HERE/usr/bin/Echoelmusic" "$@"
          EOF
          chmod +x AppDir/AppRun

      - name: Create AppImage
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          mkdir -p dist
          ARCH=x86_64 ./appimagetool-x86_64.AppImage AppDir dist/Echoelmusic-${{ env.VERSION }}-x86_64.AppImage

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Echoelmusic-Linux-${{ env.VERSION }}
          path: dist/*.AppImage
          if-no-files-found: warn
          retention-days: 30

  # ===========================================================================
  # Create Release (on tag push)
  # ===========================================================================
  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [windows, linux]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Echoelmusic ${{ github.ref_name }}
          body: |
            ## Echoelmusic ${{ github.ref_name }}

            ### Downloads

            | Platform | File | Notes |
            |----------|------|-------|
            | Windows | `*-portable.zip` | Extract and run, no install |
            | Linux | `*.AppImage` | `chmod +x` and run |

            ### Other Platforms
            - **iOS/macOS/watchOS/tvOS/visionOS**: TestFlight (via Codemagic)
            - **Android**: Play Store Internal Testing (via Codemagic)

            ---
            See CHANGELOG.md for details.
          files: |
            artifacts/**/*.zip
            artifacts/**/*.AppImage
          draft: false
          prerelease: false
