# =============================================================================
# ECHOELMUSIC - TESTFLIGHT MANUAL DEPLOY (GUARANTEED TO WORK)
# =============================================================================
# This workflow ONLY runs when manually triggered from the Actions tab.
# It will NEVER appear in PR checks.
#
# How to use:
# 1. Go to: https://github.com/vibrationalforce/Echoelmusic/actions
# 2. Click "TestFlight Manual" in the left sidebar
# 3. Click "Run workflow" dropdown (right side)
# 4. Select branch and platforms
# 5. Click green "Run workflow" button
# =============================================================================

name: "TestFlight Manual"

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to deploy'
        required: true
        default: 'ios'
        type: choice
        options:
          - ios
          - macos
          - watchos
          - tvos
          - visionos
          - all

env:
  XCODE_VERSION: '16.2'

jobs:
  deploy:
    name: "Deploy ${{ github.event.inputs.platform }}"
    runs-on: macos-14
    timeout-minutes: 90

    steps:
      - name: "Verify Manual Trigger"
        if: github.event_name != 'workflow_dispatch'
        run: |
          echo "ERROR: This workflow only runs on manual trigger!"
          exit 1

      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Show Configuration"
        run: |
          echo "========================================"
          echo "  TESTFLIGHT DEPLOYMENT"
          echo "========================================"
          echo "Platform: ${{ github.event.inputs.platform }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Build: ${{ github.run_number }}"
          echo "========================================"

      - name: "Validate Secrets"
        env:
          KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          ERRORS=0

          echo "Checking secrets..."

          if [ -z "$KEY_ID" ]; then
            echo "MISSING: APP_STORE_CONNECT_KEY_ID"
            ERRORS=$((ERRORS + 1))
          else
            echo "OK: APP_STORE_CONNECT_KEY_ID (${#KEY_ID} chars)"
          fi

          if [ -z "$ISSUER_ID" ]; then
            echo "MISSING: APP_STORE_CONNECT_ISSUER_ID"
            ERRORS=$((ERRORS + 1))
          else
            echo "OK: APP_STORE_CONNECT_ISSUER_ID (${#ISSUER_ID} chars)"
          fi

          if [ -z "$PRIVATE_KEY" ]; then
            echo "MISSING: APP_STORE_CONNECT_PRIVATE_KEY"
            ERRORS=$((ERRORS + 1))
          else
            echo "OK: APP_STORE_CONNECT_PRIVATE_KEY (${#PRIVATE_KEY} chars)"
          fi

          if [ -z "$TEAM_ID" ]; then
            echo "MISSING: APPLE_TEAM_ID"
            ERRORS=$((ERRORS + 1))
          else
            echo "OK: APPLE_TEAM_ID (${#TEAM_ID} chars)"
          fi

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "========================================"
            echo "FAILED: $ERRORS secret(s) missing"
            echo "========================================"
            echo ""
            echo "Set secrets at:"
            echo "https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi

          echo ""
          echo "All secrets configured!"

      - name: "Setup Xcode ${{ env.XCODE_VERSION }}"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "Install Tools"
        run: |
          echo "Installing XcodeGen..."
          brew install xcodegen || true

          echo "Installing Fastlane..."
          gem install fastlane -N --no-document

          echo "Tools installed:"
          xcodegen --version
          fastlane --version

      - name: "Generate Xcode Project"
        run: |
          echo "Configuring project.yml..."
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ github.run_number }}/" project.yml

          echo "Generating Xcode project..."
          xcodegen generate --spec project.yml

          echo "Project generated successfully!"
          ls -la *.xcodeproj || true

      - name: "Setup CI Keychain"
        run: |
          KEYCHAIN_NAME="ci_deploy.keychain-db"
          KEYCHAIN_PASSWORD="${{ github.run_id }}"

          echo "Creating keychain..."
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security list-keychains -d user -s "$KEYCHAIN_NAME"
          security default-keychain -s "$KEYCHAIN_NAME"

          echo "Keychain ready: $KEYCHAIN_NAME"

          # Export for Fastlane
          echo "KEYCHAIN_PATH=$HOME/Library/Keychains/$KEYCHAIN_NAME" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

      - name: "Deploy iOS"
        if: contains('ios all', github.event.inputs.platform)
        run: fastlane ios beta
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}

      - name: "Deploy macOS"
        if: contains('macos all', github.event.inputs.platform)
        run: fastlane mac beta
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}

      - name: "Deploy watchOS"
        if: contains('watchos all', github.event.inputs.platform)
        run: fastlane ios beta_watchos
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}

      - name: "Deploy tvOS"
        if: contains('tvos all', github.event.inputs.platform)
        run: fastlane ios beta_tvos
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}

      - name: "Deploy visionOS"
        if: contains('visionos all', github.event.inputs.platform)
        run: fastlane ios beta_visionos
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}

      - name: "Cleanup Keychain"
        if: always()
        run: |
          security delete-keychain ci_deploy.keychain-db 2>/dev/null || true
          echo "Keychain cleaned up"

      - name: "Summary"
        if: always()
        run: |
          echo "# TestFlight Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | ${{ github.event.inputs.platform }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[Open App Store Connect](https://appstoreconnect.apple.com)" >> $GITHUB_STEP_SUMMARY
