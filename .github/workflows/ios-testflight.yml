# =============================================================================
# ECHOELMUSIC - iOS TESTFLIGHT (Quick Deploy)
# =============================================================================
# One-tap iOS deployment from iPhone + PR build verification
# Cost: ~$1.20 per build (TestFlight only)
# =============================================================================

name: "üì± iOS TestFlight"

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'Sources/**'
      - 'Tests/**'
      - 'Package.swift'
      - 'project.yml'
      - 'fastlane/**'
      - '.github/workflows/ios-testflight.yml'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'testflight'
        type: choice
        options:
          - testflight
          - build-only

# Concurrency: Cancel in-progress runs for same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # PR Build Check (No Secrets Required)
  # ==========================================================================
  pr-build-check:
    name: "üîç PR Build Check"
    runs-on: macos-14
    if: github.event_name == 'pull_request'

    steps:
      - name: "üì• Checkout"
        uses: actions/checkout@v4

      - name: "üîß Setup Xcode 15.4"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: "üì¶ Install XcodeGen"
        run: |
          # Install XcodeGen 2.38.0 (compatible with Xcode 15)
          curl -sL https://github.com/yonaskolb/XcodeGen/releases/download/2.38.0/xcodegen.zip -o xcodegen.zip
          unzip -o xcodegen.zip
          sudo mv xcodegen/bin/xcodegen /usr/local/bin/
          xcodegen --version

      - name: "üíæ Cache Swift Packages"
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
          key: ${{ runner.os }}-swift-ios-${{ hashFiles('Package.swift') }}

      - name: "‚öôÔ∏è Generate Xcode Project"
        run: |
          echo "Generating Xcode project..."
          # Use placeholder team ID for CI builds
          sed -i '' 's/DEVELOPMENT_TEAM: ""/DEVELOPMENT_TEAM: "XXXXXXXXXX"/' project.yml || true
          xcodegen generate --spec project.yml

          if [ -d "Echoelmusic.xcodeproj" ]; then
            echo "‚úÖ Echoelmusic.xcodeproj created successfully"
          else
            echo "‚ùå ERROR: Project generation failed"
            exit 1
          fi

      - name: "üîç Verify Metal Shader Content"
        run: |
          echo "=== Verifying Metal shaders ==="
          grep -r "^struct VertexOut\|^struct VertexIn\|^struct Uniforms" Sources/ --include="*.metal" || echo "‚úÖ No duplicated unprefixed structs"

      - name: "üî® Build iOS (Simulator - No Signing)"
        run: |
          set -o pipefail
          xcodebuild build \
            -project Echoelmusic.xcodeproj \
            -scheme Echoelmusic \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            COMPILER_INDEX_STORE_ENABLE=NO \
            2>&1 | tee build.log | head -500

          # Check for success
          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo ""
            echo "‚úÖ iOS Build SUCCESSFUL"
          else
            echo ""
            echo "‚ùå Build failed - showing errors:"
            grep -E "error:|fatal error:|cannot find" build.log | head -50
            exit 1
          fi

      - name: "üìã Show Build Errors on Failure"
        if: failure()
        run: |
          echo "=== Build Errors ==="
          if [ -f build.log ]; then
            grep -E "error:|warning:|fatal" build.log | head -100
          fi

      - name: "‚úÖ PR Check Complete"
        run: |
          echo "========================================"
          echo "  ‚úÖ PR BUILD CHECK PASSED"
          echo "========================================"
          echo "  The iOS app builds successfully."
          echo "  Merge this PR and run TestFlight"
          echo "  deploy manually if needed."
          echo "========================================"

  # ==========================================================================
  # TestFlight Deploy (Manual Trigger Only)
  # ==========================================================================
  ios-testflight:
    name: "üì± Build & Deploy iOS"
    runs-on: macos-14
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: "üì• Checkout"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: "üîç Verify Metal Shader Content"
        run: |
          echo "=== Verifying Metal shaders have unique symbol names ==="
          echo ""
          echo "Checking for duplicated struct names:"
          grep -r "^struct VertexOut\|^struct VertexIn\|^struct Uniforms" Sources/ --include="*.metal" || echo "‚úÖ No duplicated unprefixed structs found"
          echo ""
          echo "Checking for duplicated function names:"
          grep -r "^float hash\|^float noise\|^float fbm\|^float3 hsv2rgb" Sources/ --include="*.metal" || echo "‚úÖ No duplicated unprefixed functions found"
          echo ""
          echo "Prefixed struct definitions:"
          grep -r "^struct.*Vertex\|^struct.*Uniforms" Sources/ --include="*.metal"
          echo ""
          echo "Prefixed function definitions:"
          grep -rE "^float (cymatics|advanced|echoel)(Hash|Noise|Fbm)|^float3 (cymatics|advanced)Hsv2rgb" Sources/ --include="*.metal"

      - name: "üîê Verify Secrets"
        run: |
          MISSING=false
          [ -z "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" ] && echo "‚ùå Missing: APP_STORE_CONNECT_KEY_ID" && MISSING=true
          [ -z "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}" ] && echo "‚ùå Missing: APP_STORE_CONNECT_ISSUER_ID" && MISSING=true
          [ -z "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" ] && echo "‚ùå Missing: APP_STORE_CONNECT_PRIVATE_KEY" && MISSING=true
          [ -z "${{ secrets.APPLE_TEAM_ID }}" ] && echo "‚ùå Missing: APPLE_TEAM_ID" && MISSING=true
          [ "$MISSING" = true ] && exit 1
          echo "‚úÖ All secrets configured!"

      - name: "üíæ Cache Swift Packages"
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
          key: ${{ runner.os }}-swift-ios-${{ hashFiles('Package.swift') }}

      - name: "üîß Setup Xcode 15.4"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: "üì¶ Install Tools"
        run: |
          # Install XcodeGen 2.38.0 (last version with Xcode 15 project format)
          curl -sL https://github.com/yonaskolb/XcodeGen/releases/download/2.38.0/xcodegen.zip -o xcodegen.zip
          unzip -o xcodegen.zip
          sudo mv xcodegen/bin/xcodegen /usr/local/bin/
          xcodegen --version

          gem install fastlane -N

      - name: "‚öôÔ∏è Configure Project"
        run: |
          echo "Setting DEVELOPMENT_TEAM..."
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml

          echo "Running XcodeGen..."
          xcodegen generate --spec project.yml

          echo "Verifying project was created..."
          if [ -d "Echoelmusic.xcodeproj" ]; then
            echo "‚úÖ Echoelmusic.xcodeproj created successfully"
            ls -la Echoelmusic.xcodeproj/
          else
            echo "‚ùå ERROR: Echoelmusic.xcodeproj was not created!"
            echo "XcodeGen output above should show the error."
            exit 1
          fi

      - name: "üîë Setup CI Keychain"
        run: |
          # Create a temporary keychain for CI
          KEYCHAIN_NAME="ci_signing.keychain-db"
          KEYCHAIN_PASSWORD="ci_password_$RANDOM"

          # Create and configure keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"

          # Add to search list and make default
          security list-keychains -d user -s "$KEYCHAIN_NAME" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_NAME"

          # Export for Fastlane
          echo "KEYCHAIN_PATH=$HOME/Library/Keychains/$KEYCHAIN_NAME" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

          echo "‚úÖ CI Keychain created: $KEYCHAIN_NAME"

      - name: "üî® Build & Upload via Fastlane"
        id: build
        run: |
          # Create log directory
          mkdir -p build_logs

          if [ "${{ github.event.inputs.build_type }}" == "testflight" ]; then
            echo "Building and uploading to TestFlight..."
            fastlane ios beta 2>&1 | tee build_logs/fastlane.log
          else
            echo "Building only (no upload)..."
            fastlane ios build_only 2>&1 | tee build_logs/fastlane.log
          fi
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          KEYCHAIN_PATH: ${{ env.KEYCHAIN_PATH }}
          KEYCHAIN_PASSWORD: ${{ env.KEYCHAIN_PASSWORD }}

      - name: "üìã Show Build Errors on Failure"
        if: failure()
        run: |
          echo "========================================"
          echo "  ‚ùå BUILD FAILED - SHOWING ERRORS"
          echo "========================================"
          echo ""
          echo "=== Swift Compilation Errors ==="
          grep -E "error:|fatal error:|cannot find|no such module" build_logs/fastlane.log | head -100 || true
          echo ""
          echo "=== Full Error Context ==="
          grep -B 5 -A 5 "error:" build_logs/fastlane.log | head -200 || true

      - name: "üì¶ Upload Build Logs"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            build_logs/
            ~/Library/Logs/gym/*.log
          retention-days: 7

      - name: "‚úÖ Success"
        run: |
          echo "========================================"
          echo "  üéâ iOS BUILD SUCCESSFUL!"
          echo "========================================"
          if [ "${{ github.event.inputs.build_type }}" = "testflight" ]; then
            echo "  üì± Check TestFlight for new build"
            echo "  ‚è±Ô∏è  Processing takes 15-30 minutes"
          else
            echo "  ‚úÖ Build completed (not uploaded)"
          fi
          echo "========================================"
