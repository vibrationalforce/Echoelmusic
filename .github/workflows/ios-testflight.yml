# =============================================================================
# ECHOELMUSIC - MULTI-PLATFORM TESTFLIGHT DEPLOYMENT
# =============================================================================
# Lambda Loop A++++ Optimized Workflow - ALL Apple Ecosystems
# Version: 3.0.0 - Phase 10000 ULTIMATE MODE
#
# Supported Platforms:
# - iOS (iPhone + iPad) with integrated AUv3 (works as host and plugin)
# - macOS (Apple Silicon + Intel) with embedded AUv3 Audio Unit Extension
# - watchOS (Apple Watch) with Complications
# - tvOS (Apple TV) with Big Screen Experience
# - visionOS (Apple Vision Pro) with Spatial Audio
#
# ARCHITECTURE:
# - PR Events -> pr-check job (simulator build, no secrets)
# - Manual Dispatch -> platform-specific deploy jobs (TestFlight, requires secrets)
# =============================================================================

name: "TestFlight Multi-Platform"

on:
  # PR build validation (no secrets required)
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
    paths:
      - 'Sources/**'
      - 'Tests/**'
      - 'Package.swift'
      - 'project.yml'
      - 'fastlane/**'
      - '.github/workflows/ios-testflight.yml'

  # Manual TestFlight deployment (secrets required)
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Platforms to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ios
          - macos
          - watchos
          - tvos
          - visionos
          - ios-macos
      increment_build:
        description: 'Auto-increment build number'
        required: false
        default: true
        type: boolean
      clean_build:
        description: 'Clean build (slower but fresh)'
        required: false
        default: false
        type: boolean

# Cancel in-progress runs for the same PR/ref
concurrency:
  group: testflight-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

env:
  XCODE_VERSION: '15.4'
  XCODEGEN_VERSION: '2.42.0'

jobs:
  # ===========================================================================
  # JOB 0: Pre-flight Validation (Runs before deployment)
  # ===========================================================================
  preflight:
    name: "Pre-flight Check"
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    timeout-minutes: 5

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Pre-flight Validation"
        run: |
          echo "=============================================="
          echo "  ECHOELMUSIC PRE-FLIGHT VALIDATION"
          echo "=============================================="

          ERRORS=0

          # Check required files
          echo "--- Checking Required Files ---"
          for file in Package.swift project.yml fastlane/Fastfile fastlane/Appfile; do
            if [[ -f "$file" ]]; then
              echo "[PASS] $file exists"
            else
              echo "[FAIL] $file is missing"
              ((ERRORS++))
            fi
          done

          # Check Bundle ID consistency
          echo ""
          echo "--- Checking Bundle ID ---"
          BUNDLE_ID="com.echoelmusic.app"
          if grep -q "$BUNDLE_ID" fastlane/Appfile; then
            echo "[PASS] Bundle ID consistent: $BUNDLE_ID"
          else
            echo "[FAIL] Bundle ID mismatch"
            ((ERRORS++))
          fi

          # Check metadata
          echo ""
          echo "--- Checking Metadata ---"
          for meta in description.txt keywords.txt release_notes.txt privacy_url.txt; do
            if [[ -s "fastlane/metadata/en-US/$meta" ]]; then
              echo "[PASS] $meta has content"
            else
              echo "[FAIL] $meta is empty or missing"
              ((ERRORS++))
            fi
          done

          # Check version
          echo ""
          echo "--- Checking Version ---"
          VERSION=$(grep "MARKETING_VERSION:" project.yml | head -1 | sed 's/.*: *//' | tr -d '"')
          echo "[INFO] Marketing version: $VERSION"

          # Summary
          echo ""
          echo "=============================================="
          if [[ $ERRORS -gt 0 ]]; then
            echo "[FAIL] Pre-flight check failed with $ERRORS error(s)"
            exit 1
          else
            echo "[PASS] Pre-flight check passed"
          fi

      - name: "Deployment Summary"
        run: |
          echo "## Pre-flight Check Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Required Files | Verified |" >> $GITHUB_STEP_SUMMARY
          echo "| Bundle ID | Consistent |" >> $GITHUB_STEP_SUMMARY
          echo "| Metadata | Complete |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | $(grep 'MARKETING_VERSION:' project.yml | head -1 | sed 's/.*: *//' | tr -d '\"') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platforms:** ${{ github.event.inputs.platforms }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # JOB 1: PR Build Check (Simulator - No Secrets Required)
  # ===========================================================================
  pr-check:
    name: "PR Build Check"
    runs-on: macos-14
    # Only run on pull_request events, skip for manual workflow_dispatch
    if: github.event_name == 'pull_request'
    timeout-minutes: 30

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "Event Info"
        run: |
          echo "====================================="
          echo "  TestFlight - PR Build Check"
          echo "====================================="
          echo "PR: #${{ github.event.pull_request.number }}"
          echo "Branch: ${{ github.head_ref }} -> ${{ github.base_ref }}"
          echo "Runner: $(uname -a)"
          echo "====================================="

      - name: "Validate Required Files"
        run: |
          echo "Checking required files..."
          ERRORS=0
          for file in Package.swift project.yml fastlane/Fastfile; do
            if [[ -f "$file" ]]; then
              echo "[OK] $file exists"
            else
              echo "[ERROR] $file is missing"
              ((ERRORS++))
            fi
          done
          if [[ $ERRORS -gt 0 ]]; then
            echo "Missing required files!"
            exit 1
          fi
          echo "All required files present"

      - name: "Setup Xcode"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "15.4"

      - name: "Install XcodeGen"
        run: |
          echo "Installing XcodeGen..."
          if ! command -v xcodegen &> /dev/null; then
            echo "Installing XcodeGen via Homebrew..."
            brew install xcodegen || {
              echo "Homebrew install failed, trying direct download..."
              curl -fsSL https://github.com/yonaskolb/XcodeGen/releases/download/2.42.0/xcodegen.zip -o /tmp/xcodegen.zip
              unzip -o /tmp/xcodegen.zip -d /tmp
              sudo cp /tmp/xcodegen/bin/xcodegen /usr/local/bin/
              chmod +x /usr/local/bin/xcodegen
            }
          fi
          xcodegen --version

      - name: "Cache Swift Packages"
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
            build/DerivedData
          key: ${{ runner.os }}-swift-${{ hashFiles('Package.swift') }}-${{ hashFiles('project.yml') }}
          restore-keys: |
            ${{ runner.os }}-swift-

      - name: "Generate Xcode Project"
        run: |
          set -e
          echo "Preparing project.yml for CI..."
          # Replace empty DEVELOPMENT_TEAM with placeholder for CI builds
          sed -i '' 's/DEVELOPMENT_TEAM: ""/DEVELOPMENT_TEAM: "XXXXXXXXXX"/' project.yml 2>/dev/null || true

          echo "Generating Xcode project..."
          xcodegen generate --spec project.yml

          if [ -d "Echoelmusic.xcodeproj" ]; then
            echo "Xcode project generated successfully"
            ls -la Echoelmusic.xcodeproj/
          else
            echo "ERROR: Xcode project generation failed"
            exit 1
          fi

      - name: "List Available Simulators"
        run: |
          echo "Available iOS Simulators:"
          xcrun simctl list devices available | grep -E "iPhone|iPad" | head -20 || true

      - name: "Build iOS for Simulator"
        run: |
          set -o pipefail
          echo "Building iOS app for simulator..."

          # Try iPhone 15 Pro first, fallback to any available iPhone
          DESTINATION='platform=iOS Simulator,name=iPhone 15 Pro'
          if ! xcrun simctl list devices available | grep -q "iPhone 15 Pro"; then
            DESTINATION='platform=iOS Simulator,OS=latest,name=iPhone 16 Pro'
            echo "Using fallback destination: $DESTINATION"
          fi

          xcodebuild build \
            -project Echoelmusic.xcodeproj \
            -scheme Echoelmusic \
            -destination "$DESTINATION" \
            -configuration Debug \
            -derivedDataPath build/DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            COMPILER_INDEX_STORE_ENABLE=NO \
            -quiet \
            2>&1 | tee build_ios.log || {
              echo "Build failed, showing last 100 lines of log:"
              tail -100 build_ios.log
              exit 1
            }
          echo "iOS build successful"

      - name: "Build macOS"
        run: |
          set -o pipefail
          echo "Building macOS app..."
          xcodebuild build \
            -project Echoelmusic.xcodeproj \
            -scheme Echoelmusic-macOS \
            -configuration Debug \
            -derivedDataPath build/DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            COMPILER_INDEX_STORE_ENABLE=NO \
            -quiet \
            2>&1 | tee build_macos.log || {
              echo "Build failed, showing last 100 lines of log:"
              tail -100 build_macos.log
              exit 1
            }
          echo "macOS build successful"

      - name: "Build Summary"
        if: success()
        run: |
          echo "## PR Build Check Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| iOS Simulator | Built |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | Built |" >> $GITHUB_STEP_SUMMARY

      - name: "Upload Build Logs"
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pr-build-logs-${{ github.event.pull_request.number }}
          path: |
            build_*.log
            Echoelmusic.xcodeproj/
          retention-days: 7

  # ===========================================================================
  # JOB 2: iOS TestFlight Deployment (AUv3 integrated in app)
  # ===========================================================================
  deploy-ios:
    name: "Deploy iOS"
    runs-on: macos-14
    needs: [preflight]
    # Only run on manual workflow_dispatch with ios platform selected
    if: github.event_name == 'workflow_dispatch' && contains('all ios ios-macos', github.event.inputs.platforms)
    timeout-minutes: 60

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Deployment Info"
        run: |
          echo "====================================="
          echo "  iOS TestFlight Deployment"
          echo "  (AUv3 integrated in app)"
          echo "====================================="
          echo "Build Number: ${{ github.run_number }}"

      - name: "Verify Secrets"
        run: |
          [ -n "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" ] || { echo "ERROR: ASC_KEY_ID missing"; exit 1; }
          [ -n "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}" ] || { echo "ERROR: ASC_ISSUER_ID missing"; exit 1; }
          [ -n "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" ] || { echo "ERROR: ASC_KEY missing"; exit 1; }
          [ -n "${{ secrets.APPLE_TEAM_ID }}" ] || { echo "ERROR: TEAM_ID missing"; exit 1; }
          echo "All secrets verified"

      - name: "Setup Xcode & XcodeGen"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "Setup XcodeGen"
        uses: ./.github/actions/setup-xcodegen
        with:
          version: ${{ env.XCODEGEN_VERSION }}

      - name: "Cache"
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            build/DerivedData
            vendor/bundle
          key: ${{ runner.os }}-ios-${{ hashFiles('Package.swift', 'project.yml', '**/Gemfile.lock') }}-${{ github.run_number }}
          restore-keys: ${{ runner.os }}-ios-

      - name: "Install Fastlane"
        run: |
          gem install bundler -N --no-document 2>/dev/null || true
          [ -f Gemfile ] && bundle install --jobs 4 --retry 3 || gem install fastlane -N --no-document
          fastlane --version

      - name: "Generate Xcode Project"
        run: |
          set -e
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ github.run_number }}/" project.yml
          xcodegen generate --spec project.yml

      - name: "Setup Keychain"
        run: |
          KEYCHAIN_NAME="ci_signing_${{ github.run_id }}.keychain-db"
          KEYCHAIN_PASSWORD="ci_password_${{ github.run_id }}"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security list-keychains -d user -s "$KEYCHAIN_NAME" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_NAME"
          echo "KEYCHAIN_PATH=$HOME/Library/Keychains/$KEYCHAIN_NAME" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

      - name: "Deploy to TestFlight"
        run: |
          fastlane ios beta
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}
          CLEAN_BUILD: ${{ github.event.inputs.clean_build }}

      - name: "Cleanup Keychain"
        if: always()
        run: security delete-keychain "${{ env.KEYCHAIN_PATH }}" 2>/dev/null || true

      - name: "Success"
        run: |
          echo "## iOS Deployed to TestFlight" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- Bundle ID: com.echoelmusic.app (Standalone + integrated AUv3)" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # JOB 3: macOS + AUv3 TestFlight Deployment
  # ===========================================================================
  deploy-macos:
    name: "Deploy macOS + AUv3"
    runs-on: macos-14
    needs: [preflight]
    # Only run on manual workflow_dispatch with macos platform selected
    if: github.event_name == 'workflow_dispatch' && contains('all macos ios-macos', github.event.inputs.platforms)
    timeout-minutes: 60

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Deployment Info"
        run: |
          echo "====================================="
          echo "  macOS + AUv3 TestFlight Deployment"
          echo "====================================="

      - name: "Verify Secrets"
        run: |
          [ -n "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" ] || exit 1
          [ -n "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}" ] || exit 1
          [ -n "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" ] || exit 1
          [ -n "${{ secrets.APPLE_TEAM_ID }}" ] || exit 1

      - name: "Setup Xcode & XcodeGen"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "Setup XcodeGen"
        uses: ./.github/actions/setup-xcodegen
        with:
          version: ${{ env.XCODEGEN_VERSION }}

      - name: "Cache"
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            build/DerivedData
            vendor/bundle
          key: ${{ runner.os }}-macos-${{ hashFiles('Package.swift', 'project.yml') }}-${{ github.run_number }}
          restore-keys: ${{ runner.os }}-macos-

      - name: "Install Fastlane"
        run: |
          gem install bundler -N --no-document 2>/dev/null || true
          [ -f Gemfile ] && bundle install --jobs 4 --retry 3 || gem install fastlane -N --no-document

      - name: "Generate Xcode Project"
        run: |
          set -e
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ github.run_number }}/" project.yml
          xcodegen generate --spec project.yml

      - name: "Setup Keychain"
        run: |
          KEYCHAIN_NAME="ci_signing_macos_${{ github.run_id }}.keychain-db"
          KEYCHAIN_PASSWORD="ci_password_${{ github.run_id }}"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security list-keychains -d user -s "$KEYCHAIN_NAME" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_NAME"
          echo "KEYCHAIN_PATH=$HOME/Library/Keychains/$KEYCHAIN_NAME" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

      - name: "Deploy to TestFlight"
        run: |
          fastlane mac beta
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}
          CLEAN_BUILD: ${{ github.event.inputs.clean_build }}

      - name: "Cleanup Keychain"
        if: always()
        run: security delete-keychain "${{ env.KEYCHAIN_PATH }}" 2>/dev/null || true

      - name: "Success"
        run: |
          echo "## macOS Deployed to TestFlight" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- Bundle ID: com.echoelmusic.app (Standalone + embedded AUv3)" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # JOB 4: watchOS TestFlight Deployment
  # ===========================================================================
  deploy-watchos:
    name: "Deploy watchOS"
    runs-on: macos-14
    needs: [preflight]
    # Only run on manual workflow_dispatch with watchos platform selected
    if: github.event_name == 'workflow_dispatch' && contains('all watchos', github.event.inputs.platforms)
    timeout-minutes: 60

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Verify Secrets"
        run: |
          [ -n "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" ] || exit 1
          [ -n "${{ secrets.APPLE_TEAM_ID }}" ] || exit 1

      - name: "Setup Xcode & XcodeGen"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "Setup XcodeGen"
        uses: ./.github/actions/setup-xcodegen
        with:
          version: ${{ env.XCODEGEN_VERSION }}

      - name: "Install Fastlane"
        run: gem install fastlane -N --no-document

      - name: "Generate Xcode Project"
        run: |
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ github.run_number }}/" project.yml
          xcodegen generate --spec project.yml

      - name: "Setup Keychain"
        run: |
          KEYCHAIN_NAME="ci_signing_watch_${{ github.run_id }}.keychain-db"
          KEYCHAIN_PASSWORD="ci_password_${{ github.run_id }}"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security list-keychains -d user -s "$KEYCHAIN_NAME" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_NAME"
          echo "KEYCHAIN_PATH=$HOME/Library/Keychains/$KEYCHAIN_NAME" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

      - name: "Deploy to TestFlight"
        run: fastlane ios beta_watchos
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}

      - name: "Cleanup"
        if: always()
        run: security delete-keychain "${{ env.KEYCHAIN_PATH }}" 2>/dev/null || true

      - name: "Success"
        run: |
          echo "## watchOS Deployed to TestFlight" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # JOB 5: tvOS TestFlight Deployment
  # ===========================================================================
  deploy-tvos:
    name: "Deploy tvOS"
    runs-on: macos-14
    needs: [preflight]
    # Only run on manual workflow_dispatch with tvos platform selected
    if: github.event_name == 'workflow_dispatch' && contains('all tvos', github.event.inputs.platforms)
    timeout-minutes: 60

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Verify Secrets"
        run: |
          [ -n "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" ] || exit 1
          [ -n "${{ secrets.APPLE_TEAM_ID }}" ] || exit 1

      - name: "Setup Xcode & XcodeGen"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "Setup XcodeGen"
        uses: ./.github/actions/setup-xcodegen
        with:
          version: ${{ env.XCODEGEN_VERSION }}

      - name: "Install Fastlane"
        run: gem install fastlane -N --no-document

      - name: "Generate Xcode Project"
        run: |
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ github.run_number }}/" project.yml
          xcodegen generate --spec project.yml

      - name: "Setup Keychain"
        run: |
          KEYCHAIN_NAME="ci_signing_tv_${{ github.run_id }}.keychain-db"
          KEYCHAIN_PASSWORD="ci_password_${{ github.run_id }}"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security list-keychains -d user -s "$KEYCHAIN_NAME" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_NAME"
          echo "KEYCHAIN_PATH=$HOME/Library/Keychains/$KEYCHAIN_NAME" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

      - name: "Deploy to TestFlight"
        run: fastlane ios beta_tvos
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}

      - name: "Cleanup"
        if: always()
        run: security delete-keychain "${{ env.KEYCHAIN_PATH }}" 2>/dev/null || true

      - name: "Success"
        run: |
          echo "## tvOS Deployed to TestFlight" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # JOB 6: visionOS TestFlight Deployment
  # ===========================================================================
  deploy-visionos:
    name: "Deploy visionOS"
    runs-on: macos-14
    needs: [preflight]
    # Only run on manual workflow_dispatch with visionos platform selected
    if: github.event_name == 'workflow_dispatch' && contains('all visionos', github.event.inputs.platforms)
    timeout-minutes: 60

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Verify Secrets"
        run: |
          [ -n "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" ] || exit 1
          [ -n "${{ secrets.APPLE_TEAM_ID }}" ] || exit 1

      - name: "Setup Xcode & XcodeGen"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "Setup XcodeGen"
        uses: ./.github/actions/setup-xcodegen
        with:
          version: ${{ env.XCODEGEN_VERSION }}

      - name: "Install Fastlane"
        run: gem install fastlane -N --no-document

      - name: "Generate Xcode Project"
        run: |
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ github.run_number }}/" project.yml
          xcodegen generate --spec project.yml

      - name: "Setup Keychain"
        run: |
          KEYCHAIN_NAME="ci_signing_vision_${{ github.run_id }}.keychain-db"
          KEYCHAIN_PASSWORD="ci_password_${{ github.run_id }}"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security list-keychains -d user -s "$KEYCHAIN_NAME" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_NAME"
          echo "KEYCHAIN_PATH=$HOME/Library/Keychains/$KEYCHAIN_NAME" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

      - name: "Deploy to TestFlight"
        run: fastlane ios beta_visionos
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}

      - name: "Cleanup"
        if: always()
        run: security delete-keychain "${{ env.KEYCHAIN_PATH }}" 2>/dev/null || true

      - name: "Success"
        run: |
          echo "## visionOS Deployed to TestFlight" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # JOB 7: Deployment Summary
  # ===========================================================================
  summary:
    name: "Deployment Summary"
    runs-on: ubuntu-latest
    # Only show summary for manual workflow_dispatch, not for PR builds
    if: always() && github.event_name == 'workflow_dispatch'
    needs: [preflight, deploy-ios, deploy-macos, deploy-watchos, deploy-tvos, deploy-visionos]

    steps:
      - name: "Generate Summary"
        run: |
          echo "# TestFlight Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ github.event.inputs.platforms }}" == "all" || "${{ github.event.inputs.platforms }}" == "ios" || "${{ github.event.inputs.platforms }}" == "ios-macos" ]]; then
            echo "| iOS (integrated AUv3) | ${{ needs.deploy-ios.result == 'success' && 'Deployed' || needs.deploy-ios.result == 'skipped' && 'Skipped' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ github.event.inputs.platforms }}" == "all" || "${{ github.event.inputs.platforms }}" == "macos" || "${{ github.event.inputs.platforms }}" == "ios-macos" ]]; then
            echo "| macOS + AUv3 | ${{ needs.deploy-macos.result == 'success' && 'Deployed' || needs.deploy-macos.result == 'skipped' && 'Skipped' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ github.event.inputs.platforms }}" == "all" || "${{ github.event.inputs.platforms }}" == "watchos" ]]; then
            echo "| watchOS | ${{ needs.deploy-watchos.result == 'success' && 'Deployed' || needs.deploy-watchos.result == 'skipped' && 'Skipped' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ github.event.inputs.platforms }}" == "all" || "${{ github.event.inputs.platforms }}" == "tvos" ]]; then
            echo "| tvOS | ${{ needs.deploy-tvos.result == 'success' && 'Deployed' || needs.deploy-tvos.result == 'skipped' && 'Skipped' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ github.event.inputs.platforms }}" == "all" || "${{ github.event.inputs.platforms }}" == "visionos" ]]; then
            echo "| visionOS | ${{ needs.deploy-visionos.result == 'success' && 'Deployed' || needs.deploy-visionos.result == 'skipped' && 'Skipped' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check [App Store Connect](https://appstoreconnect.apple.com) for build processing status." >> $GITHUB_STEP_SUMMARY
