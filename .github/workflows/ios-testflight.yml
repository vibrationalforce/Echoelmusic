# =============================================================================
# ECHOELMUSIC - MULTI-PLATFORM TESTFLIGHT DEPLOYMENT
# =============================================================================
# Lambda Loop A++++ Optimized Workflow - ALL Apple Ecosystems
# Version: 3.0.0 - Phase 10000 ULTIMATE MODE
#
# Supported Platforms:
# - iOS (iPhone + iPad) with AUv3 Audio Unit Extension
# - macOS (Apple Silicon + Intel) with AUv3 Audio Unit Extension
# - watchOS (Apple Watch) with Complications
# - tvOS (Apple TV) with Big Screen Experience
# - visionOS (Apple Vision Pro) with Spatial Audio
#
# ARCHITECTURE:
# - PR Events -> pr-check job (simulator build, no secrets)
# - Manual Dispatch -> platform-specific deploy jobs (TestFlight, requires secrets)
# =============================================================================

name: "TestFlight Multi-Platform"

on:
  # PR build validation (no secrets required)
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
    paths:
      - 'Sources/**'
      - 'Tests/**'
      - 'Package.swift'
      - 'project.yml'
      - 'fastlane/**'
      - '.github/workflows/ios-testflight.yml'

  # Manual TestFlight deployment (secrets required)
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Platforms to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ios
          - macos
          - watchos
          - tvos
          - visionos
          - ios-macos
      increment_build:
        description: 'Auto-increment build number'
        required: false
        default: true
        type: boolean
      clean_build:
        description: 'Clean build (slower but fresh)'
        required: false
        default: false
        type: boolean

# Cancel in-progress runs for the same PR/ref
concurrency:
  group: testflight-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

env:
  XCODE_VERSION: '15.4'
  XCODEGEN_VERSION: '2.42.0'

jobs:
  # ===========================================================================
  # JOB 1: PR Build Check (Simulator - No Secrets Required)
  # ===========================================================================
  pr-check:
    name: "PR Build Check"
    runs-on: macos-14
    # Only run on pull_request events, skip for manual workflow_dispatch
    if: github.event_name == 'pull_request'
    timeout-minutes: 30

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "Event Info"
        run: |
          echo "====================================="
          echo "  TestFlight - PR Build Check"
          echo "====================================="
          echo "PR: #${{ github.event.pull_request.number }}"
          echo "Branch: ${{ github.head_ref }} -> ${{ github.base_ref }}"

      - name: "Setup Xcode"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "15.4"

      - name: "Install XcodeGen"
        run: |
          if ! command -v xcodegen &> /dev/null; then
            echo "Installing XcodeGen via Homebrew..."
            brew install xcodegen
          else
            echo "XcodeGen already installed"
          fi
          xcodegen --version

      - name: "Cache Swift Packages"
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
            build/DerivedData
          key: ${{ runner.os }}-swift-${{ hashFiles('Package.swift') }}-${{ hashFiles('project.yml') }}
          restore-keys: |
            ${{ runner.os }}-swift-

      - name: "Generate Xcode Project"
        run: |
          set -e
          if grep -q 'DEVELOPMENT_TEAM: ""' project.yml 2>/dev/null; then
            sed -i '' 's/DEVELOPMENT_TEAM: ""/DEVELOPMENT_TEAM: "XXXXXXXXXX"/' project.yml
          fi
          xcodegen generate --spec project.yml
          [ -d "Echoelmusic.xcodeproj" ] || exit 1

      - name: "Build iOS for Simulator"
        run: |
          set -o pipefail
          xcodebuild build \
            -project Echoelmusic.xcodeproj \
            -scheme Echoelmusic \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
            -configuration Debug \
            -derivedDataPath build/DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            COMPILER_INDEX_STORE_ENABLE=NO \
            2>&1 | tee build_ios.log
          echo "iOS build successful"

      - name: "Build macOS"
        run: |
          set -o pipefail
          xcodebuild build \
            -project Echoelmusic.xcodeproj \
            -scheme Echoelmusic-macOS \
            -configuration Debug \
            -derivedDataPath build/DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            COMPILER_INDEX_STORE_ENABLE=NO \
            2>&1 | tee build_macos.log
          echo "macOS build successful"

      - name: "Upload Build Logs"
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pr-build-logs-${{ github.event.pull_request.number }}
          path: build_*.log
          retention-days: 7

  # ===========================================================================
  # JOB 2: iOS + AUv3 TestFlight Deployment
  # ===========================================================================
  deploy-ios:
    name: "Deploy iOS + AUv3"
    runs-on: macos-14
    # Only run on manual workflow_dispatch with ios platform selected
    if: github.event_name == 'workflow_dispatch' && contains('all ios ios-macos', inputs.platforms)
    timeout-minutes: 60

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Deployment Info"
        run: |
          echo "====================================="
          echo "  iOS + AUv3 TestFlight Deployment"
          echo "====================================="
          echo "Build Number: ${{ github.run_number }}"

      - name: "Verify Secrets"
        run: |
          [ -n "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" ] || { echo "ERROR: ASC_KEY_ID missing"; exit 1; }
          [ -n "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}" ] || { echo "ERROR: ASC_ISSUER_ID missing"; exit 1; }
          [ -n "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" ] || { echo "ERROR: ASC_KEY missing"; exit 1; }
          [ -n "${{ secrets.APPLE_TEAM_ID }}" ] || { echo "ERROR: TEAM_ID missing"; exit 1; }
          echo "All secrets verified"

      - name: "Setup Xcode & XcodeGen"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "Setup XcodeGen"
        uses: ./.github/actions/setup-xcodegen
        with:
          version: ${{ env.XCODEGEN_VERSION }}

      - name: "Cache"
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            build/DerivedData
            vendor/bundle
          key: ${{ runner.os }}-ios-${{ hashFiles('Package.swift', 'project.yml', '**/Gemfile.lock') }}-${{ github.run_number }}
          restore-keys: ${{ runner.os }}-ios-

      - name: "Install Fastlane"
        run: |
          gem install bundler -N --no-document 2>/dev/null || true
          [ -f Gemfile ] && bundle install --jobs 4 --retry 3 || gem install fastlane -N --no-document
          fastlane --version

      - name: "Generate Xcode Project"
        run: |
          set -e
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ github.run_number }}/" project.yml
          xcodegen generate --spec project.yml

      - name: "Setup Keychain"
        run: |
          KEYCHAIN_NAME="ci_signing_${{ github.run_id }}.keychain-db"
          KEYCHAIN_PASSWORD="ci_password_${{ github.run_id }}"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security list-keychains -d user -s "$KEYCHAIN_NAME" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_NAME"
          echo "KEYCHAIN_PATH=$HOME/Library/Keychains/$KEYCHAIN_NAME" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

      - name: "Deploy to TestFlight"
        run: |
          fastlane ios beta
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}
          CLEAN_BUILD: ${{ github.event.inputs.clean_build }}

      - name: "Cleanup Keychain"
        if: always()
        run: security delete-keychain "${{ env.KEYCHAIN_PATH }}" 2>/dev/null || true

      - name: "Success"
        run: |
          echo "## iOS + AUv3 Deployed to TestFlight" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- Bundle IDs: com.echoelmusic.app, com.echoelmusic.app.auv3" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # JOB 3: macOS + AUv3 TestFlight Deployment
  # ===========================================================================
  deploy-macos:
    name: "Deploy macOS + AUv3"
    runs-on: macos-14
    # Only run on manual workflow_dispatch with macos platform selected
    if: github.event_name == 'workflow_dispatch' && contains('all macos ios-macos', inputs.platforms)
    timeout-minutes: 60

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Deployment Info"
        run: |
          echo "====================================="
          echo "  macOS + AUv3 TestFlight Deployment"
          echo "====================================="

      - name: "Verify Secrets"
        run: |
          [ -n "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" ] || exit 1
          [ -n "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}" ] || exit 1
          [ -n "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" ] || exit 1
          [ -n "${{ secrets.APPLE_TEAM_ID }}" ] || exit 1

      - name: "Setup Xcode & XcodeGen"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "Setup XcodeGen"
        uses: ./.github/actions/setup-xcodegen
        with:
          version: ${{ env.XCODEGEN_VERSION }}

      - name: "Cache"
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            build/DerivedData
            vendor/bundle
          key: ${{ runner.os }}-macos-${{ hashFiles('Package.swift', 'project.yml') }}-${{ github.run_number }}
          restore-keys: ${{ runner.os }}-macos-

      - name: "Install Fastlane"
        run: |
          gem install bundler -N --no-document 2>/dev/null || true
          [ -f Gemfile ] && bundle install --jobs 4 --retry 3 || gem install fastlane -N --no-document

      - name: "Generate Xcode Project"
        run: |
          set -e
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ github.run_number }}/" project.yml
          xcodegen generate --spec project.yml

      - name: "Setup Keychain"
        run: |
          KEYCHAIN_NAME="ci_signing_macos_${{ github.run_id }}.keychain-db"
          KEYCHAIN_PASSWORD="ci_password_${{ github.run_id }}"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security list-keychains -d user -s "$KEYCHAIN_NAME" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_NAME"
          echo "KEYCHAIN_PATH=$HOME/Library/Keychains/$KEYCHAIN_NAME" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

      - name: "Deploy to TestFlight"
        run: |
          fastlane mac beta
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}
          CLEAN_BUILD: ${{ github.event.inputs.clean_build }}

      - name: "Cleanup Keychain"
        if: always()
        run: security delete-keychain "${{ env.KEYCHAIN_PATH }}" 2>/dev/null || true

      - name: "Success"
        run: |
          echo "## macOS + AUv3 Deployed to TestFlight" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- Bundle IDs: com.echoelmusic.mac, com.echoelmusic.mac.auv3" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # JOB 4: watchOS TestFlight Deployment
  # ===========================================================================
  deploy-watchos:
    name: "Deploy watchOS"
    runs-on: macos-14
    # Only run on manual workflow_dispatch with watchos platform selected
    if: github.event_name == 'workflow_dispatch' && contains('all watchos', inputs.platforms)
    timeout-minutes: 60

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Verify Secrets"
        run: |
          [ -n "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" ] || exit 1
          [ -n "${{ secrets.APPLE_TEAM_ID }}" ] || exit 1

      - name: "Setup Xcode & XcodeGen"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "Setup XcodeGen"
        uses: ./.github/actions/setup-xcodegen
        with:
          version: ${{ env.XCODEGEN_VERSION }}

      - name: "Install Fastlane"
        run: gem install fastlane -N --no-document

      - name: "Generate Xcode Project"
        run: |
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ github.run_number }}/" project.yml
          xcodegen generate --spec project.yml

      - name: "Setup Keychain"
        run: |
          KEYCHAIN_NAME="ci_signing_watch_${{ github.run_id }}.keychain-db"
          KEYCHAIN_PASSWORD="ci_password_${{ github.run_id }}"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security list-keychains -d user -s "$KEYCHAIN_NAME" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_NAME"
          echo "KEYCHAIN_PATH=$HOME/Library/Keychains/$KEYCHAIN_NAME" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

      - name: "Deploy to TestFlight"
        run: fastlane ios beta_watchos
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}

      - name: "Cleanup"
        if: always()
        run: security delete-keychain "${{ env.KEYCHAIN_PATH }}" 2>/dev/null || true

      - name: "Success"
        run: |
          echo "## watchOS Deployed to TestFlight" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # JOB 5: tvOS TestFlight Deployment
  # ===========================================================================
  deploy-tvos:
    name: "Deploy tvOS"
    runs-on: macos-14
    # Only run on manual workflow_dispatch with tvos platform selected
    if: github.event_name == 'workflow_dispatch' && contains('all tvos', inputs.platforms)
    timeout-minutes: 60

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Verify Secrets"
        run: |
          [ -n "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" ] || exit 1
          [ -n "${{ secrets.APPLE_TEAM_ID }}" ] || exit 1

      - name: "Setup Xcode & XcodeGen"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "Setup XcodeGen"
        uses: ./.github/actions/setup-xcodegen
        with:
          version: ${{ env.XCODEGEN_VERSION }}

      - name: "Install Fastlane"
        run: gem install fastlane -N --no-document

      - name: "Generate Xcode Project"
        run: |
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ github.run_number }}/" project.yml
          xcodegen generate --spec project.yml

      - name: "Setup Keychain"
        run: |
          KEYCHAIN_NAME="ci_signing_tv_${{ github.run_id }}.keychain-db"
          KEYCHAIN_PASSWORD="ci_password_${{ github.run_id }}"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security list-keychains -d user -s "$KEYCHAIN_NAME" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_NAME"
          echo "KEYCHAIN_PATH=$HOME/Library/Keychains/$KEYCHAIN_NAME" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

      - name: "Deploy to TestFlight"
        run: fastlane ios beta_tvos
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}

      - name: "Cleanup"
        if: always()
        run: security delete-keychain "${{ env.KEYCHAIN_PATH }}" 2>/dev/null || true

      - name: "Success"
        run: |
          echo "## tvOS Deployed to TestFlight" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # JOB 6: visionOS TestFlight Deployment
  # ===========================================================================
  deploy-visionos:
    name: "Deploy visionOS"
    runs-on: macos-14
    # Only run on manual workflow_dispatch with visionos platform selected
    if: github.event_name == 'workflow_dispatch' && contains('all visionos', inputs.platforms)
    timeout-minutes: 60

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Verify Secrets"
        run: |
          [ -n "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" ] || exit 1
          [ -n "${{ secrets.APPLE_TEAM_ID }}" ] || exit 1

      - name: "Setup Xcode & XcodeGen"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "Setup XcodeGen"
        uses: ./.github/actions/setup-xcodegen
        with:
          version: ${{ env.XCODEGEN_VERSION }}

      - name: "Install Fastlane"
        run: gem install fastlane -N --no-document

      - name: "Generate Xcode Project"
        run: |
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ github.run_number }}/" project.yml
          xcodegen generate --spec project.yml

      - name: "Setup Keychain"
        run: |
          KEYCHAIN_NAME="ci_signing_vision_${{ github.run_id }}.keychain-db"
          KEYCHAIN_PASSWORD="ci_password_${{ github.run_id }}"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security list-keychains -d user -s "$KEYCHAIN_NAME" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_NAME"
          echo "KEYCHAIN_PATH=$HOME/Library/Keychains/$KEYCHAIN_NAME" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

      - name: "Deploy to TestFlight"
        run: fastlane ios beta_visionos
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}

      - name: "Cleanup"
        if: always()
        run: security delete-keychain "${{ env.KEYCHAIN_PATH }}" 2>/dev/null || true

      - name: "Success"
        run: |
          echo "## visionOS Deployed to TestFlight" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # JOB 7: Deployment Summary
  # ===========================================================================
  summary:
    name: "Deployment Summary"
    runs-on: ubuntu-latest
    # Only show summary for manual workflow_dispatch, not for PR builds
    if: always() && github.event_name == 'workflow_dispatch'
    needs: [deploy-ios, deploy-macos, deploy-watchos, deploy-tvos, deploy-visionos]

    steps:
      - name: "Generate Summary"
        run: |
          echo "# TestFlight Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ github.event.inputs.platforms }}" == "all" || "${{ github.event.inputs.platforms }}" == "ios" || "${{ github.event.inputs.platforms }}" == "ios-macos" ]]; then
            echo "| iOS + AUv3 | ${{ needs.deploy-ios.result == 'success' && 'Deployed' || needs.deploy-ios.result == 'skipped' && 'Skipped' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ github.event.inputs.platforms }}" == "all" || "${{ github.event.inputs.platforms }}" == "macos" || "${{ github.event.inputs.platforms }}" == "ios-macos" ]]; then
            echo "| macOS + AUv3 | ${{ needs.deploy-macos.result == 'success' && 'Deployed' || needs.deploy-macos.result == 'skipped' && 'Skipped' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ github.event.inputs.platforms }}" == "all" || "${{ github.event.inputs.platforms }}" == "watchos" ]]; then
            echo "| watchOS | ${{ needs.deploy-watchos.result == 'success' && 'Deployed' || needs.deploy-watchos.result == 'skipped' && 'Skipped' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ github.event.inputs.platforms }}" == "all" || "${{ github.event.inputs.platforms }}" == "tvos" ]]; then
            echo "| tvOS | ${{ needs.deploy-tvos.result == 'success' && 'Deployed' || needs.deploy-tvos.result == 'skipped' && 'Skipped' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ github.event.inputs.platforms }}" == "all" || "${{ github.event.inputs.platforms }}" == "visionos" ]]; then
            echo "| visionOS | ${{ needs.deploy-visionos.result == 'success' && 'Deployed' || needs.deploy-visionos.result == 'skipped' && 'Skipped' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check [App Store Connect](https://appstoreconnect.apple.com) for build processing status." >> $GITHUB_STEP_SUMMARY
