# =============================================================================
# ECHOELMUSIC - iOS TESTFLIGHT (Primary Deployment Workflow)
# =============================================================================
# PR Build Check + Manual TestFlight Deploy
# Version: 1.2.0 - Phase 10000 ULTIMATE MODE
# =============================================================================

name: "ðŸ“± iOS TestFlight"

on:
  # Trigger on all pull requests for build validation
  pull_request:
    types: [opened, synchronize, reopened]

  # Manual trigger for TestFlight deployment
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'testflight'
        type: choice
        options:
          - testflight
          - build-only
      increment_build:
        description: 'Auto-increment build number'
        required: false
        default: true
        type: boolean

concurrency:
  group: ios-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  XCODE_VERSION: '15.4'
  XCODEGEN_VERSION: '2.38.0'

jobs:
  # ==========================================================================
  # PR Build Check (Runs on ALL PRs - No Secrets Required)
  # ==========================================================================
  pr-build-check:
    name: "ðŸ” PR Build Check"
    runs-on: macos-14
    # Run ONLY on pull requests - use simple condition without ${{ }} wrapper
    if: github.event_name == 'pull_request'

    steps:
      - name: "ðŸ“¥ Checkout"
        uses: actions/checkout@v4

      - name: "â„¹ï¸ Show PR Info"
        run: |
          echo "=== Workflow Debug Info ==="
          echo "Event Name: ${{ github.event_name }}"
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "Base: ${{ github.base_ref }}"
          echo "Head: ${{ github.head_ref }}"
          echo "Ref: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "=========================="

      - name: "ðŸ”§ Setup Xcode ${{ env.XCODE_VERSION }}"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "ðŸ“¦ Install XcodeGen"
        run: |
          curl -sL https://github.com/yonaskolb/XcodeGen/releases/download/${{ env.XCODEGEN_VERSION }}/xcodegen.zip -o xcodegen.zip
          unzip -o xcodegen.zip
          sudo mv xcodegen/bin/xcodegen /usr/local/bin/
          xcodegen --version

      - name: "ðŸ’¾ Cache Swift Packages"
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
          key: ${{ runner.os }}-swift-${{ hashFiles('Package.swift') }}

      - name: "âš™ï¸ Generate Xcode Project"
        run: |
          sed -i '' 's/DEVELOPMENT_TEAM: ""/DEVELOPMENT_TEAM: "XXXXXXXXXX"/' project.yml || true
          xcodegen generate --spec project.yml
          ls -la *.xcodeproj || echo "No project generated"

      - name: "ðŸ”¨ Build iOS (Simulator)"
        run: |
          xcodebuild build \
            -project Echoelmusic.xcodeproj \
            -scheme Echoelmusic \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee build.log | tail -100

          BUILD_RESULT=${PIPESTATUS[0]}
          if [ $BUILD_RESULT -eq 0 ]; then
            echo "âœ… Build successful!"
          else
            echo "âŒ Build failed!"
            echo "=== Errors ==="
            grep -E "error:" build.log | head -30
            exit 1
          fi

      - name: "ðŸ“‹ Upload Build Log"
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pr-build-log
          path: build.log
          retention-days: 3

  # ==========================================================================
  # TestFlight Deploy (Manual Only - Never runs on PRs)
  # ==========================================================================
  ios-testflight:
    name: "ðŸ“± Build & Deploy iOS"
    runs-on: macos-14
    # Run ONLY on manual workflow_dispatch - use simple condition without ${{ }} wrapper
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: "ðŸ“¥ Checkout"
        uses: actions/checkout@v4

      - name: "â„¹ï¸ Show Deploy Info"
        run: |
          echo "=== Deployment Info ==="
          echo "Event: ${{ github.event_name }}"
          echo "Build Type: ${{ github.event.inputs.build_type }}"
          echo "Ref: ${{ github.ref }}"
          echo "========================"

      - name: "ðŸ” Verify Secrets"
        run: |
          MISSING=false
          [ -z "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" ] && echo "âŒ APP_STORE_CONNECT_KEY_ID" && MISSING=true
          [ -z "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}" ] && echo "âŒ APP_STORE_CONNECT_ISSUER_ID" && MISSING=true
          [ -z "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" ] && echo "âŒ APP_STORE_CONNECT_PRIVATE_KEY" && MISSING=true
          [ -z "${{ secrets.APPLE_TEAM_ID }}" ] && echo "âŒ APPLE_TEAM_ID" && MISSING=true
          [ "$MISSING" = true ] && exit 1
          echo "âœ… All secrets OK"

      - name: "ðŸ”§ Setup Xcode ${{ env.XCODE_VERSION }}"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "ðŸ“¦ Install Tools"
        run: |
          curl -sL https://github.com/yonaskolb/XcodeGen/releases/download/${{ env.XCODEGEN_VERSION }}/xcodegen.zip -o xcodegen.zip
          unzip -o xcodegen.zip
          sudo mv xcodegen/bin/xcodegen /usr/local/bin/
          gem install fastlane -N

      - name: "ðŸ”¢ Set Build Number"
        run: |
          BUILD_NUMBER=${{ github.run_number }}
          echo "BUILD_NUMBER=${BUILD_NUMBER}" >> $GITHUB_ENV
          echo "ðŸ“¦ Build number: ${BUILD_NUMBER}"

      - name: "âš™ï¸ Generate Project"
        run: |
          # Set Team ID
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          # Set build number from GitHub Actions
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ env.BUILD_NUMBER }}/" project.yml
          xcodegen generate --spec project.yml
          echo "âœ… Project generated with build number ${{ env.BUILD_NUMBER }}"

      - name: "ðŸ”‘ Setup Keychain"
        run: |
          KEYCHAIN_NAME="ci_signing.keychain-db"
          KEYCHAIN_PASSWORD="ci_$RANDOM"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security list-keychains -d user -s "$KEYCHAIN_NAME" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_NAME"
          echo "KEYCHAIN_PATH=$HOME/Library/Keychains/$KEYCHAIN_NAME" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

      - name: "ðŸ”¨ Build & Upload"
        run: |
          mkdir -p build_logs

          # Retry logic for network issues
          MAX_RETRIES=3
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ðŸš€ Attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES"

            if [ "${{ github.event.inputs.build_type }}" == "testflight" ]; then
              if fastlane ios beta 2>&1 | tee build_logs/fastlane.log; then
                echo "âœ… Build and upload successful!"
                exit 0
              fi
            else
              if fastlane ios build_only 2>&1 | tee build_logs/fastlane.log; then
                echo "âœ… Build successful!"
                exit 0
              fi
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              WAIT_TIME=$((RETRY_COUNT * 30))
              echo "â³ Retrying in ${WAIT_TIME}s..."
              sleep $WAIT_TIME
            fi
          done

          echo "âŒ Failed after $MAX_RETRIES attempts"
          exit 1
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          KEYCHAIN_PATH: ${{ env.KEYCHAIN_PATH }}
          KEYCHAIN_PASSWORD: ${{ env.KEYCHAIN_PASSWORD }}
          FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 180

      - name: "ðŸ“‹ Show Errors"
        if: failure()
        run: |
          echo "=== Build Errors ==="
          grep -E "error:|fatal|Error:|FAILED" build_logs/fastlane.log | head -50 || true
          echo ""
          echo "=== Signing Issues ==="
          grep -E "signing|certificate|provision|codesign" build_logs/fastlane.log | head -20 || true

      - name: "ðŸ“¦ Upload Logs"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ github.run_number }}
          path: build_logs/
          retention-days: 14

      - name: "âœ… Success Summary"
        if: success()
        run: |
          echo "## ðŸŽ‰ TestFlight Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number:** ${{ env.BUILD_NUMBER }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Type:** ${{ github.event.inputs.build_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
