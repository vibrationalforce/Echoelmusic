# =============================================================================
# ECHOELMUSIC - iOS TESTFLIGHT (Quick Deploy)
# =============================================================================
# One-tap iOS deployment from iPhone
# Cost: ~$1.20 per build
# =============================================================================

name: "üì± iOS TestFlight"

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'testflight'
        type: choice
        options:
          - testflight
          - build-only

jobs:
  ios-testflight:
    name: "üì± Build & Deploy iOS"
    runs-on: macos-15  # Latest macOS with Xcode 16

    steps:
      - name: "üì• Checkout"
        uses: actions/checkout@v4

      - name: "üîê Verify Secrets"
        run: |
          MISSING=false
          [ -z "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" ] && echo "‚ùå Missing: APP_STORE_CONNECT_KEY_ID" && MISSING=true
          [ -z "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}" ] && echo "‚ùå Missing: APP_STORE_CONNECT_ISSUER_ID" && MISSING=true
          [ -z "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" ] && echo "‚ùå Missing: APP_STORE_CONNECT_PRIVATE_KEY" && MISSING=true
          [ -z "${{ secrets.APPLE_TEAM_ID }}" ] && echo "‚ùå Missing: APPLE_TEAM_ID" && MISSING=true
          [ "$MISSING" = true ] && exit 1
          echo "‚úÖ All secrets configured!"

      - name: "üíæ Cache Swift Packages"
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
          key: ${{ runner.os }}-swift-ios-${{ hashFiles('Package.swift') }}

      - name: "üîß Setup Xcode (Latest)"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: "üì¶ Install Tools"
        run: |
          brew install xcodegen
          gem install fastlane -N

      - name: "‚öôÔ∏è Configure Project"
        run: |
          echo "Setting DEVELOPMENT_TEAM..."
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml

          echo "Running XcodeGen..."
          xcodegen generate --spec project.yml

          echo "Verifying project was created..."
          if [ -d "Echoelmusic.xcodeproj" ]; then
            echo "‚úÖ Echoelmusic.xcodeproj created successfully"
            ls -la Echoelmusic.xcodeproj/
          else
            echo "‚ùå ERROR: Echoelmusic.xcodeproj was not created!"
            echo "XcodeGen output above should show the error."
            exit 1
          fi

      - name: "üî® Build iOS App"
        run: |
          xcodebuild -project Echoelmusic.xcodeproj \
            -scheme Echoelmusic \
            -destination "generic/platform=iOS" \
            -configuration Release \
            -archivePath build/Echoelmusic.xcarchive \
            DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
            -allowProvisioningUpdates \
            clean archive

      - name: "üöÄ Upload to TestFlight"
        if: ${{ github.event.inputs.build_type == 'testflight' }}
        run: fastlane ios beta
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: "‚úÖ Success"
        run: |
          echo "========================================"
          echo "  üéâ iOS BUILD SUCCESSFUL!"
          echo "========================================"
          if [ "${{ github.event.inputs.build_type }}" = "testflight" ]; then
            echo "  üì± Check TestFlight for new build"
            echo "  ‚è±Ô∏è  Processing takes 15-30 minutes"
          else
            echo "  ‚úÖ Build completed (not uploaded)"
          fi
          echo "========================================"
