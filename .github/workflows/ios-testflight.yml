# =============================================================================
# ECHOELMUSIC - MULTI-PLATFORM TESTFLIGHT DEPLOYMENT
# =============================================================================
# Version: 3.2.0 - ULTIMATE FIXED
#
# ARCHITECTURE:
# - pull_request events -> ONLY pr-check job runs (simulator build)
# - workflow_dispatch events -> preflight + deploy jobs run (TestFlight)
# =============================================================================

name: "TestFlight Multi-Platform"

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
    paths:
      - 'Sources/**'
      - 'Tests/**'
      - 'Package.swift'
      - 'project.yml'
      - 'fastlane/**'
      - '.github/workflows/ios-testflight.yml'

  workflow_dispatch:
    inputs:
      platforms:
        description: 'Platforms to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ios
          - macos
          - watchos
          - tvos
          - visionos
          - ios-macos
      clean_build:
        description: 'Clean build'
        required: false
        default: false
        type: boolean

concurrency:
  group: testflight-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

env:
  XCODE_VERSION: '15.4'
  XCODEGEN_VERSION: '2.42.0'

jobs:
  # ===========================================================================
  # PR BUILD CHECK - Runs ONLY for pull_request events
  # ===========================================================================
  pr-check:
    name: "PR Build Check"
    runs-on: macos-14
    if: github.event_name == 'pull_request'
    timeout-minutes: 30

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Info"
        run: |
          echo "=============================================="
          echo "  PR BUILD CHECK"
          echo "=============================================="
          echo "Event: ${{ github.event_name }}"
          echo "PR: #${{ github.event.pull_request.number }}"
          echo "Branch: ${{ github.head_ref }} -> ${{ github.base_ref }}"

      - name: "Validate Files"
        run: |
          for file in Package.swift project.yml fastlane/Fastfile; do
            [ -f "$file" ] && echo "[OK] $file" || { echo "[FAIL] $file missing"; exit 1; }
          done

      - name: "Setup Xcode"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "15.4"

      - name: "Install XcodeGen"
        run: brew install xcodegen || true

      - name: "Generate Project"
        run: |
          sed -i '' 's/DEVELOPMENT_TEAM: ""/DEVELOPMENT_TEAM: "XXXXXXXXXX"/' project.yml
          xcodegen generate --spec project.yml

      - name: "Build iOS Simulator"
        run: |
          xcodebuild build \
            -project Echoelmusic.xcodeproj \
            -scheme Echoelmusic \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            -quiet || exit 1
          echo "iOS build OK"

      - name: "Build macOS"
        run: |
          xcodebuild build \
            -project Echoelmusic.xcodeproj \
            -scheme Echoelmusic-macOS \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            -quiet || exit 1
          echo "macOS build OK"

      - name: "Summary"
        run: |
          echo "## PR Build Check Passed" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| iOS Simulator | OK |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | OK |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # PREFLIGHT - Runs ONLY for workflow_dispatch events
  # ===========================================================================
  preflight:
    name: "Pre-flight Check"
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    timeout-minutes: 5
    outputs:
      ready: ${{ steps.validate.outputs.ready }}

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Info"
        run: |
          echo "=============================================="
          echo "  TESTFLIGHT PRE-FLIGHT CHECK"
          echo "=============================================="
          echo "Event: ${{ github.event_name }}"
          echo "Platforms: ${{ github.event.inputs.platforms }}"
          echo "Build: ${{ github.run_number }}"

      - name: "Validate"
        id: validate
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          ERRORS=0

          # Check files
          for f in Package.swift project.yml fastlane/Fastfile fastlane/Appfile; do
            [ -f "$f" ] && echo "[OK] $f" || { echo "[FAIL] $f"; ((ERRORS++)); }
          done

          # Check secrets
          [ -n "$ASC_KEY_ID" ] && echo "[OK] ASC_KEY_ID" || { echo "[FAIL] ASC_KEY_ID missing"; ((ERRORS++)); }
          [ -n "$ASC_ISSUER_ID" ] && echo "[OK] ASC_ISSUER_ID" || { echo "[FAIL] ASC_ISSUER_ID missing"; ((ERRORS++)); }
          [ -n "$ASC_KEY" ] && echo "[OK] ASC_KEY (${#ASC_KEY} chars)" || { echo "[FAIL] ASC_KEY missing"; ((ERRORS++)); }
          [ -n "$TEAM_ID" ] && echo "[OK] TEAM_ID" || { echo "[FAIL] TEAM_ID missing"; ((ERRORS++)); }

          if [ $ERRORS -gt 0 ]; then
            echo "ready=false" >> $GITHUB_OUTPUT
            echo "[FAIL] $ERRORS error(s) found"
            exit 1
          fi

          echo "ready=true" >> $GITHUB_OUTPUT
          echo "[PASS] All checks passed"

      - name: "Summary"
        run: |
          echo "## Pre-flight Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Platforms: ${{ github.event.inputs.platforms }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # iOS DEPLOYMENT
  # ===========================================================================
  deploy-ios:
    name: "Deploy iOS"
    runs-on: macos-14
    needs: preflight
    if: github.event_name == 'workflow_dispatch' && contains('all ios ios-macos', github.event.inputs.platforms)
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - name: "Setup Xcode"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "Setup XcodeGen"
        uses: ./.github/actions/setup-xcodegen
        with:
          version: ${{ env.XCODEGEN_VERSION }}

      - name: "Install Fastlane"
        run: gem install fastlane -N --no-document

      - name: "Generate Project"
        run: |
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ github.run_number }}/" project.yml
          xcodegen generate --spec project.yml

      - name: "Setup Keychain"
        run: |
          security create-keychain -p "ci_pass" ci.keychain-db
          security set-keychain-settings -lut 21600 ci.keychain-db
          security unlock-keychain -p "ci_pass" ci.keychain-db
          security list-keychains -d user -s ci.keychain-db
          security default-keychain -s ci.keychain-db
          echo "KEYCHAIN_PATH=$HOME/Library/Keychains/ci.keychain-db" >> $GITHUB_ENV

      - name: "Deploy"
        run: fastlane ios beta
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}
          KEYCHAIN_PATH: ${{ env.KEYCHAIN_PATH }}
          KEYCHAIN_PASSWORD: "ci_pass"

      - name: "Cleanup"
        if: always()
        run: security delete-keychain ci.keychain-db 2>/dev/null || true

      - name: "Summary"
        run: echo "## iOS deployed to TestFlight (Build ${{ github.run_number }})" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # macOS DEPLOYMENT
  # ===========================================================================
  deploy-macos:
    name: "Deploy macOS"
    runs-on: macos-14
    needs: preflight
    if: github.event_name == 'workflow_dispatch' && contains('all macos ios-macos', github.event.inputs.platforms)
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - name: "Setup Xcode"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "Setup XcodeGen"
        uses: ./.github/actions/setup-xcodegen
        with:
          version: ${{ env.XCODEGEN_VERSION }}

      - name: "Install Fastlane"
        run: gem install fastlane -N --no-document

      - name: "Generate Project"
        run: |
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ github.run_number }}/" project.yml
          xcodegen generate --spec project.yml

      - name: "Setup Keychain"
        run: |
          security create-keychain -p "ci_pass" ci_mac.keychain-db
          security set-keychain-settings -lut 21600 ci_mac.keychain-db
          security unlock-keychain -p "ci_pass" ci_mac.keychain-db
          security list-keychains -d user -s ci_mac.keychain-db
          security default-keychain -s ci_mac.keychain-db
          echo "KEYCHAIN_PATH=$HOME/Library/Keychains/ci_mac.keychain-db" >> $GITHUB_ENV

      - name: "Deploy"
        run: fastlane mac beta
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}
          KEYCHAIN_PATH: ${{ env.KEYCHAIN_PATH }}
          KEYCHAIN_PASSWORD: "ci_pass"

      - name: "Cleanup"
        if: always()
        run: security delete-keychain ci_mac.keychain-db 2>/dev/null || true

      - name: "Summary"
        run: echo "## macOS deployed to TestFlight (Build ${{ github.run_number }})" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # watchOS DEPLOYMENT
  # ===========================================================================
  deploy-watchos:
    name: "Deploy watchOS"
    runs-on: macos-14
    needs: preflight
    if: github.event_name == 'workflow_dispatch' && contains('all watchos', github.event.inputs.platforms)
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      - uses: ./.github/actions/setup-xcodegen
        with:
          version: ${{ env.XCODEGEN_VERSION }}
      - run: gem install fastlane -N --no-document
      - run: |
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          xcodegen generate --spec project.yml
      - run: |
          security create-keychain -p "ci" ci_w.keychain-db
          security set-keychain-settings -lut 21600 ci_w.keychain-db
          security unlock-keychain -p "ci" ci_w.keychain-db
          security list-keychains -d user -s ci_w.keychain-db
          security default-keychain -s ci_w.keychain-db
      - run: fastlane ios beta_watchos
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}
          KEYCHAIN_PATH: ~/Library/Keychains/ci_w.keychain-db
          KEYCHAIN_PASSWORD: "ci"
      - if: always()
        run: security delete-keychain ci_w.keychain-db 2>/dev/null || true

  # ===========================================================================
  # tvOS DEPLOYMENT
  # ===========================================================================
  deploy-tvos:
    name: "Deploy tvOS"
    runs-on: macos-14
    needs: preflight
    if: github.event_name == 'workflow_dispatch' && contains('all tvos', github.event.inputs.platforms)
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      - uses: ./.github/actions/setup-xcodegen
        with:
          version: ${{ env.XCODEGEN_VERSION }}
      - run: gem install fastlane -N --no-document
      - run: |
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          xcodegen generate --spec project.yml
      - run: |
          security create-keychain -p "ci" ci_tv.keychain-db
          security set-keychain-settings -lut 21600 ci_tv.keychain-db
          security unlock-keychain -p "ci" ci_tv.keychain-db
          security list-keychains -d user -s ci_tv.keychain-db
          security default-keychain -s ci_tv.keychain-db
      - run: fastlane ios beta_tvos
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}
          KEYCHAIN_PATH: ~/Library/Keychains/ci_tv.keychain-db
          KEYCHAIN_PASSWORD: "ci"
      - if: always()
        run: security delete-keychain ci_tv.keychain-db 2>/dev/null || true

  # ===========================================================================
  # visionOS DEPLOYMENT
  # ===========================================================================
  deploy-visionos:
    name: "Deploy visionOS"
    runs-on: macos-14
    needs: preflight
    if: github.event_name == 'workflow_dispatch' && contains('all visionos', github.event.inputs.platforms)
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}
      - uses: ./.github/actions/setup-xcodegen
        with:
          version: ${{ env.XCODEGEN_VERSION }}
      - run: gem install fastlane -N --no-document
      - run: |
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          xcodegen generate --spec project.yml
      - run: |
          security create-keychain -p "ci" ci_v.keychain-db
          security set-keychain-settings -lut 21600 ci_v.keychain-db
          security unlock-keychain -p "ci" ci_v.keychain-db
          security list-keychains -d user -s ci_v.keychain-db
          security default-keychain -s ci_v.keychain-db
      - run: fastlane ios beta_visionos
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUILD_NUMBER: ${{ github.run_number }}
          KEYCHAIN_PATH: ~/Library/Keychains/ci_v.keychain-db
          KEYCHAIN_PASSWORD: "ci"
      - if: always()
        run: security delete-keychain ci_v.keychain-db 2>/dev/null || true

  # ===========================================================================
  # SUMMARY - Only for workflow_dispatch
  # ===========================================================================
  summary:
    name: "Summary"
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'workflow_dispatch'
    needs: [preflight, deploy-ios, deploy-macos, deploy-watchos, deploy-tvos, deploy-visionos]

    steps:
      - name: "Generate"
        run: |
          echo "# TestFlight Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-flight | ${{ needs.preflight.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS | ${{ needs.deploy-ios.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | ${{ needs.deploy-macos.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| watchOS | ${{ needs.deploy-watchos.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| tvOS | ${{ needs.deploy-tvos.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| visionOS | ${{ needs.deploy-visionos.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[App Store Connect](https://appstoreconnect.apple.com)" >> $GITHUB_STEP_SUMMARY
