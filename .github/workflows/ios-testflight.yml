# =============================================================================
# ECHOELMUSIC - iOS TESTFLIGHT (Quick Deploy)
# =============================================================================
# One-tap iOS deployment from iPhone
# Cost: ~$1.20 per build
# =============================================================================

name: "üì± iOS TestFlight"

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'testflight'
        type: choice
        options:
          - testflight
          - build-only

jobs:
  ios-testflight:
    name: "üì± Build & Deploy iOS"
    runs-on: macos-14  # Stable with Xcode 15.4

    steps:
      - name: "üì• Checkout"
        uses: actions/checkout@v4

      - name: "üîê Verify Secrets"
        run: |
          MISSING=false
          [ -z "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" ] && echo "‚ùå Missing: APP_STORE_CONNECT_KEY_ID" && MISSING=true
          [ -z "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}" ] && echo "‚ùå Missing: APP_STORE_CONNECT_ISSUER_ID" && MISSING=true
          [ -z "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" ] && echo "‚ùå Missing: APP_STORE_CONNECT_PRIVATE_KEY" && MISSING=true
          [ -z "${{ secrets.APPLE_TEAM_ID }}" ] && echo "‚ùå Missing: APPLE_TEAM_ID" && MISSING=true
          [ "$MISSING" = true ] && exit 1
          echo "‚úÖ All secrets configured!"

      - name: "üíæ Cache Swift Packages"
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
          key: ${{ runner.os }}-swift-ios-${{ hashFiles('Package.swift') }}

      - name: "üîß Setup Xcode 15.4"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: "üì¶ Install Tools"
        run: |
          # Install XcodeGen 2.38.0 (last version with Xcode 15 project format)
          curl -sL https://github.com/yonaskolb/XcodeGen/releases/download/2.38.0/xcodegen.zip -o xcodegen.zip
          unzip -o xcodegen.zip
          sudo mv xcodegen/bin/xcodegen /usr/local/bin/
          xcodegen --version

          gem install fastlane -N

      - name: "‚öôÔ∏è Configure Project"
        run: |
          echo "Setting DEVELOPMENT_TEAM..."
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml

          echo "Running XcodeGen..."
          xcodegen generate --spec project.yml

          echo "Verifying project was created..."
          if [ -d "Echoelmusic.xcodeproj" ]; then
            echo "‚úÖ Echoelmusic.xcodeproj created successfully"
            ls -la Echoelmusic.xcodeproj/
          else
            echo "‚ùå ERROR: Echoelmusic.xcodeproj was not created!"
            echo "XcodeGen output above should show the error."
            exit 1
          fi

      - name: "üîë Setup CI Keychain"
        run: |
          # Create a temporary keychain for CI
          KEYCHAIN_NAME="ci_signing.keychain-db"
          KEYCHAIN_PASSWORD="ci_password_$RANDOM"

          # Create and configure keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"

          # Add to search list and make default
          security list-keychains -d user -s "$KEYCHAIN_NAME" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_NAME"

          # Export for Fastlane
          echo "KEYCHAIN_PATH=$HOME/Library/Keychains/$KEYCHAIN_NAME" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

          echo "‚úÖ CI Keychain created: $KEYCHAIN_NAME"

      - name: "üî® Build & Upload via Fastlane"
        run: |
          if [ "${{ github.event.inputs.build_type }}" == "testflight" ]; then
            echo "Building and uploading to TestFlight..."
            fastlane ios beta
          else
            echo "Building only (no upload)..."
            fastlane ios build_only
          fi
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          KEYCHAIN_PATH: ${{ env.KEYCHAIN_PATH }}
          KEYCHAIN_PASSWORD: ${{ env.KEYCHAIN_PASSWORD }}

      - name: "‚úÖ Success"
        run: |
          echo "========================================"
          echo "  üéâ iOS BUILD SUCCESSFUL!"
          echo "========================================"
          if [ "${{ github.event.inputs.build_type }}" = "testflight" ]; then
            echo "  üì± Check TestFlight for new build"
            echo "  ‚è±Ô∏è  Processing takes 15-30 minutes"
          else
            echo "  ‚úÖ Build completed (not uploaded)"
          fi
          echo "========================================"
