# =============================================================================
# ECHOELMUSIC - iOS TESTFLIGHT DEPLOYMENT
# =============================================================================
# Lambda Loop A++++ Optimized Workflow
# Version: 2.0.0 - Phase 10000 ULTIMATE MODE
#
# ARCHITECTURE:
# - PR Events -> pr-check job (simulator build, no secrets)
# - Manual Dispatch -> deploy job (TestFlight upload, requires secrets)
#
# This design ensures clean job separation and reliable condition evaluation.
# =============================================================================

name: "iOS TestFlight"

on:
  # PR build validation (no secrets required)
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
    paths:
      - 'Sources/**'
      - 'Tests/**'
      - 'Package.swift'
      - 'project.yml'
      - 'fastlane/**'
      - '.github/workflows/ios-testflight.yml'

  # Manual TestFlight deployment (secrets required)
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'testflight'
        type: choice
        options:
          - testflight
          - build-only
      increment_build:
        description: 'Auto-increment build number'
        required: false
        default: true
        type: boolean

# Cancel in-progress runs for the same PR/ref
concurrency:
  group: ios-build-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

env:
  XCODE_VERSION: '15.4'
  XCODEGEN_VERSION: '2.38.0'

jobs:
  # ===========================================================================
  # JOB 1: PR Build Check
  # ===========================================================================
  # Runs ONLY on pull_request events. Validates the build on simulator.
  # No secrets required - safe for external contributors.
  # ===========================================================================
  pr-check:
    name: "PR Build Check"
    runs-on: macos-14
    # CRITICAL: Use explicit expression syntax for reliable evaluation
    if: ${{ github.event_name == 'pull_request' }}
    timeout-minutes: 30

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Event Info"
        run: |
          echo "====================================="
          echo "  iOS TestFlight - PR Build Check"
          echo "====================================="
          echo "Event: ${{ github.event_name }}"
          echo "PR: #${{ github.event.pull_request.number }}"
          echo "Branch: ${{ github.head_ref }} -> ${{ github.base_ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "====================================="

      - name: "Setup Xcode ${{ env.XCODE_VERSION }}"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "Setup XcodeGen"
        uses: ./.github/actions/setup-xcodegen
        with:
          version: ${{ env.XCODEGEN_VERSION }}

      - name: "Cache Swift Packages"
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
            build/DerivedData
          key: ${{ runner.os }}-swift-${{ hashFiles('Package.swift') }}-${{ hashFiles('project.yml') }}
          restore-keys: |
            ${{ runner.os }}-swift-${{ hashFiles('Package.swift') }}-
            ${{ runner.os }}-swift-

      - name: "Generate Xcode Project"
        run: |
          # Set placeholder Team ID for simulator build
          sed -i '' 's/DEVELOPMENT_TEAM: ""/DEVELOPMENT_TEAM: "XXXXXXXXXX"/' project.yml || true
          xcodegen generate --spec project.yml
          echo "Generated project files:"
          ls -la *.xcodeproj 2>/dev/null || echo "Warning: No .xcodeproj found"

      - name: "Build for Simulator"
        run: |
          set -o pipefail

          echo "Building Echoelmusic for iOS Simulator..."

          xcodebuild build \
            -project Echoelmusic.xcodeproj \
            -scheme Echoelmusic \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
            -configuration Debug \
            -derivedDataPath build/DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            COMPILER_INDEX_STORE_ENABLE=NO \
            2>&1 | tee build.log

          BUILD_RESULT=$?

          if [ $BUILD_RESULT -eq 0 ]; then
            echo ""
            echo "========================================"
            echo "  BUILD SUCCESSFUL"
            echo "========================================"
          else
            echo ""
            echo "========================================"
            echo "  BUILD FAILED"
            echo "========================================"
            echo ""
            echo "=== Build Errors ==="
            grep -E "error:|fatal:" build.log | head -20 || true
            exit 1
          fi

      - name: "Build Summary"
        if: always()
        run: |
          if [ -f build.log ]; then
            echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            WARNINGS=$(grep -c "warning:" build.log 2>/dev/null || echo "0")
            ERRORS=$(grep -c "error:" build.log 2>/dev/null || echo "0")

            if [ "$ERRORS" -eq "0" ]; then
              echo "- **Status:** Success" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Status:** Failed" >> $GITHUB_STEP_SUMMARY
            fi
            echo "- **Warnings:** $WARNINGS" >> $GITHUB_STEP_SUMMARY
            echo "- **Errors:** $ERRORS" >> $GITHUB_STEP_SUMMARY
          fi

      - name: "Upload Build Log"
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pr-build-log-${{ github.event.pull_request.number }}
          path: build.log
          retention-days: 7

  # ===========================================================================
  # JOB 2: TestFlight Deployment
  # ===========================================================================
  # Runs ONLY on workflow_dispatch (manual trigger).
  # Requires all Apple signing secrets to be configured.
  # ===========================================================================
  deploy:
    name: "TestFlight Deploy"
    runs-on: macos-14
    # CRITICAL: Use explicit expression syntax for reliable evaluation
    if: ${{ github.event_name == 'workflow_dispatch' }}
    timeout-minutes: 60

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Deployment Info"
        run: |
          echo "====================================="
          echo "  iOS TestFlight Deployment"
          echo "====================================="
          echo "Event: ${{ github.event_name }}"
          echo "Build Type: ${{ github.event.inputs.build_type }}"
          echo "Auto-increment: ${{ github.event.inputs.increment_build }}"
          echo "Ref: ${{ github.ref }}"
          echo "Run Number: ${{ github.run_number }}"
          echo "====================================="

      - name: "Verify Secrets"
        run: |
          echo "Checking required secrets..."
          MISSING=0

          if [ -z "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" ]; then
            echo "ERROR: APP_STORE_CONNECT_KEY_ID not set"
            MISSING=1
          else
            echo "OK: APP_STORE_CONNECT_KEY_ID"
          fi

          if [ -z "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}" ]; then
            echo "ERROR: APP_STORE_CONNECT_ISSUER_ID not set"
            MISSING=1
          else
            echo "OK: APP_STORE_CONNECT_ISSUER_ID"
          fi

          if [ -z "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" ]; then
            echo "ERROR: APP_STORE_CONNECT_PRIVATE_KEY not set"
            MISSING=1
          else
            echo "OK: APP_STORE_CONNECT_PRIVATE_KEY"
          fi

          if [ -z "${{ secrets.APPLE_TEAM_ID }}" ]; then
            echo "ERROR: APPLE_TEAM_ID not set"
            MISSING=1
          else
            echo "OK: APPLE_TEAM_ID"
          fi

          if [ $MISSING -eq 1 ]; then
            echo ""
            echo "Missing required secrets. Please configure them in:"
            echo "Settings -> Secrets and variables -> Actions"
            exit 1
          fi

          echo ""
          echo "All secrets verified!"

      - name: "Setup Xcode ${{ env.XCODE_VERSION }}"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: "Setup XcodeGen"
        uses: ./.github/actions/setup-xcodegen
        with:
          version: ${{ env.XCODEGEN_VERSION }}

      - name: "Install Fastlane"
        run: |
          echo "Installing Fastlane..."
          gem install fastlane -N --no-document
          fastlane --version

      - name: "Set Build Number"
        id: build_number
        run: |
          BUILD_NUMBER=${{ github.run_number }}
          echo "BUILD_NUMBER=${BUILD_NUMBER}" >> $GITHUB_ENV
          echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "Build number: ${BUILD_NUMBER}"

      - name: "Generate Xcode Project"
        run: |
          # Set real Team ID from secrets
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml

          # Set build number
          sed -i '' "s/\${BUILD_NUMBER:=1}/${{ env.BUILD_NUMBER }}/" project.yml

          # Generate project
          xcodegen generate --spec project.yml

          echo "Project generated with:"
          echo "- Team ID: ${{ secrets.APPLE_TEAM_ID }}"
          echo "- Build Number: ${{ env.BUILD_NUMBER }}"

      - name: "Setup Keychain"
        run: |
          KEYCHAIN_NAME="ci_signing_${{ github.run_id }}.keychain-db"
          KEYCHAIN_PASSWORD="ci_password_${{ github.run_id }}"

          # Create and configure keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"

          # Add to search list and make default
          security list-keychains -d user -s "$KEYCHAIN_NAME" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_NAME"

          # Export for fastlane
          echo "KEYCHAIN_PATH=$HOME/Library/Keychains/$KEYCHAIN_NAME" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

          echo "Keychain configured: $KEYCHAIN_NAME"

      - name: "Build and Upload"
        id: fastlane
        run: |
          mkdir -p build_logs

          MAX_RETRIES=3
          RETRY_COUNT=0
          SUCCESS=false

          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo ""
            echo "====================================="
            echo "  Attempt $RETRY_COUNT of $MAX_RETRIES"
            echo "====================================="

            LANE="${{ github.event.inputs.build_type == 'testflight' && 'beta' || 'build_only' }}"
            echo "Running fastlane ios $LANE..."

            if fastlane ios $LANE 2>&1 | tee build_logs/fastlane_attempt_${RETRY_COUNT}.log; then
              SUCCESS=true
              echo ""
              echo "====================================="
              echo "  SUCCESS!"
              echo "====================================="
            else
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                WAIT_TIME=$((RETRY_COUNT * 30))
                echo "Attempt failed. Waiting ${WAIT_TIME}s before retry..."
                sleep $WAIT_TIME
              fi
            fi
          done

          # Copy last attempt as main log
          cp "build_logs/fastlane_attempt_${RETRY_COUNT}.log" build_logs/fastlane.log 2>/dev/null || true

          if [ "$SUCCESS" = "false" ]; then
            echo ""
            echo "====================================="
            echo "  FAILED after $MAX_RETRIES attempts"
            echo "====================================="
            exit 1
          fi
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          KEYCHAIN_PATH: ${{ env.KEYCHAIN_PATH }}
          KEYCHAIN_PASSWORD: ${{ env.KEYCHAIN_PASSWORD }}
          FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 180

      - name: "Show Errors"
        if: failure()
        run: |
          echo "=== Fastlane Errors ==="
          if [ -f build_logs/fastlane.log ]; then
            grep -E "error:|Error:|FAILED|fatal" build_logs/fastlane.log | head -30 || true
            echo ""
            echo "=== Signing Issues ==="
            grep -E "signing|certificate|provision|codesign" build_logs/fastlane.log | head -20 || true
          else
            echo "No fastlane log found"
          fi

      - name: "Cleanup Keychain"
        if: always()
        run: |
          if [ -n "${{ env.KEYCHAIN_PATH }}" ]; then
            security delete-keychain "${{ env.KEYCHAIN_PATH }}" 2>/dev/null || true
          fi

      - name: "Upload Build Logs"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: testflight-logs-${{ github.run_number }}
          path: build_logs/
          retention-days: 14

      - name: "Success Summary"
        if: success()
        run: |
          echo "## TestFlight Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build Number | ${{ env.BUILD_NUMBER }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Type | ${{ github.event.inputs.build_type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The build has been uploaded to App Store Connect." >> $GITHUB_STEP_SUMMARY
          echo "Check TestFlight for processing status." >> $GITHUB_STEP_SUMMARY
