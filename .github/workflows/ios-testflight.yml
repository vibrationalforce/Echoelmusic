# =============================================================================
# ECHOELMUSIC - iOS TESTFLIGHT (Quick Deploy)
# =============================================================================
# PR Build Check + Manual TestFlight Deploy
# =============================================================================

name: "ðŸ“± iOS TestFlight"

on:
  pull_request:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'testflight'
        type: choice
        options:
          - testflight
          - build-only

concurrency:
  group: ios-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # PR Build Check (Runs on ALL PRs - No Secrets Required)
  # ==========================================================================
  pr-build-check:
    name: "ðŸ” PR Build Check"
    runs-on: macos-14
    if: github.event_name == 'pull_request'

    steps:
      - name: "ðŸ“¥ Checkout"
        uses: actions/checkout@v4

      - name: "â„¹ï¸ Show PR Info"
        run: |
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "Base: ${{ github.base_ref }}"
          echo "Head: ${{ github.head_ref }}"
          echo "Event: ${{ github.event_name }}"

      - name: "ðŸ”§ Setup Xcode 15.4"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: "ðŸ“¦ Install XcodeGen"
        run: |
          curl -sL https://github.com/yonaskolb/XcodeGen/releases/download/2.38.0/xcodegen.zip -o xcodegen.zip
          unzip -o xcodegen.zip
          sudo mv xcodegen/bin/xcodegen /usr/local/bin/
          xcodegen --version

      - name: "ðŸ’¾ Cache Swift Packages"
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftpm
            .build
          key: ${{ runner.os }}-swift-${{ hashFiles('Package.swift') }}

      - name: "âš™ï¸ Generate Xcode Project"
        run: |
          sed -i '' 's/DEVELOPMENT_TEAM: ""/DEVELOPMENT_TEAM: "XXXXXXXXXX"/' project.yml || true
          xcodegen generate --spec project.yml
          ls -la *.xcodeproj || echo "No project generated"

      - name: "ðŸ”¨ Build iOS (Simulator)"
        run: |
          xcodebuild build \
            -project Echoelmusic.xcodeproj \
            -scheme Echoelmusic \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee build.log | tail -100

          BUILD_RESULT=${PIPESTATUS[0]}
          if [ $BUILD_RESULT -eq 0 ]; then
            echo "âœ… Build successful!"
          else
            echo "âŒ Build failed!"
            echo "=== Errors ==="
            grep -E "error:" build.log | head -30
            exit 1
          fi

      - name: "ðŸ“‹ Upload Build Log"
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pr-build-log
          path: build.log
          retention-days: 3

  # ==========================================================================
  # TestFlight Deploy (Manual Only)
  # ==========================================================================
  ios-testflight:
    name: "ðŸ“± Build & Deploy iOS"
    runs-on: macos-14
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: "ðŸ“¥ Checkout"
        uses: actions/checkout@v4

      - name: "ðŸ” Verify Secrets"
        run: |
          MISSING=false
          [ -z "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" ] && echo "âŒ APP_STORE_CONNECT_KEY_ID" && MISSING=true
          [ -z "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}" ] && echo "âŒ APP_STORE_CONNECT_ISSUER_ID" && MISSING=true
          [ -z "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" ] && echo "âŒ APP_STORE_CONNECT_PRIVATE_KEY" && MISSING=true
          [ -z "${{ secrets.APPLE_TEAM_ID }}" ] && echo "âŒ APPLE_TEAM_ID" && MISSING=true
          [ "$MISSING" = true ] && exit 1
          echo "âœ… All secrets OK"

      - name: "ðŸ”§ Setup Xcode 15.4"
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: "ðŸ“¦ Install Tools"
        run: |
          curl -sL https://github.com/yonaskolb/XcodeGen/releases/download/2.38.0/xcodegen.zip -o xcodegen.zip
          unzip -o xcodegen.zip
          sudo mv xcodegen/bin/xcodegen /usr/local/bin/
          gem install fastlane -N

      - name: "âš™ï¸ Generate Project"
        run: |
          sed -i '' "s/DEVELOPMENT_TEAM: \"\"/DEVELOPMENT_TEAM: \"${{ secrets.APPLE_TEAM_ID }}\"/" project.yml
          xcodegen generate --spec project.yml

      - name: "ðŸ”‘ Setup Keychain"
        run: |
          KEYCHAIN_NAME="ci_signing.keychain-db"
          KEYCHAIN_PASSWORD="ci_$RANDOM"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security list-keychains -d user -s "$KEYCHAIN_NAME" $(security list-keychains -d user | tr -d '"')
          security default-keychain -s "$KEYCHAIN_NAME"
          echo "KEYCHAIN_PATH=$HOME/Library/Keychains/$KEYCHAIN_NAME" >> $GITHUB_ENV
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

      - name: "ðŸ”¨ Build & Upload"
        run: |
          mkdir -p build_logs
          if [ "${{ github.event.inputs.build_type }}" == "testflight" ]; then
            fastlane ios beta 2>&1 | tee build_logs/fastlane.log
          else
            fastlane ios build_only 2>&1 | tee build_logs/fastlane.log
          fi
        env:
          ASC_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          KEYCHAIN_PATH: ${{ env.KEYCHAIN_PATH }}
          KEYCHAIN_PASSWORD: ${{ env.KEYCHAIN_PASSWORD }}

      - name: "ðŸ“‹ Show Errors"
        if: failure()
        run: |
          grep -E "error:|fatal" build_logs/fastlane.log | head -50 || true

      - name: "ðŸ“¦ Upload Logs"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build_logs/
          retention-days: 7
