# Quick test workflow to verify Apple secrets are configured correctly
name: Test Secrets

on:
  workflow_dispatch:

jobs:
  test-secrets:
    name: Verify Apple Secrets
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Check Secrets Configuration
        env:
          HAS_ISSUER: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID != '' }}
          HAS_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID != '' }}
          HAS_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY != '' }}
          HAS_TEAM_ID: ${{ secrets.APPLE_TEAM_ID != '' }}
        run: |
          echo "========================================="
          echo "    SECRETS CONFIGURATION CHECK"
          echo "========================================="
          echo ""

          PASS=true

          if [ "$HAS_ISSUER" == "true" ]; then
            echo "‚úÖ APP_STORE_CONNECT_ISSUER_ID: Configured"
          else
            echo "‚ùå APP_STORE_CONNECT_ISSUER_ID: MISSING"
            PASS=false
          fi

          if [ "$HAS_KEY_ID" == "true" ]; then
            echo "‚úÖ APP_STORE_CONNECT_KEY_ID: Configured"
          else
            echo "‚ùå APP_STORE_CONNECT_KEY_ID: MISSING"
            PASS=false
          fi

          if [ "$HAS_PRIVATE_KEY" == "true" ]; then
            echo "‚úÖ APP_STORE_CONNECT_PRIVATE_KEY: Configured"
          else
            echo "‚ùå APP_STORE_CONNECT_PRIVATE_KEY: MISSING"
            PASS=false
          fi

          if [ "$HAS_TEAM_ID" == "true" ]; then
            echo "‚úÖ APPLE_TEAM_ID: Configured"
          else
            echo "‚ùå APPLE_TEAM_ID: MISSING"
            PASS=false
          fi

          echo ""
          echo "========================================="

          if [ "$PASS" == "true" ]; then
            echo "üéâ ALL SECRETS CONFIGURED!"
            echo "You can now run the Deploy workflow."
          else
            echo "‚ö†Ô∏è SOME SECRETS MISSING"
            echo "Go to: Settings ‚Üí Environments ‚Üí production ‚Üí Add secret"
          fi

          echo "========================================="

      - name: Validate Private Key Format
        if: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY != '' }}
        env:
          ASC_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
        run: |
          echo ""
          echo "========================================="
          echo "    PRIVATE KEY VALIDATION"
          echo "========================================="
          echo ""

          # Try to detect format
          if echo "$ASC_KEY" | base64 -d 2>/dev/null | grep -q "BEGIN PRIVATE KEY"; then
            echo "‚úÖ Key format: Base64 encoded"
            echo "‚úÖ Key contains valid PRIVATE KEY header"
          elif echo "$ASC_KEY" | grep -q "BEGIN PRIVATE KEY"; then
            echo "‚úÖ Key format: Raw PEM"
            echo "‚úÖ Key contains valid PRIVATE KEY header"
          else
            echo "‚ö†Ô∏è Key format: Unknown"
            echo "   First 50 chars: $(echo "$ASC_KEY" | head -c 50)..."
            echo ""
            echo "   Expected format:"
            echo "   -----BEGIN PRIVATE KEY-----"
            echo "   MIGTAgEAMBMGByqGSM49AgEGCCqGSM49AwEH..."
            echo "   -----END PRIVATE KEY-----"
          fi

          echo ""
          echo "========================================="

      - name: Show Key ID and Issuer Format
        env:
          KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          echo ""
          echo "========================================="
          echo "    ID FORMAT CHECK"
          echo "========================================="
          echo ""

          # Key ID should be ~10 chars
          KEY_LEN=${#KEY_ID}
          if [ $KEY_LEN -ge 8 ] && [ $KEY_LEN -le 12 ]; then
            echo "‚úÖ KEY_ID length: $KEY_LEN chars (OK)"
          else
            echo "‚ö†Ô∏è KEY_ID length: $KEY_LEN chars (expected 10)"
          fi

          # Issuer ID should be UUID format (~36 chars)
          ISSUER_LEN=${#ISSUER_ID}
          if [ $ISSUER_LEN -ge 30 ]; then
            echo "‚úÖ ISSUER_ID length: $ISSUER_LEN chars (OK - UUID format)"
          else
            echo "‚ö†Ô∏è ISSUER_ID length: $ISSUER_LEN chars (expected ~36 UUID)"
          fi

          # Team ID should be 10 chars
          TEAM_LEN=${#TEAM_ID}
          if [ $TEAM_LEN -eq 10 ]; then
            echo "‚úÖ TEAM_ID length: $TEAM_LEN chars (OK)"
          else
            echo "‚ö†Ô∏è TEAM_ID length: $TEAM_LEN chars (expected 10)"
          fi

          echo ""
          echo "========================================="
          echo "    TEST COMPLETE"
          echo "========================================="
