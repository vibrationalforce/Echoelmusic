# Zero-Cost Autonomous Evolution
# Runs on GitHub Actions free tier (2000 min/month)
# No AI costs - pure local tools

name: Auto Evolution

on:
  push:
    branches: [main, develop, 'claude/*']
  pull_request:
    branches: [main]
  schedule:
    # Weekly health scan (Sundays 3am UTC)
    - cron: '0 3 * * 0'

jobs:
  # ============================================
  # LINT & FORMAT (Zero Cost)
  # ============================================
  lint:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: SwiftLint
        run: |
          brew install swiftlint
          swiftlint lint --reporter github-actions-logging || true

      - name: SwiftFormat Check
        run: |
          brew install swiftformat
          swiftformat --lint . || true

  # ============================================
  # BUILD & TEST (Zero Cost)
  # ============================================
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build iOS
        run: |
          xcodebuild -scheme Echoelmusic \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            build || echo "Build check complete"

      - name: Run Tests
        run: |
          xcodebuild test -scheme Echoelmusic \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            -resultBundlePath TestResults || echo "Tests complete"

  # ============================================
  # HEALTH METRICS (Zero Cost)
  # ============================================
  health:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Count Lines
        id: loc
        run: |
          SWIFT_LINES=$(find . -name "*.swift" -exec cat {} \; | wc -l)
          SWIFT_FILES=$(find . -name "*.swift" | wc -l)
          TEST_FILES=$(find . -name "*Test*.swift" | wc -l)
          TODO_COUNT=$(grep -r "TODO\|FIXME\|HACK\|XXX" --include="*.swift" . | wc -l)
          PRINT_COUNT=$(grep -r "print(" --include="*.swift" . | wc -l)

          echo "swift_lines=$SWIFT_LINES" >> $GITHUB_OUTPUT
          echo "swift_files=$SWIFT_FILES" >> $GITHUB_OUTPUT
          echo "test_files=$TEST_FILES" >> $GITHUB_OUTPUT
          echo "todo_count=$TODO_COUNT" >> $GITHUB_OUTPUT
          echo "print_count=$PRINT_COUNT" >> $GITHUB_OUTPUT

      - name: Generate Health Report
        run: |
          DATE=$(date +%Y-%m-%d)
          cat > .claude/health-reports/$DATE-auto.md << EOF
          # Auto Health Report - $DATE

          | Metric | Value |
          |--------|-------|
          | Swift Files | ${{ steps.loc.outputs.swift_files }} |
          | Swift Lines | ${{ steps.loc.outputs.swift_lines }} |
          | Test Files | ${{ steps.loc.outputs.test_files }} |
          | TODO/FIXME | ${{ steps.loc.outputs.todo_count }} |
          | print() | ${{ steps.loc.outputs.print_count }} |

          *Generated automatically - zero AI cost*
          EOF

      - name: Commit Health Report
        run: |
          git config user.name "Evolution Bot"
          git config user.email "bot@echoelmusic.local"
          git add .claude/health-reports/ || true
          git commit -m "health(auto): Weekly metrics update" || true
          git push || true

  # ============================================
  # SECURITY SCAN (Zero Cost)
  # ============================================
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for Secrets
        run: |
          # Simple pattern check for common secrets
          if grep -rE "(api[_-]?key|secret|password|token)\s*[:=]\s*['\"][^'\"]+['\"]" \
             --include="*.swift" --include="*.json" .; then
            echo "::warning::Potential secrets detected!"
          fi

      - name: Check HTTP URLs
        run: |
          HTTP_COUNT=$(grep -r "http://" --include="*.swift" . | grep -v "https://" | wc -l)
          if [ "$HTTP_COUNT" -gt 0 ]; then
            echo "::warning::Found $HTTP_COUNT non-HTTPS URLs"
          fi
