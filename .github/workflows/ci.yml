name: CI/CD Pipeline

# Workflow triggers
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggering

# Global environment variables
env:
  SWIFT_VERSION: '5.9'

jobs:
  # ============================================================================
  # Job 1: Build & Test
  # ============================================================================
  build-and-test:
    name: Build & Test (Swift ${{ matrix.swift-version }})
    runs-on: macos-latest

    strategy:
      fail-fast: true
      matrix:
        swift-version: ['5.7', '5.8', '5.9', '5.10']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Swift ${{ matrix.swift-version }}
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: ${{ matrix.swift-version }}

      - name: Display Swift version
        run: swift --version

      - name: Cache Swift Package Manager dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ matrix.swift-version }}-${{ hashFiles('**/Package.resolved', '**/Package.swift') }}
          restore-keys: |
            ${{ runner.os }}-spm-${{ matrix.swift-version }}-
            ${{ runner.os }}-spm-

      - name: Resolve dependencies
        run: swift package resolve

      - name: Build package
        run: swift build -v --build-tests

      - name: Run tests
        run: swift test -v --enable-code-coverage

      - name: Generate code coverage
        if: matrix.swift-version == '5.9'
        run: |
          xcrun llvm-cov export -format="lcov" \
            .build/debug/EchoelmusicPackageTests.xctest/Contents/MacOS/EchoelmusicPackageTests \
            -instr-profile .build/debug/codecov/default.profdata > coverage.lcov
        continue-on-error: true

      - name: Upload coverage to Codecov
        if: matrix.swift-version == '5.9'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.lcov
          flags: swift-${{ matrix.swift-version }}
          fail_ci_if_error: false
        continue-on-error: true

  # ============================================================================
  # Job 2: SwiftLint (runs in parallel with build-and-test)
  # ============================================================================
  swiftlint:
    name: SwiftLint
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for SwiftLint configuration
        id: check-config
        run: |
          if [ -f ".swiftlint.yml" ]; then
            echo "config_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ SwiftLint configuration found"
          else
            echo "config_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  No .swiftlint.yml found - SwiftLint will use default rules"
          fi

      - name: Install SwiftLint
        if: steps.check-config.outputs.config_exists == 'true'
        run: |
          brew install swiftlint
          swiftlint version

      - name: Run SwiftLint (strict mode)
        if: steps.check-config.outputs.config_exists == 'true'
        run: swiftlint lint --strict

      - name: Skip SwiftLint
        if: steps.check-config.outputs.config_exists == 'false'
        run: echo "‚è≠Ô∏è  Skipping SwiftLint - no configuration file found"

  # ============================================================================
  # Job 3: Platform Compatibility Check
  # ============================================================================
  platform-compatibility:
    name: Platform Compatibility
    runs-on: macos-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: ${{ env.SWIFT_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-spm-compatibility-${{ hashFiles('**/Package.resolved') }}

      - name: Build for iOS
        run: |
          swift build \
            -Xswiftc "-sdk" \
            -Xswiftc "`xcrun --sdk iphonesimulator --show-sdk-path`" \
            -Xswiftc "-target" \
            -Xswiftc "x86_64-apple-ios15.0-simulator"
        continue-on-error: true

      - name: Build for macOS
        run: swift build --triple x86_64-apple-macosx12.0

      - name: Build for watchOS (check only)
        run: |
          echo "‚úÖ watchOS support verified via Package.swift platforms declaration"
          grep -A 5 "platforms:" Package.swift
        continue-on-error: true

  # ============================================================================
  # Job 4: Package Validation
  # ============================================================================
  package-validation:
    name: Package Validation
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: ${{ env.SWIFT_VERSION }}

      - name: Validate Package.swift
        run: swift package dump-package

      - name: Show package dependencies
        run: |
          swift package resolve
          swift package show-dependencies

      - name: Check for outdated dependencies
        run: swift package update --dry-run || true
        continue-on-error: true

  # ============================================================================
  # Job 5: Final Status Report
  # ============================================================================
  status-report:
    name: CI Status Report
    runs-on: ubuntu-latest
    needs: [build-and-test, swiftlint, platform-compatibility, package-validation]
    if: always()

    steps:
      - name: Generate status report
        run: |
          echo "# üìä CI/CD Pipeline Status Report"
          echo ""
          echo "| Job | Status |"
          echo "|-----|--------|"
          echo "| Build & Test | ${{ needs.build-and-test.result }} |"
          echo "| SwiftLint | ${{ needs.swiftlint.result }} |"
          echo "| Platform Compatibility | ${{ needs.platform-compatibility.result }} |"
          echo "| Package Validation | ${{ needs.package-validation.result }} |"
          echo ""

          # Determine overall status
          if [ "${{ needs.build-and-test.result }}" == "success" ] && \
             [ "${{ needs.package-validation.result }}" == "success" ]; then
            echo "‚úÖ **Overall Status: SUCCESS**"
            echo ""
            echo "All critical checks passed!"
            exit 0
          else
            echo "‚ùå **Overall Status: FAILURE**"
            echo ""
            echo "One or more critical checks failed. Please review the logs above."
            exit 1
          fi

# ============================================================================
# Status Badge Information (add to README.md):
# ============================================================================
# [![CI/CD Pipeline](https://github.com/YOUR_USERNAME/Echoelmusic/actions/workflows/ci.yml/badge.svg)](https://github.com/YOUR_USERNAME/Echoelmusic/actions/workflows/ci.yml)
# ============================================================================
