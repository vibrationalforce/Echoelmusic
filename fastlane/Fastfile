# =============================================================================
# ECHOELMUSIC - MULTI-PLATFORM FASTLANE CONFIGURATION
# =============================================================================
# Version: 3.0.0 - Phase 10000 ULTIMATE MODE
#
# Supported Platforms:
# - iOS (iPhone + iPad) with AUv3
# - macOS (Apple Silicon + Intel) with AUv3
# - watchOS (Apple Watch)
# - tvOS (Apple TV)
# - visionOS (Apple Vision Pro)
#
# Usage:
#   fastlane ios beta              # Upload iOS to TestFlight
#   fastlane mac beta              # Upload macOS to TestFlight
#   fastlane ios beta_watchos      # Upload watchOS to TestFlight
#   fastlane ios beta_tvos         # Upload tvOS to TestFlight
#   fastlane ios beta_visionos     # Upload visionOS to TestFlight
#   fastlane ios beta_all          # Upload ALL platforms to TestFlight
# =============================================================================

default_platform(:ios)

# Shared configuration
TEAM_ID = ENV["APPLE_TEAM_ID"]
BUILD_NUMBER = ENV["BUILD_NUMBER"] || "1"

# =============================================================================
# SHARED HELPERS
# =============================================================================

def setup_api_key
  UI.user_error!("ASC_KEY_ID not set") unless ENV["ASC_KEY_ID"]
  UI.user_error!("ASC_ISSUER_ID not set") unless ENV["ASC_ISSUER_ID"]
  UI.user_error!("ASC_KEY_CONTENT not set") unless ENV["ASC_KEY_CONTENT"]
  UI.user_error!("APPLE_TEAM_ID not set") unless ENV["APPLE_TEAM_ID"]

  app_store_connect_api_key(
    key_id: ENV["ASC_KEY_ID"],
    issuer_id: ENV["ASC_ISSUER_ID"],
    key_content: ENV["ASC_KEY_CONTENT"],
    is_key_content_base64: false,
    in_house: false
  )
end

def setup_keychain
  keychain_path = ENV["KEYCHAIN_PATH"] || "~/Library/Keychains/login.keychain-db"
  keychain_password = ENV["KEYCHAIN_PASSWORD"] || ""
  UI.message("Using keychain: #{keychain_path}")
  { path: keychain_path, password: keychain_password }
end

def cleanup_certificates(api_key)
  UI.message("Checking Distribution certificates...")
  begin
    require 'spaceship'
    Spaceship::ConnectAPI.token = Spaceship::ConnectAPI::Token.create(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key: ENV["ASC_KEY_CONTENT"]
    )

    all_certs = Spaceship::ConnectAPI::Certificate.all.select do |cert|
      cert.certificate_type == "DISTRIBUTION" || cert.certificate_type == "IOS_DISTRIBUTION"
    end

    UI.message("Found #{all_certs.count} distribution certificate(s)")

    if all_certs.count > 2
      sorted = all_certs.sort_by { |c| c.expiration_date }.reverse
      to_revoke = sorted[2..-1]
      to_revoke.each do |cert|
        UI.message("Revoking old certificate: #{cert.id}")
        cert.delete!
      end
      UI.success("Cleaned up #{to_revoke.count} old certificate(s)")
    end
  rescue => e
    UI.important("Certificate check skipped: #{e.message}")
  end
end

def upload_to_testflight_with_retry(api_key, changelog)
  UI.message("Uploading to TestFlight...")
  upload_to_testflight(
    api_key: api_key,
    skip_waiting_for_build_processing: true,
    distribute_external: false,
    notify_external_testers: false,
    changelog: changelog,
    reject_build_waiting_for_review: false
  )
  UI.success("Successfully uploaded to TestFlight!")
end

# =============================================================================
# iOS PLATFORM
# =============================================================================

platform :ios do

  # ---------------------------------------------------------------------------
  # iOS App (with AUv3 Audio Unit Extension)
  # ---------------------------------------------------------------------------
  desc "Build and upload iOS app to TestFlight"
  lane :beta do
    UI.header "iOS TestFlight Build (with AUv3 Extension)"

    api_key = setup_api_key
    keychain = setup_keychain
    cleanup_certificates(api_key)

    # Get certificates
    get_certificates(
      api_key: api_key,
      platform: "ios",
      keychain_path: keychain[:path],
      keychain_password: keychain[:password]
    )

    # Main app profile
    get_provisioning_profile(
      api_key: api_key,
      app_identifier: "com.echoelmusic.app",
      platform: "ios",
      force: ENV["CLEAN_BUILD"] == "true"
    )
    app_profile = lane_context[SharedValues::SIGH_NAME]
    UI.message("iOS App profile: #{app_profile}")

    # AUv3 Extension profile
    get_provisioning_profile(
      api_key: api_key,
      app_identifier: "com.echoelmusic.app.auv3",
      platform: "ios",
      force: ENV["CLEAN_BUILD"] == "true"
    )
    auv3_profile = lane_context[SharedValues::SIGH_NAME]
    UI.message("iOS AUv3 profile: #{auv3_profile}")

    # Build with proper signing for app + AUv3 extension
    build_app(
      project: "Echoelmusic.xcodeproj",
      scheme: "Echoelmusic",
      configuration: "Release",
      clean: ENV["CLEAN_BUILD"] == "true",
      export_method: "app-store",
      codesigning_identity: "Apple Distribution",
      derived_data_path: "./build/DerivedData",
      export_options: {
        provisioningProfiles: {
          "com.echoelmusic.app" => app_profile,
          "com.echoelmusic.app.auv3" => auv3_profile
        }
      },
      xcargs: [
        "DEVELOPMENT_TEAM='#{TEAM_ID}'",
        "CODE_SIGN_STYLE='Manual'",
        "COMPILER_INDEX_STORE_ENABLE=NO"
      ].join(" ")
    )

    upload_to_testflight_with_retry(api_key, "iOS Build #{BUILD_NUMBER} - Phase 10000 ULTIMATE MODE")
  end

  # ---------------------------------------------------------------------------
  # watchOS App
  # ---------------------------------------------------------------------------
  desc "Build and upload watchOS app to TestFlight"
  lane :beta_watchos do
    UI.header "watchOS TestFlight Build"

    api_key = setup_api_key
    keychain = setup_keychain
    cleanup_certificates(api_key)

    get_certificates(
      api_key: api_key,
      platform: "ios",
      keychain_path: keychain[:path],
      keychain_password: keychain[:password]
    )

    # Companion iOS app profile (required for watchOS)
    get_provisioning_profile(
      api_key: api_key,
      app_identifier: "com.echoelmusic.app",
      platform: "ios",
      force: ENV["CLEAN_BUILD"] == "true"
    )
    ios_profile = lane_context[SharedValues::SIGH_NAME]

    # watchOS app profile
    get_provisioning_profile(
      api_key: api_key,
      app_identifier: "com.echoelmusic.app.watchkitapp",
      platform: "ios",
      force: ENV["CLEAN_BUILD"] == "true"
    )
    watch_profile = lane_context[SharedValues::SIGH_NAME]

    build_app(
      project: "Echoelmusic.xcodeproj",
      scheme: "Echoelmusic-watchOS",
      configuration: "Release",
      clean: ENV["CLEAN_BUILD"] == "true",
      export_method: "app-store",
      codesigning_identity: "Apple Distribution",
      derived_data_path: "./build/DerivedData",
      export_options: {
        provisioningProfiles: {
          "com.echoelmusic.app" => ios_profile,
          "com.echoelmusic.app.watchkitapp" => watch_profile
        }
      },
      xcargs: [
        "DEVELOPMENT_TEAM='#{TEAM_ID}'",
        "CODE_SIGN_STYLE='Manual'",
        "COMPILER_INDEX_STORE_ENABLE=NO"
      ].join(" ")
    )

    upload_to_testflight_with_retry(api_key, "watchOS Build #{BUILD_NUMBER} - Bio-Reactive HRV")
  end

  # ---------------------------------------------------------------------------
  # tvOS App
  # ---------------------------------------------------------------------------
  desc "Build and upload tvOS app to TestFlight"
  lane :beta_tvos do
    UI.header "tvOS TestFlight Build"

    api_key = setup_api_key
    keychain = setup_keychain
    cleanup_certificates(api_key)

    get_certificates(
      api_key: api_key,
      platform: "ios",
      keychain_path: keychain[:path],
      keychain_password: keychain[:password]
    )

    # Unified bundle ID for tvOS (enables universal purchase)
    get_provisioning_profile(
      api_key: api_key,
      app_identifier: "com.echoelmusic.app",
      platform: "tvos",
      force: ENV["CLEAN_BUILD"] == "true"
    )
    profile = lane_context[SharedValues::SIGH_NAME]

    build_app(
      project: "Echoelmusic.xcodeproj",
      scheme: "Echoelmusic-tvOS",
      configuration: "Release",
      clean: ENV["CLEAN_BUILD"] == "true",
      export_method: "app-store",
      codesigning_identity: "Apple Distribution",
      derived_data_path: "./build/DerivedData",
      export_options: {
        provisioningProfiles: {
          "com.echoelmusic.app" => profile
        }
      },
      xcargs: [
        "DEVELOPMENT_TEAM='#{TEAM_ID}'",
        "CODE_SIGN_STYLE='Manual'",
        "COMPILER_INDEX_STORE_ENABLE=NO"
      ].join(" ")
    )

    upload_to_testflight_with_retry(api_key, "tvOS Build #{BUILD_NUMBER} - Big Screen Experience")
  end

  # ---------------------------------------------------------------------------
  # visionOS App
  # ---------------------------------------------------------------------------
  desc "Build and upload visionOS app to TestFlight"
  lane :beta_visionos do
    UI.header "visionOS TestFlight Build"

    api_key = setup_api_key
    keychain = setup_keychain
    cleanup_certificates(api_key)

    get_certificates(
      api_key: api_key,
      platform: "ios",
      keychain_path: keychain[:path],
      keychain_password: keychain[:password]
    )

    # Unified bundle ID for visionOS (enables universal purchase)
    # Note: visionOS uses "ios" platform for provisioning profiles in Fastlane
    # as of 2024 - this is correct behavior until Fastlane adds native visionOS support
    get_provisioning_profile(
      api_key: api_key,
      app_identifier: "com.echoelmusic.app",
      platform: "ios",  # visionOS profiles use iOS platform in sigh/match
      force: ENV["CLEAN_BUILD"] == "true"
    )
    profile = lane_context[SharedValues::SIGH_NAME]

    build_app(
      project: "Echoelmusic.xcodeproj",
      scheme: "Echoelmusic-visionOS",
      configuration: "Release",
      clean: ENV["CLEAN_BUILD"] == "true",
      export_method: "app-store",
      codesigning_identity: "Apple Distribution",
      derived_data_path: "./build/DerivedData",
      destination: "generic/platform=visionOS",
      export_options: {
        provisioningProfiles: {
          "com.echoelmusic.app" => profile
        }
      },
      xcargs: [
        "DEVELOPMENT_TEAM='#{TEAM_ID}'",
        "CODE_SIGN_STYLE='Manual'",
        "COMPILER_INDEX_STORE_ENABLE=NO"
      ].join(" ")
    )

    upload_to_testflight_with_retry(api_key, "visionOS Build #{BUILD_NUMBER} - Spatial Audio Immersive")
  end

  # ---------------------------------------------------------------------------
  # Build Only (No Upload)
  # ---------------------------------------------------------------------------
  desc "Just build without signing (for CI testing)"
  lane :build_only do
    UI.header "Building iOS for simulator (no signing)"
    build_app(
      project: "Echoelmusic.xcodeproj",
      scheme: "Echoelmusic",
      configuration: "Release",
      clean: false,
      skip_codesigning: true,
      skip_archive: true,
      destination: "generic/platform=iOS Simulator",
      derived_data_path: "./build/DerivedData"
    )
  end

  # ---------------------------------------------------------------------------
  # All iOS Platforms
  # ---------------------------------------------------------------------------
  desc "Build and upload ALL iOS platforms to TestFlight"
  lane :beta_all_ios do
    UI.header "Building ALL iOS Platforms for TestFlight"

    beta
    beta_watchos
    beta_tvos
    beta_visionos

    UI.success("All iOS platforms uploaded to TestFlight!")
  end

  # ---------------------------------------------------------------------------
  # Tests
  # ---------------------------------------------------------------------------
  desc "Run iOS tests"
  lane :test do
    UI.header "Running iOS tests"
    run_tests(
      project: "Echoelmusic.xcodeproj",
      scheme: "Echoelmusic",
      device: "iPhone 15 Pro",
      clean: false,
      derived_data_path: "./build/DerivedData"
    )
  end

  # ---------------------------------------------------------------------------
  # Screenshots
  # ---------------------------------------------------------------------------
  desc "Capture screenshots for all devices and languages"
  lane :screenshots do
    UI.header "Capturing App Store Screenshots"
    capture_screenshots(
      scheme: "EchoelmusicScreenshots",
      output_directory: "./fastlane/screenshots",
      clear_previous_screenshots: true,
      concurrent_simulators: true,
      languages: ["en-US", "de-DE", "ja", "es-ES", "fr-FR", "zh-Hans", "ko", "pt-BR", "it", "ru", "ar", "hi"],
      devices: ["iPhone 16 Pro Max", "iPhone 16 Pro", "iPhone SE (3rd generation)", "iPad Pro 13-inch (M4)", "iPad Pro 11-inch (M4)"],
      dark_mode: false,
      override_status_bar: true,
      derived_data_path: "./build/DerivedData"
    )
    UI.success("Screenshots captured!")
  end

  desc "Upload screenshots to App Store Connect"
  lane :upload_screenshots do
    UI.header "Uploading Screenshots"
    api_key = setup_api_key
    deliver(
      api_key: api_key,
      skip_binary_upload: true,
      skip_metadata: true,
      skip_app_version_update: true,
      screenshots_path: "./fastlane/screenshots",
      overwrite_screenshots: true,
      force: true
    )
    UI.success("Screenshots uploaded!")
  end
end

# =============================================================================
# macOS PLATFORM
# =============================================================================

platform :mac do

  # ---------------------------------------------------------------------------
  # macOS App (with AUv3 Audio Unit Extension)
  # ---------------------------------------------------------------------------
  desc "Build and upload macOS app to TestFlight"
  lane :beta do
    UI.header "macOS TestFlight Build (with AUv3 Extension)"

    api_key = setup_api_key
    keychain = setup_keychain
    cleanup_certificates(api_key)

    # macOS uses different certificate type
    get_certificates(
      api_key: api_key,
      platform: "macos",
      keychain_path: keychain[:path],
      keychain_password: keychain[:password]
    )

    # Main app profile
    get_provisioning_profile(
      api_key: api_key,
      app_identifier: "com.echoelmusic.app",
      platform: "macos",
      force: ENV["CLEAN_BUILD"] == "true"
    )
    app_profile = lane_context[SharedValues::SIGH_NAME]
    UI.message("macOS App profile: #{app_profile}")

    # AUv3 Extension profile (REQUIRED for embedded extensions)
    get_provisioning_profile(
      api_key: api_key,
      app_identifier: "com.echoelmusic.app.auv3",
      platform: "macos",
      force: ENV["CLEAN_BUILD"] == "true"
    )
    auv3_profile = lane_context[SharedValues::SIGH_NAME]
    UI.message("macOS AUv3 profile: #{auv3_profile}")

    # Build with proper signing for app + AUv3 extension
    build_app(
      project: "Echoelmusic.xcodeproj",
      scheme: "Echoelmusic-macOS",
      configuration: "Release",
      clean: ENV["CLEAN_BUILD"] == "true",
      export_method: "app-store",
      codesigning_identity: "Apple Distribution",
      derived_data_path: "./build/DerivedData",
      export_options: {
        provisioningProfiles: {
          "com.echoelmusic.app" => app_profile,
          "com.echoelmusic.app.auv3" => auv3_profile
        }
      },
      xcargs: [
        "DEVELOPMENT_TEAM='#{TEAM_ID}'",
        "CODE_SIGN_STYLE='Manual'",
        "COMPILER_INDEX_STORE_ENABLE=NO"
      ].join(" ")
    )

    upload_to_testflight_with_retry(api_key, "macOS Build #{BUILD_NUMBER} - Standalone + AUv3 Plugins")
  end

  # ---------------------------------------------------------------------------
  # Build Only (No Upload)
  # ---------------------------------------------------------------------------
  desc "Just build macOS without signing"
  lane :build_only do
    UI.header "Building macOS (no signing)"
    build_app(
      project: "Echoelmusic.xcodeproj",
      scheme: "Echoelmusic-macOS",
      configuration: "Release",
      clean: false,
      skip_codesigning: true,
      skip_archive: true,
      derived_data_path: "./build/DerivedData"
    )
  end

  # ---------------------------------------------------------------------------
  # Tests
  # ---------------------------------------------------------------------------
  desc "Run macOS tests"
  lane :test do
    UI.header "Running macOS tests"
    run_tests(
      project: "Echoelmusic.xcodeproj",
      scheme: "Echoelmusic-macOS",
      clean: false,
      derived_data_path: "./build/DerivedData"
    )
  end
end

# =============================================================================
# UNIVERSAL LANE - ALL PLATFORMS
# =============================================================================

desc "Build and upload ALL platforms to TestFlight"
lane :beta_all do
  UI.header "Building ALL Platforms for TestFlight"
  UI.message("This will build: iOS, macOS, watchOS, tvOS, visionOS")

  # iOS family
  Fastlane::LaneManager.cruise_lane("ios", "beta")
  Fastlane::LaneManager.cruise_lane("ios", "beta_watchos")
  Fastlane::LaneManager.cruise_lane("ios", "beta_tvos")
  Fastlane::LaneManager.cruise_lane("ios", "beta_visionos")

  # macOS
  Fastlane::LaneManager.cruise_lane("mac", "beta")

  UI.success("")
  UI.success("=" * 60)
  UI.success("  ALL PLATFORMS UPLOADED TO TESTFLIGHT!")
  UI.success("=" * 60)
  UI.success("")
  UI.success("  Unified Bundle ID: com.echoelmusic.app")
  UI.success("  (Universal Purchase enabled across all platforms)")
  UI.success("")
  UI.success("  iOS:      com.echoelmusic.app (standalone + integrated AUv3)")
  UI.success("  macOS:    com.echoelmusic.app (standalone + embedded AUv3)")
  UI.success("  watchOS:  com.echoelmusic.app.watchkitapp")
  UI.success("  tvOS:     com.echoelmusic.app")
  UI.success("  visionOS: com.echoelmusic.app")
  UI.success("")
  UI.success("Check App Store Connect for build processing status.")
  UI.success("=" * 60)
end
