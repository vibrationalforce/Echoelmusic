# =============================================================================
# ECHOELMUSIC - FASTLANE CONFIGURATION (Upload Only)
# =============================================================================
# xcodebuild handles archive + export directly in CI workflow
# Fastlane only handles TestFlight upload with retry logic
# =============================================================================

default_platform(:ios)

TEAM_ID = ENV["APPLE_TEAM_ID"]
BUILD_NUMBER = ENV["BUILD_NUMBER"] || "1"

# =============================================================================
# SHARED HELPERS
# =============================================================================

def setup_api_key
  missing = []
  missing << "ASC_KEY_ID" unless ENV["ASC_KEY_ID"]&.length.to_i > 0
  missing << "ASC_ISSUER_ID" unless ENV["ASC_ISSUER_ID"]&.length.to_i > 0
  missing << "ASC_KEY_CONTENT" unless ENV["ASC_KEY_CONTENT"]&.length.to_i > 0
  missing << "APPLE_TEAM_ID" unless ENV["APPLE_TEAM_ID"]&.length.to_i > 0

  unless missing.empty?
    UI.error("Missing required environment variables: #{missing.join(', ')}")
    UI.user_error!("Cannot proceed without App Store Connect credentials")
  end

  key_content = ENV["ASC_KEY_CONTENT"]
  unless key_content.include?("BEGIN") && key_content.include?("PRIVATE KEY")
    UI.important("Warning: ASC_KEY_CONTENT may not be in correct PEM format")
  end

  app_store_connect_api_key(
    key_id: ENV["ASC_KEY_ID"],
    issuer_id: ENV["ASC_ISSUER_ID"],
    key_content: key_content,
    is_key_content_base64: false,
    in_house: false
  )
end

def upload_to_testflight_with_retry(api_key, changelog, max_retries: 3)
  UI.message("Uploading to TestFlight...")

  retries = 0
  begin
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
      distribute_external: false,
      notify_external_testers: false,
      changelog: changelog,
      reject_build_waiting_for_review: false
    )
    UI.success("Successfully uploaded to TestFlight!")
  rescue => e
    retries += 1
    if retries <= max_retries
      delay = 30 * retries
      UI.important("Upload failed (attempt #{retries}/#{max_retries}): #{e.message}")
      UI.message("Retrying in #{delay} seconds...")
      sleep(delay)
      retry
    else
      UI.error("Upload failed after #{max_retries} attempts")
      raise e
    end
  end
end

# =============================================================================
# iOS PLATFORM
# =============================================================================

platform :ios do

  desc "Upload iOS IPA to TestFlight (archive built by xcodebuild in CI)"
  lane :upload do
    UI.header "iOS TestFlight Upload"
    api_key = setup_api_key

    ipa_path = ENV["IPA_PATH"] || "./build/Echoelmusic.ipa"
    unless File.exist?(ipa_path)
      UI.user_error!("IPA not found at #{ipa_path}!")
    end

    upload_to_testflight_with_retry(api_key, "iOS Build #{BUILD_NUMBER}")
  end

  desc "Upload watchOS to TestFlight"
  lane :upload_watchos do
    UI.header "watchOS TestFlight Upload"
    api_key = setup_api_key
    upload_to_testflight_with_retry(api_key, "watchOS Build #{BUILD_NUMBER}")
  end

  desc "Upload tvOS to TestFlight"
  lane :upload_tvos do
    UI.header "tvOS TestFlight Upload"
    api_key = setup_api_key
    upload_to_testflight_with_retry(api_key, "tvOS Build #{BUILD_NUMBER}")
  end

  desc "Upload visionOS to TestFlight"
  lane :upload_visionos do
    UI.header "visionOS TestFlight Upload"
    api_key = setup_api_key
    upload_to_testflight_with_retry(api_key, "visionOS Build #{BUILD_NUMBER}")
  end

  desc "Just build without signing (for CI testing)"
  lane :build_only do
    UI.header "Building iOS for simulator (no signing)"
    build_app(
      project: "Echoelmusic.xcodeproj",
      scheme: "Echoelmusic",
      configuration: "Release",
      clean: false,
      skip_codesigning: true,
      skip_archive: true,
      destination: "generic/platform=iOS Simulator",
      derived_data_path: "./build/DerivedData"
    )
  end

  desc "Run iOS tests"
  lane :test do
    run_tests(
      project: "Echoelmusic.xcodeproj",
      scheme: "Echoelmusic",
      device: "iPhone 15 Pro",
      clean: false,
      derived_data_path: "./build/DerivedData"
    )
  end
end

# =============================================================================
# macOS PLATFORM
# =============================================================================

platform :mac do

  desc "Upload macOS app to TestFlight"
  lane :upload do
    UI.header "macOS TestFlight Upload"
    api_key = setup_api_key
    upload_to_testflight_with_retry(api_key, "macOS Build #{BUILD_NUMBER}")
  end

  desc "Just build macOS without signing"
  lane :build_only do
    build_app(
      project: "Echoelmusic.xcodeproj",
      scheme: "Echoelmusic-macOS",
      configuration: "Release",
      clean: false,
      skip_codesigning: true,
      skip_archive: true,
      derived_data_path: "./build/DerivedData"
    )
  end

  desc "Run macOS tests"
  lane :test do
    run_tests(
      project: "Echoelmusic.xcodeproj",
      scheme: "Echoelmusic-macOS",
      clean: false,
      derived_data_path: "./build/DerivedData"
    )
  end
end
